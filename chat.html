<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Video Chat</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0f19;color:#fff}
    header{padding:14px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:#0f172a;border-bottom:1px solid rgba(255,255,255,.08)}
    input{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#0b1224;color:#fff;min-width:220px}
    button{padding:10px 12px;border-radius:10px;border:0;background:#22c55e;color:#04110a;font-weight:700;cursor:pointer}
    button.secondary{background:#334155;color:#fff}
    #meet{height:calc(100vh - 62px);width:100%}
    .hint{opacity:.85;font-size:13px}
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800">ðŸ“¹ Video Chat</div>
    <input id="room" placeholder="Nome stanza (es. qdp-giovedi)" />
    <button id="join">Entra</button>
    <button class="secondary" id="copy">Copia link</button>
    <span class="hint">Condividi il link e fate partire la chiamata.</span>
  </header>

  <div id="meet"></div>

  <script src="https://meet.jit.si/external_api.js"></script>
  <script>
    const roomInput = document.getElementById('room');
    const joinBtn = document.getElementById('join');
    const copyBtn = document.getElementById('copy');
    const meetDiv = document.getElementById('meet');

    function sanitizeRoom(s){
      return (s || '').trim().replace(/\s+/g,'-').replace(/[^a-zA-Z0-9-_]/g,'');
    }

    function getRoomFromUrl(){
      const params = new URLSearchParams(location.search);
      return sanitizeRoom(params.get('room'));
    }

    let api = null;

    function joinRoom(room){
      room = sanitizeRoom(room) || 'stanza-' + Math.random().toString(36).slice(2,8);
      const newUrl = location.pathname + '?room=' + encodeURIComponent(room);
      history.replaceState({}, '', newUrl);

      if(api){ api.dispose(); api = null; }
      meetDiv.innerHTML = '';

      api = new JitsiMeetExternalAPI('meet.jit.si', {
        roomName: room,
        parentNode: meetDiv,
        lang: 'it',
        configOverwrite: {
          prejoinPageEnabled: true
        },
        interfaceConfigOverwrite: {
          SHOW_JITSI_WATERMARK: false,
          SHOW_WATERMARK_FOR_GUESTS: false
        }
      });
    }

    joinBtn.onclick = () => joinRoom(roomInput.value);
    copyBtn.onclick = async () => {
      const room = sanitizeRoom(roomInput.value) || getRoomFromUrl();
      const url = location.origin + location.pathname + '?room=' + encodeURIComponent(room || 'stanza');
      try { await navigator.clipboard.writeText(url); alert('Link copiato!'); }
      catch { prompt('Copia il link:', url); }
    };

    const initial = getRoomFromUrl();
    if(initial){
      roomInput.value = initial;
      joinRoom(initial);
    }
  </script>
</body>
</html>
