<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Storico ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eee; --link:#0b5fff; --chipBg:rgba(0,0,0,.04);
      --badgeBg:#111; --badgeText:#fff;
      --detailBg: rgba(0,0,0,.02);
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
      --border:#2a2f3a; --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631; --link:#7aa7ff; --chipBg:rgba(255,255,255,.04);
      --badgeBg:#0b0e14; --badgeText:#fff;
      --detailBg: rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui;margin:0;background:var(--bg);color:var(--text);transition:.2s}
    a{color:var(--link);text-decoration:none}

    .wrap{max-width:860px;margin:0 auto;padding:16px}

    .top{
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;
      flex-wrap:wrap;
    }
    h1{
      font-family:'Bebas Neue',sans-serif;
      letter-spacing:2px;
      margin:10px 0 4px;
      font-size:44px;
      line-height:1;
    }
    .sub{color:var(--muted);font-size:12px}

    .nav{
      display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;
      margin-bottom:6px;
    }

    .toolbar{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      user-select:none;
    }
    .toggle input{transform:scale(1.2)}
    .hint{color:var(--muted);font-size:12px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .meta{min-width:240px}
    .meta .line{margin-top:6px;color:var(--muted);font-size:13px}

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background:var(--badgeBg);
      color:var(--badgeText);
      font-weight:900;
      font-size:16px;
      letter-spacing:.5px;
      white-space:nowrap;
    }
    .badge.muted{
      background:var(--chipBg);
      color:var(--muted);
      border:1px solid var(--border);
      font-weight:800;
    }

    .pill{
      display:inline-block;
      background:var(--pill);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      margin:6px 8px 0 0;
      font-weight:900;
      font-size:12px;
    }

    .listEmpty{
      margin-top:14px;
      color:var(--muted);
    }

    /* Details */
    details{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--detailBg);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      font-weight:900;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    summary::-webkit-details-marker{display:none}
    .chev{opacity:.7}
    details[open] .chev{transform:rotate(180deg)}
    .detailBody{
      padding:12px;
      border-top:1px solid var(--border);
    }
    .sectionTitle{
      font-weight:900;
      margin-top:10px;
    }

    /* Floating theme */
    .fab{
      position:fixed;right:16px;bottom:16px;
      width:54px;height:54px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);color:var(--text);
      font-size:22px;font-weight:900;cursor:pointer;
      box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center;
      z-index:9999;user-select:none;
    }
    .fab:active{transform:scale(.98)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Storico partite</h1>
        <div class="sub">Quelli della pensione</div>
      </div>

      <div class="nav">
        <a href="index.html">‚¨ÖÔ∏è Home</a>
        <a href="admin.html">üîê Admin</a>
      </div>
    </div>

    <div class="toolbar">
      <label class="toggle">
        <input id="onlyFinished" type="checkbox" />
        <span><b>Solo partite con risultato</b></span>
      </label>
      <span class="hint" id="countHint"></span>
    </div>

    <div id="list" class="listEmpty">Caricamento‚Ä¶</div>
  </div>

  <button id="themeToggle" class="fab" title="Tema chiaro/scuro">üåô</button>

  <script>
    // THEME TOGGLE
    const btnTheme = document.getElementById("themeToggle");
    function setTheme(mode){
      document.body.classList.toggle("dark", mode === "dark");
      btnTheme.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("qdp_theme", mode);
    }
    const saved = localStorage.getItem("qdp_theme");
    setTheme(saved === "dark" ? "dark" : "light");
    btnTheme.addEventListener("click", () => setTheme(document.body.classList.contains("dark") ? "light" : "dark"));
  </script>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    const listEl = document.getElementById("list");
    const onlyFinishedEl = document.getElementById("onlyFinished");
    const countHintEl = document.getElementById("countHint");

    if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
      listEl.innerHTML = "<b>Config mancante (config.js)</b>";
      throw new Error("Missing config");
    }

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let ALL = [];
    let ID_TO_NAME = new Map();

    function pill(s){ return `<span class="pill">${s}</span>`; }
    function hasScore(m){ return (m.score_a != null && m.score_b != null); }

    function namesFromIds(ids){
      return (Array.isArray(ids) ? ids : [])
        .map(id => ID_TO_NAME.get(String(id)))
        .filter(Boolean);
    }

    function render(){
      const onlyFinished = onlyFinishedEl.checked;
      const arr = onlyFinished ? ALL.filter(hasScore) : ALL;

      countHintEl.textContent = `Totale: ${arr.length}`;

      if(!arr.length){
        listEl.innerHTML = `<div class="listEmpty">Nessuna partita da mostrare.</div>`;
        return;
      }

      listEl.innerHTML = arr.map(m=>{
        const time = String(m.match_time||"").slice(0,5);
        const badge = hasScore(m)
          ? `<span class="badge">üèÅ ${m.score_a}-${m.score_b}</span>`
          : `<span class="badge muted">Risultato ‚Äî</span>`;

        const called = namesFromIds(m.called_up);
        const teamA  = namesFromIds(m.team_a);
        const teamB  = namesFromIds(m.team_b);

        const hasTeams = teamA.length || teamB.length;

        return `
          <div class="card">
            <div class="row">
              <div class="meta">
                <div><b>${m.match_date}</b> ${time} ‚Ä¢ ${m.venue||""}</div>
                <div class="line"><b>Portieri:</b> ${m.keeper_a||"-"} vs ${m.keeper_b||"-"}</div>
              </div>
              ${badge}
            </div>

            <details>
              <summary>
                <span>Apri dettagli</span>
                <span class="chev">‚ñæ</span>
              </summary>
              <div class="detailBody">
                <div class="sectionTitle">Convocati</div>
                <div>${called.length ? called.map(pill).join("") : "<span class='hint'>‚Äî</span>"}</div>

                <div class="sectionTitle">Formazioni</div>
                ${
                  hasTeams
                    ? `
                      <div class="hint" style="margin-top:6px"><b>Squadra A</b></div>
                      <div>${teamA.length ? teamA.map(pill).join("") : "<span class='hint'>‚Äî</span>"}</div>

                      <div class="hint" style="margin-top:10px"><b>Squadra B</b></div>
                      <div>${teamB.length ? teamB.map(pill).join("") : "<span class='hint'>‚Äî</span>"}</div>
                    `
                    : `<div class="hint" style="margin-top:6px">Formazioni non inserite.</div>`
                }
              </div>
            </details>
          </div>
        `;
      }).join("");
    }

    async function load(){
      listEl.textContent = "Caricamento‚Ä¶";

      const { data: matches, error } = await client
        .from("matches")
        .select("id,match_date,match_time,venue,keeper_a,keeper_b,called_up,score_a,score_b,is_finished,team_a,team_b")
        .order("match_date",{ascending:false})
        .order("match_time",{ascending:false})
        .limit(200);

      if(error){
        listEl.innerHTML = `<b style="color:#ff4d4d">Errore: ${error.message}</b>`;
        return;
      }

      ALL = matches || [];

      // prendo TUTTI gli id: convocati + team_a + team_b
      const allIds = [...new Set(
        ALL.flatMap(m => []
          .concat(Array.isArray(m.called_up) ? m.called_up : [])
          .concat(Array.isArray(m.team_a) ? m.team_a : [])
          .concat(Array.isArray(m.team_b) ? m.team_b : [])
        )
      )];

      ID_TO_NAME = new Map();

      if(allIds.length){
        const { data: players, error: e2 } = await client
          .from("players")
          .select("id,name")
          .in("id", allIds);

        if(!e2){
          (players||[]).forEach(p => ID_TO_NAME.set(String(p.id), p.name));
        }
      }

      render();
    }

    // remember filter
    onlyFinishedEl.checked = (localStorage.getItem("qdp_only_finished") === "1");
    onlyFinishedEl.addEventListener("change", ()=>{
      localStorage.setItem("qdp_only_finished", onlyFinishedEl.checked ? "1" : "0");
      render();
    });

    load();
  </script>
</body>
</html>
