<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Storico ‚Ä¢ Quelli della pensione</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08); --pill:#eee; --link:#0b5fff;
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa; --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45); --pill:#222631; --link:#7aa7ff;
    }
    body{font-family:Inter,system-ui;margin:0;background:var(--bg);color:var(--text);transition:.2s}
    a{color:var(--link);text-decoration:none}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    h1{font-family:'Bebas Neue',sans-serif;letter-spacing:2px;margin:10px 0 6px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);margin:12px 0}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:6px 8px 0 0;font-weight:900}
    .fab{position:fixed;right:16px;bottom:16px;width:54px;height:54px;border-radius:999px;border:1px solid var(--border);
      background:var(--card);color:var(--text);font-size:22px;font-weight:900;cursor:pointer;box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center;z-index:9999;user-select:none}
    .fab:active{transform:scale(.98)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Storico partite</h1>
        <div class="muted">Quelli della pensione</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <a href="index.html">‚¨ÖÔ∏è Home</a>
        <a href="admin.html">üîê Admin</a>
      </div>
    </div>

    <div id="list" class="muted" style="margin-top:14px">Caricamento‚Ä¶</div>
  </div>

  <button id="themeToggle" class="fab" title="Tema chiaro/scuro">üåô</button>

  <script>
    const btnTheme = document.getElementById("themeToggle");
    function setTheme(mode){
      document.body.classList.toggle("dark", mode === "dark");
      btnTheme.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("qdp_theme", mode);
    }
    const saved = localStorage.getItem("qdp_theme");
    setTheme(saved === "dark" ? "dark" : "light");
    btnTheme.addEventListener("click", () => setTheme(document.body.classList.contains("dark") ? "light" : "dark"));
  </script>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const listEl = document.getElementById("list");

    if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
      listEl.innerHTML = "<b>Config mancante (config.js)</b>";
      throw new Error("Missing config");
    }

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function pill(s){ return `<span class="pill">${s}</span>`; }

    async function load(){
      const { data: matches, error } = await client
        .from("matches")
        .select("id,match_date,match_time,venue,keeper_a,keeper_b,called_up,score_a,score_b,is_finished")
        .order("match_date",{ascending:false})
        .order("match_time",{ascending:false})
        .limit(200);

      if(error){
        listEl.innerHTML = `<b style="color:#ff4d4d">Errore: ${error.message}</b>`;
        return;
      }

      if(!matches || !matches.length){
        listEl.textContent = "Nessuna partita nello storico.";
        return;
      }

      // prendi nomi convocati in blocco (pi√π veloce)
      const allIds = [...new Set(matches.flatMap(m => Array.isArray(m.called_up) ? m.called_up : []))];
      let idToName = new Map();
      if(allIds.length){
        const { data: players } = await client.from("players").select("id,name").in("id", allIds);
        (players||[]).forEach(p => idToName.set(String(p.id), p.name));
      }

      listEl.innerHTML = matches.map(m=>{
        const time = String(m.match_time||"").slice(0,5);
        const res = (m.score_a!=null && m.score_b!=null) ? `<b>Risultato:</b> ${m.score_a}-${m.score_b}` : `<span class="muted">Risultato: ‚Äî</span>`;
        const called = (Array.isArray(m.called_up) ? m.called_up : [])
          .map(id => idToName.get(String(id))).filter(Boolean);

        return `
          <div class="card">
            <div><b>${m.match_date}</b> ${time} ‚Ä¢ ${m.venue||""}</div>
            <div class="muted" style="margin-top:6px"><b>Portieri:</b> ${m.keeper_a||"-"} vs ${m.keeper_b||"-"}</div>
            <div style="margin-top:8px">${res}</div>
            <div style="margin-top:10px"><b>Convocati:</b></div>
            <div>${called.length ? called.map(pill).join("") : "<span class='muted'>‚Äî</span>"}</div>
          </div>
        `;
      }).join("");
    }

    load();
  </script>
</body>
</html>
