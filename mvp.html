<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vota MVP ‚Ä¢ Quelli della pensione</title>

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f4f6f8; --card:#fff; --text:#111827; --muted:#6b7280;
  --border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08);
  --btn:#111; --ok:#16a34a; --err:#b91c1c;
}
body.dark{
  --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
  --border:#2a2f3a; --shadow:0 10px 28px rgba(0,0,0,.45);
  --btn:#0b0e14;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:480px;margin:24px auto;padding:16px}
.card{
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
}
h1{
  font-family:'Bebas Neue';
  letter-spacing:2px;
  margin:0 0 10px;
  text-align:center;
}
p{font-size:14px;color:var(--muted);text-align:center}

label{display:block;margin-top:14px;font-size:13px;font-weight:800}
select,input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:14px;
  background:transparent;
  color:var(--text);
}
button{
  width:100%;
  margin-top:18px;
  padding:14px;
  border-radius:14px;
  border:0;
  background:var(--btn);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.msg{
  margin-top:14px;
  padding:12px;
  border-radius:12px;
  font-size:14px;
}
.msg.ok{background:#dcfce7;color:#166534}
.msg.err{background:#fee2e2;color:#991b1b;font-weight:900}
.back{
  margin-top:14px;
  display:block;
  text-align:center;
  color:var(--muted);
  text-decoration:none;
  font-size:13px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>VOTA MVP</h1>
    <p>Scegli il miglior giocatore della partita</p>

    <label>Giocatore</label>
    <select id="playerSelect">
      <option value="">‚Äî scegli ‚Äî</option>
    </select>

    <label>Codice</label>
    <input id="code" value="QDP" disabled>

    <button id="btnVote">üèÜ Vota</button>

    <div id="msg" class="msg" style="display:none"></div>

    <a class="back" href="index.html">‚¨ÖÔ∏è Torna al sito</a>
  </div>
</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id => document.getElementById(id);
const MSG = $("msg");

function setMsg(text,type){
  MSG.style.display="block";
  MSG.className="msg "+type;
  MSG.textContent=text;
}

const deviceIdKey = "qdp_mvp_uuid";
let deviceId = localStorage.getItem(deviceIdKey);
if(!deviceId){
  deviceId = crypto.randomUUID();
  localStorage.setItem(deviceIdKey, deviceId);
}

let CURRENT_MATCH = null;

/* carica ultima partita */
async function loadMatch(){
  const { data } = await client
    .from("matches")
    .select("id,called_up")
    .order("match_date",{ascending:false})
    .limit(1)
    .single();

  if(!data){
    setMsg("Nessuna partita disponibile","err");
    return;
  }
  CURRENT_MATCH = data.id;
  loadPlayers(data.called_up || []);
}

/* carica giocatori convocati */
async function loadPlayers(ids){
  if(!ids.length){
    setMsg("Nessun convocato","err");
    return;
  }
  const { data } = await client
    .from("players")
    .select("id,name")
    .in("id", ids);

  data.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=p.name;
    $("playerSelect").appendChild(opt);
  });
}

/* voto */
$("btnVote").onclick = async ()=>{
  const player_id = $("playerSelect").value;
  if(!player_id) return setMsg("Seleziona un giocatore","err");

  const { error } = await client.from("mvp_votes").insert([{
    match_id: CURRENT_MATCH,
    player_id,
    device_uuid: deviceId
  }]);

  if(error){
    setMsg("Hai gi√† votato ‚úîÔ∏è","err");
    return;
  }

  setMsg("Voto registrato! üèÜ","ok");
  $("btnVote").disabled=true;
};

loadMatch();
</script>
</body>
</html>
