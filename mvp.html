<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Vota MVP ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08);
      --btn:#111; --pill:#eeeeee; --okBg:#dcfce7; --okText:#166534;
      --errBg:#ffe4e6; --errText:#9f1239;
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
      --border:#2a2f3a; --shadow:0 10px 28px rgba(0,0,0,.45);
      --btn:#0b0e14; --pill:#222631; --okBg:rgba(34,197,94,.15); --okText:#86efac;
      --errBg:rgba(244,63,94,.16); --errText:#fda4af;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);margin:12px 0}
    h1{font-family:'Bebas Neue';letter-spacing:2px;margin:0;font-size:40px;text-transform:uppercase}
    .muted{color:var(--muted)}
    label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin:12px 0 6px}
    select,input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);outline:none}
    .btn{width:100%;margin-top:12px;padding:12px 14px;border:0;border-radius:14px;background:var(--btn);color:#fff;font-weight:900;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .msg{margin-top:12px;padding:12px;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.04);white-space:pre-wrap;font-size:13px}
    body.dark .msg{background:rgba(255,255,255,.04)}
    .msg.ok{background:var(--okBg);color:var(--okText);border-color:rgba(34,197,94,.35)}
    .msg.err{background:var(--errBg);color:var(--errText);border-color:rgba(244,63,94,.35);font-weight:900}
    .nav{display:flex;gap:10px;flex-wrap:wrap;font-size:14px}
    .nav a{color:inherit;text-decoration:none;font-weight:800}
    .fab{
      position:fixed;right:16px;bottom:16px;width:54px;height:54px;border-radius:999px;
      border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);cursor:pointer;font-size:22px
    }
    .pill{display:inline-block;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-weight:900}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card" style="text-align:center">
    <div class="pill">QDP</div>
    <h1>Vota MVP</h1>
    <div class="muted">Senza registrazione ‚Ä¢ 1 voto per dispositivo</div>
  </div>

  <div class="card">
    <div id="matchInfo" class="muted">Caricamento partita‚Ä¶</div>

    <div id="voteBox" style="display:none">
      <label>Scegli il migliore</label>
      <select id="playerSelect"></select>

      <label>Codice (fisso)</label>
      <input id="code" type="text" value="QDP" />

      <button id="btnVote" class="btn">üó≥ Vota</button>
      <div id="msg" class="msg">‚Äî</div>
    </div>

    <div id="closedBox" style="display:none" class="msg err">
      Votazione chiusa per questa partita.
    </div>
  </div>

  <div class="card nav muted">
    <a href="index.html">üè† Home</a>
    <a href="storico.html">üìö Storico</a>
    <a href="admin.html">üîê Admin</a>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script>
/* THEME */
const themeBtn = document.getElementById("themeToggle");
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

/* SUPABASE */
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const matchInfo = document.getElementById("matchInfo");
const voteBox = document.getElementById("voteBox");
const closedBox = document.getElementById("closedBox");
const playerSelect = document.getElementById("playerSelect");
const btnVote = document.getElementById("btnVote");
const msgEl = document.getElementById("msg");

function setMsg(t, kind=""){
  msgEl.className = "msg" + (kind ? " " + kind : "");
  msgEl.textContent = t;
}

function formatDateFull(iso){
  return new Date(iso).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
}

function getVoterId(){
  let id = localStorage.getItem("qdp_voter_id");
  if(!id){
    id = (crypto?.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random().toString(16).slice(2)));
    localStorage.setItem("qdp_voter_id", id);
  }
  return id;
}

let MATCH = null;

async function load(){
  // ultima partita
  const { data: matches, error } = await client
    .from("matches")
    .select("id,match_date,match_time,venue,called_up,vote_open,voting_open")
    .order("match_date",{ascending:false})
    .order("match_time",{ascending:false})
    .limit(1);

  if(error){
    matchInfo.textContent = "Errore caricamento partita: " + error.message;
    return;
  }
  if(!matches || !matches.length){
    matchInfo.textContent = "Nessuna partita creata.";
    return;
  }

  MATCH = matches[0];
  const time = String(MATCH.match_time||"").slice(0,5);
  matchInfo.innerHTML = `<b>üìÖ ${formatDateFull(MATCH.match_date)}</b><br><span class="muted">‚è∞ ${time} ‚Ä¢ ${MATCH.venue||""}</span>`;

  const open = !!(MATCH.vote_open || MATCH.voting_open);
  if(!open){
    voteBox.style.display="none";
    closedBox.style.display="block";
    return;
  }

  // carica convocati
  const ids = Array.isArray(MATCH.called_up) ? MATCH.called_up : [];
  if(!ids.length){
    voteBox.style.display="none";
    closedBox.style.display="block";
    closedBox.textContent = "Convocati non presenti: non posso aprire il voto.";
    return;
  }

  const { data: players, error: e2 } = await client
    .from("players")
    .select("id,name")
    .in("id", ids);

  if(e2){
    matchInfo.textContent += "\nErrore convocati: " + e2.message;
    return;
  }

  players.sort((a,b)=> String(a.name).localeCompare(String(b.name),"it"));

  playerSelect.innerHTML = players.map(p => `<option value="${p.id}">${p.name}</option>`).join("");

  voteBox.style.display="block";
  closedBox.style.display="none";
  setMsg("Seleziona un giocatore e vota.", "");
}

btnVote.onclick = async () => {
  if(!MATCH) return;

  const code = (document.getElementById("code").value || "").trim().toUpperCase();
  if(code !== "QDP"){
    setMsg("Codice errato. Scrivi QDP.", "err");
    return;
  }

  const player_id = playerSelect.value;
  if(!player_id){
    setMsg("Seleziona un giocatore.", "err");
    return;
  }

  btnVote.disabled = true;
  setMsg("Invio voto‚Ä¶");

  const voter_id = getVoterId();

  const { error } = await client.from("mvp_votes").insert([{
    match_id: MATCH.id,
    player_id,
    voter_id
  }]);

  if(error){
    btnVote.disabled = false;

    // Se hai una UNIQUE (match_id, voter_id) questo √® normale: 1 voto solo.
    if(String(error.message||"").toLowerCase().includes("duplicate")
       || String(error.message||"").toLowerCase().includes("unique")){
      setMsg("Hai gi√† votato per questa partita ‚úÖ", "ok");
      btnVote.disabled = true;
      return;
    }

    setMsg("Errore voto: " + error.message, "err");
    return;
  }

  setMsg("Voto registrato ‚úÖ Grazie!", "ok");
  btnVote.disabled = true;
};

load();
</script>
</body>
</html>
