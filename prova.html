<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08);
      --btn:#111; --btn2:#444; --danger:#b00020;
      --okBg:#dcfce7; --okText:#166534;
      --errBg:#ffe4e6; --errText:#9f1239;
      --chipBg:rgba(0,0,0,.04);
      --pill:#eeeeee;
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
      --border:#2a2f3a; --shadow:0 10px 28px rgba(0,0,0,.45);
      --btn:#0b0e14; --btn2:#2a3242; --danger:#ff4d4d;
      --okBg:rgba(34,197,94,.15); --okText:#86efac;
      --errBg:rgba(244,63,94,.16); --errText:#fda4af;
      --chipBg:rgba(255,255,255,.04);
      --pill:#222631;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    a{color:inherit}
    .wrap{max-width:980px;margin:20px auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:56px;height:56px;border-radius:999px;
      background:linear-gradient(135deg,#111,#333);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:26px;letter-spacing:2px;
      box-shadow:var(--shadow);
      border:2px solid rgba(255,255,255,.85);
    }
    body.dark .logo{border:2px solid rgba(255,255,255,.12)}
    h1{margin:0;font-family:'Bebas Neue';letter-spacing:2px}
    .muted{color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns:440px 1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow);
    }

    label{display:block;margin-top:12px;font-size:12px;color:var(--muted);font-weight:800}
    input,select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      outline:none;
      font-family:Inter;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      padding:12px 14px;border-radius:14px;border:0;
      background:var(--btn);color:#fff;font-weight:900;cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      user-select:none;
    }
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:var(--danger)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.full{width:100%}
    .btn.small{padding:10px 12px;border-radius:12px;font-weight:800}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .msg{
      margin-top:12px;padding:12px;border-radius:12px;
      font-size:13px;border:1px solid var(--border);
      background:var(--chipBg);white-space:pre-wrap;
    }
    .msg.ok{background:var(--okBg);color:var(--okText);border-color:rgba(34,197,94,.35)}
    .msg.err{background:var(--errBg);color:var(--errText);border-color:rgba(244,63,94,.35);font-weight:900}

    .fab{
      position:fixed;right:16px;bottom:16px;
      width:54px;height:54px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);color:var(--text);font-size:22px;
      cursor:pointer;box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center;
      z-index:9999;
    }

    .playersBox{
      max-height:320px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:var(--chipBg);
    }

    /* Riga giocatore con avatar */
    .pRow{
      display:flex;align-items:center;gap:10px;
      padding:10px 8px;border-radius:12px;
      user-select:none;
    }
    .pRow:hover{background:rgba(0,0,0,.03)}
    body.dark .pRow:hover{background:rgba(255,255,255,.04)}
    .pRow input{width:auto;transform:scale(1.15)}
    .pRow .pAvatar{
      width:34px;height:34px;border-radius:999px;
      border:1px solid var(--border);
      object-fit:cover;
      background:#000;
      flex:0 0 auto;
    }
    .pRow .pName{
      font-weight:900;
      line-height:1.1;
    }
    .pRow .pMeta{
      font-size:11px;
      color:var(--muted);
      font-weight:800;
      margin-top:2px;
      line-height:1.1;
    }

    .countChip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;font-size:12px;margin-top:10px;
    }

    .sectionTitle{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:0 0 8px;
    }
    .sectionTitle h2{margin:0;font-size:16px}
    .hr{height:1px;background:var(--border);margin:12px 0}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 6px}
    td{padding:0 6px;vertical-align:top}
    .mini{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-block;background:var(--pill);
      border:1px solid var(--border);
      border-radius:999px;padding:6px 10px;font-weight:900
    }

    .teamTitle{display:flex;align-items:center;gap:10px;margin:0 0 8px}
    .shirt{width:18px;height:18px;vertical-align:middle;filter:drop-shadow(0 2px 2px rgba(0,0,0,.2))}
    .twoCols{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){ .twoCols{grid-template-columns:1fr 1fr} }

    .togglePill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;font-size:12px;
    }
    .togglePill button{
      border:0; cursor:pointer;
      padding:8px 10px;border-radius:999px;
      font-weight:900;
      background:var(--btn);
      color:#fff;
    }
    .togglePill button.off{ background:var(--danger); }

    /* Modal nuovo giocatore */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:10000;
    }
    .modal{
      width:min(520px,100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:16px;
    }
    .modalTitle{margin:0;font-size:16px}
    .modalActions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo">QDP</div>
      <div>
        <h1>Dashboard</h1>
        <div class="muted">Quelli della pensione ‚Ä¢ gestione partita ‚Ä¢ marcatori</div>
      </div>
    </div>
    <div class="row" style="margin-top:0">
      <a class="btn ghost small" href="index.html" style="text-decoration:none">‚¨ÖÔ∏è Sito</a>
      <a class="btn ghost small" href="storico.html" style="text-decoration:none">üìö Storico</a>
      <button id="btnLogout" class="btn secondary small">üö™ Esci</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="sectionTitle">
        <h2>Gestione partita</h2>
        <span id="countInfo" class="countChip">üë• Convocati: 0/12</span>
      </div>

      <div id="msg" class="msg">Caricamento‚Ä¶</div>

      <label>Partita</label>
      <select id="matchSelect">
        <option value="">‚Äî Nuova partita ‚Äî</option>
      </select>

      <div class="row">
        <button id="btnNew" class="btn ghost small">‚ûï Nuova</button>
        <button id="btnRefresh" class="btn ghost small">üîÑ Aggiorna</button>
      </div>

      <label>Data</label>
      <input id="matchDate" type="date">

      <label>Ora</label>
      <input id="matchTime" type="time" value="21:00">

      <label>Campo</label>
      <input id="venue" type="text" value="Campo a 6 - Aradeo">

      <label>Portiere Squadra A</label>
      <input id="keeperA" type="text" placeholder="Es. Gianni">

      <label>Portiere Squadra B</label>
      <input id="keeperB" type="text" placeholder="Es. Andrea o Tonino">

      <div class="row" style="align-items:center">
        <label style="margin:0">Convocati (max 12)</label>
        <button id="btnAddPlayer" class="btn ghost small" type="button">‚ûï Nuovo giocatore</button>
      </div>

      <div id="playersBox" class="playersBox"></div>

      <div class="row">
        <button id="btnSave" class="btn full">üíæ Salva partita</button>
        <button id="btnDelete" class="btn danger full">üóë Elimina partita</button>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h2>Fine partita</h2>
        <span class="pill" id="currentHint">Nessuna partita selezionata</span>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="togglePill" id="votePill">
          üó≥ MVP: <span id="voteState">‚Äî</span>
          <button id="btnToggleVote" class="off" disabled>Caricamento‚Ä¶</button>
        </div>
      </div>

      <div class="mini" style="margin-top:8px">
        Risultato, formazioni e marcatori sono <b>facoltativi</b>. I marcatori li inserisce solo l‚Äôadmin.
      </div>

      <div class="hr"></div>

      <div class="twoCols">
        <div>
          <label>Goal Squadra A</label>
          <input id="scoreA" type="number" min="0" step="1" placeholder="es. 5">
        </div>
        <div>
          <label>Goal Squadra B</label>
          <input id="scoreB" type="number" min="0" step="1" placeholder="es. 4">
        </div>
      </div>

      <div class="hr"></div>

      <div class="twoCols">
        <div>
          <div class="teamTitle" id="formATitle"></div>
          <div class="mini">Seleziona i giocatori convocati per la formazione (facoltativo)</div>
          <div id="teamABox" class="playersBox" style="max-height:220px;margin-top:10px"></div>
        </div>

        <div>
          <div class="teamTitle" id="formBTitle"></div>
          <div class="mini">Seleziona i giocatori convocati per la formazione (facoltativo)</div>
          <div id="teamBBox" class="playersBox" style="max-height:220px;margin-top:10px"></div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="twoCols">
        <div>
          <div class="teamTitle" id="teamATitle"></div>
          <table>
            <thead>
              <tr>
                <th>Giocatore (convocato)</th>
                <th style="width:90px">Gol</th>
                <th style="width:70px"></th>
              </tr>
            </thead>
            <tbody id="tbodyA"></tbody>
          </table>
          <button id="addRowA" class="btn ghost small">+ Aggiungi</button>
        </div>

        <div>
          <div class="teamTitle" id="teamBTitle"></div>
          <table>
            <thead>
              <tr>
                <th>Giocatore (convocato)</th>
                <th style="width:90px">Gol</th>
                <th style="width:70px"></th>
              </tr>
            </thead>
            <tbody id="tbodyB"></tbody>
          </table>
          <button id="addRowB" class="btn ghost small">+ Aggiungi</button>
        </div>
      </div>

      <div class="row">
        <button id="btnSaveResult" class="btn full">üèÅ Salva risultato + formazioni + marcatori</button>
      </div>

      <div class="mini" style="margin-top:10px">
        Se non metti il risultato, salva comunque formazioni/marcatori (o viceversa). Le formazioni sono opzionali.
      </div>
    </div>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<!-- MODAL NUOVO GIOCATORE -->
<div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="row" style="justify-content:space-between;align-items:center;margin-top:0">
      <h3 class="modalTitle">‚ûï Aggiungi giocatore</h3>
      <button id="btnCloseModal" class="btn ghost small" type="button">‚úñ</button>
    </div>

    <label>Nome giocatore</label>
    <input id="newPlayerName" type="text" placeholder="Es. Marco">

    <div class="mini" style="margin-top:10px">
      Verr√† aggiunto alla lista ‚Äúplayers‚Äù e potrai convocarlo subito.
    </div>

    <div class="modalActions">
      <button id="btnCreatePlayer" class="btn" type="button">‚úÖ Crea</button>
      <button id="btnCancelModal" class="btn ghost" type="button">Annulla</button>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ===== THEME ===== */
function setTheme(m){
  document.body.classList.toggle("dark", m==="dark");
  document.getElementById("themeToggle").textContent = m==="dark" ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", m);
}
setTheme(localStorage.getItem("qdp_theme")==="dark" ? "dark" : "light");
document.getElementById("themeToggle").onclick=()=> {
  setTheme(document.body.classList.contains("dark") ? "light" : "dark");
};

/* ===== SUPABASE ===== */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = (id)=>document.getElementById(id);

function setMsg(t, kind=""){
  const el = $("msg");
  el.className = "msg" + (kind ? " " + kind : "");
  el.textContent = t;
}

/* ===== Avatar config ===== */
const AVATAR_BASE = "avatars/";
const DEFAULT_AVATAR = "default.png";
function avatarUrl(file){
  const f = String(file || "").trim();
  return AVATAR_BASE + (f ? f : DEFAULT_AVATAR);
}
function roleText(p){
  // role in db: "GK" / "FIELD"
  const r = String(p?.role||"").toUpperCase();
  if(r === "GK") return "PORTIERE";
  return "GIOCATORE";
}

/* ===== State ===== */
let PLAYERS = []; // {id,name,role,position,avatar}
let MATCHES = [];
let CURRENT = null;

/* ===== UI helpers ===== */
function shirtSVG(color){
  return `
    <svg class="shirt" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M20 10 L28 6 H36 L44 10 L56 18 L50 30 L44 26 V58 H20 V26 L14 30 L8 18 Z"
        fill="${color}" stroke="rgba(0,0,0,.35)" stroke-width="2"/>
    </svg>`;
}
$("teamATitle").innerHTML = `${shirtSVG("#facc15")} <b>Marcatori Squadra A</b>`;
$("teamBTitle").innerHTML = `${shirtSVG("#ef4444")} <b>Marcatori Squadra B</b>`;
$("formATitle").innerHTML = `${shirtSVG("#facc15")} <b>Formazione Squadra A</b>`;
$("formBTitle").innerHTML = `${shirtSVG("#ef4444")} <b>Formazione Squadra B</b>`;

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== MVP ===== */
function isVoteOpen(m){
  if(!m) return false;
  return (m.vote_open === true) || (m.voting_open === true);
}
function updateVoteUI(){
  const stateEl = $("voteState");
  const btn = $("btnToggleVote");

  if(!CURRENT){
    stateEl.textContent = "‚Äî";
    btn.textContent = "Seleziona partita";
    btn.className = "off";
    btn.disabled = true;
    return;
  }

  const open = isVoteOpen(CURRENT);
  stateEl.textContent = open ? "APERTA ‚úÖ" : "CHIUSA ‚ùå";
  btn.textContent = open ? "Chiudi" : "Apri";
  btn.className = open ? "off" : "";
  btn.disabled = false;
}
function updateCurrentHint(){
  const hint = $("currentHint");
  if(!CURRENT){
    hint.textContent = "Nessuna partita selezionata";
    return;
  }
  const t = String(CURRENT.match_time||"").slice(0,5);
  hint.textContent = `${CURRENT.match_date} ${t} ‚Ä¢ ${CURRENT.venue||""}`.trim();
}

/* ===== helpers convocati ===== */
function getCalledUp(){
  return [...$("playersBox").querySelectorAll('input[type="checkbox"]')]
    .filter(x=>x.checked)
    .map(x=>x.value);
}
function updateCount(){
  $("countInfo").textContent = `üë• Convocati: ${getCalledUp().length}/12`;
}

/* ===== Auth ===== */
async function requireSession(){
  const { data:{session}, error } = await client.auth.getSession();
  if(error){ setMsg("Errore sessione: " + error.message, "err"); return false; }
  if(!session){ location.href="admin.html"; return false; }
  return true;
}

/* ===== DB: refetch current match ===== */
async function refetchCurrent(){
  if(!CURRENT?.id) return null;
  const { data, error } = await client
    .from("matches")
    .select("id,match_date,match_time,venue,keeper_a,keeper_b,called_up,score_a,score_b,team_a,team_b,scorers,scorers_text,vote_open,voting_open")
    .eq("id", CURRENT.id)
    .single();
  if(error) throw error;
  return data;
}

/* ===== Load players & matches ===== */
async function loadPlayers(){
  // prendiamo anche avatar/role/position per UI con foto
  const { data, error } = await client
    .from("players")
    .select("id,name,role,position,avatar")
    .order("name",{ascending:true});

  if(error) throw error;

  PLAYERS = (data || []).map(p=>({
    id: p.id,
    name: p.name || "",
    role: p.role || "FIELD",
    position: p.position || "",
    avatar: p.avatar || DEFAULT_AVATAR
  }));
}

async function loadMatches(){
  const { data, error } = await client.from("matches")
    .select("id,match_date,match_time,venue,keeper_a,keeper_b,called_up,score_a,score_b,team_a,team_b,scorers,scorers_text,vote_open,voting_open")
    .order("match_date",{ascending:false})
    .order("match_time",{ascending:false})
    .limit(200);

  if(error) throw error;
  MATCHES = data || [];

  const sel = $("matchSelect");
  sel.innerHTML = `<option value="">‚Äî Nuova partita ‚Äî</option>`;
  MATCHES.forEach(m=>{
    const time = String(m.match_time||"").slice(0,5);
    const res = (m.score_a!=null && m.score_b!=null) ? ` ‚Ä¢ ${m.score_a}-${m.score_b}` : "";
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = `${m.match_date} ${time} ‚Ä¢ ${m.venue||""}${res}`.trim();
    sel.appendChild(opt);
  });

  if(CURRENT){
    const still = MATCHES.find(x => String(x.id) === String(CURRENT.id));
    if(!still){
      CURRENT = null;
      $("matchSelect").value = "";
    }
  }

  updateVoteUI();
}

/* ===== UI: render riga giocatore con avatar ===== */
function makePlayerRow({p, checked, onChangeCb, titleText=""}){
  const row = document.createElement("label");
  row.className = "pRow";
  row.title = titleText || "";

  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.value = p.id;
  cb.checked = !!checked;
  cb.onchange = onChangeCb;

  const img = document.createElement("img");
  img.className = "pAvatar";
  img.alt = "avatar";
  img.src = avatarUrl(p.avatar);
  img.onerror = () => { img.onerror=null; img.src = avatarUrl(DEFAULT_AVATAR); };

  const wrap = document.createElement("div");

  const n = document.createElement("div");
  n.className = "pName";
  n.textContent = p.name;

  const meta = document.createElement("div");
  meta.className = "pMeta";
  const pos = (p.position || "").trim();
  meta.textContent = `${roleText(p)}${pos ? " ‚Ä¢ " + pos : ""}`;

  wrap.appendChild(n);
  wrap.appendChild(meta);

  row.appendChild(cb);
  row.appendChild(img);
  row.appendChild(wrap);

  return row;
}

/* ===== Convocati UI ===== */
function renderPlayersBox(checkedIds = []){
  const checked = new Set((checkedIds||[]).map(String));
  const box = $("playersBox");
  box.innerHTML = "";

  PLAYERS.forEach(p=>{
    const row = makePlayerRow({
      p,
      checked: checked.has(String(p.id)),
      titleText: "Spunta per convocare",
      onChangeCb: (e) => {
        const ids = getCalledUp();
        if(ids.length > 12){
          e.target.checked = false;
          setMsg("‚ö†Ô∏è Massimo 12 convocati.", "err");
        }else{
          setMsg("Convocati aggiornati (ricorda di salvare).", "ok");
        }
        updateCount();
        refreshScorersSelectOptions();
        refreshTeamsUI();
      }
    });

    box.appendChild(row);
  });

  updateCount();
}

/* ===== FORMAZIONI UI ===== */
function getCalledUpPlayers(){
  const ids = new Set(getCalledUp().map(String));
  return PLAYERS.filter(p => ids.has(String(p.id)));
}

function renderTeamBox(boxId, presetIds = []){
  const preset = new Set((presetIds||[]).map(String));
  const box = $(boxId);
  box.innerHTML = "";

  const calledPlayers = getCalledUpPlayers();
  if(!calledPlayers.length){
    box.innerHTML = `<div class="mini">Seleziona i convocati a sinistra.</div>`;
    return;
  }

  calledPlayers.forEach(p=>{
    const row = makePlayerRow({
      p,
      checked: preset.has(String(p.id)),
      titleText: "Spunta per mettere in formazione",
      onChangeCb: (e) => {
        // non pu√≤ stare in entrambe
        if(e.target.checked){
          const otherBox = (boxId === "teamABox") ? $("teamBBox") : $("teamABox");
          const otherCb = otherBox.querySelector(`input[value="${p.id}"]`);
          if(otherCb) otherCb.checked = false;
        }
      }
    });

    box.appendChild(row);
  });
}

function getTeamIds(boxId){
  return [...$(boxId).querySelectorAll('input[type="checkbox"]')]
    .filter(x=>x.checked)
    .map(x=>x.value);
}

function refreshTeamsUI(){
  const aNow = new Set(getTeamIds("teamABox").map(String));
  const bNow = new Set(getTeamIds("teamBBox").map(String));

  const called = new Set(getCalledUp().map(String));
  const aKeep = [...aNow].filter(id => called.has(id));
  const bKeep = [...bNow].filter(id => called.has(id) && !aKeep.includes(id));

  renderTeamBox("teamABox", aKeep);
  renderTeamBox("teamBBox", bKeep);
}

/* ===== Marcatori UI (select semplice: HTML <select> non supporta immagini bene) ===== */
function buildOptionsHTML(selectedValue){
  const called = getCalledUpPlayers();
  const opts = [`<option value="">‚Äî scegli ‚Äî</option>`];
  called.forEach(p=>{
    const sel = (String(selectedValue||"") === String(p.id)) ? "selected" : "";
    opts.push(`<option value="${escapeHtml(p.id)}" ${sel}>${escapeHtml(p.name)}</option>`);
  });
  return opts.join("");
}

function addScorerRow(tbodyId, presetPlayerId="", presetGoals=""){
  const tbody = $(tbodyId);
  const tr = document.createElement("tr");

  const tdP = document.createElement("td");
  const sel = document.createElement("select");
  sel.innerHTML = buildOptionsHTML(presetPlayerId);
  sel.setAttribute("data-role","player");
  tdP.appendChild(sel);

  const tdG = document.createElement("td");
  const g = document.createElement("input");
  g.type="number"; g.min="0"; g.step="1";
  g.placeholder="gol";
  g.value = presetGoals;
  g.setAttribute("data-role","goals");
  tdG.appendChild(g);

  const tdX = document.createElement("td");
  const del = document.createElement("button");
  del.className="btn ghost small";
  del.textContent="‚úñ";
  del.onclick = () => tr.remove();
  tdX.appendChild(del);

  tr.appendChild(tdP);
  tr.appendChild(tdG);
  tr.appendChild(tdX);
  tbody.appendChild(tr);
}

function clearScorersUI(){
  $("tbodyA").innerHTML = "";
  $("tbodyB").innerHTML = "";
  addScorerRow("tbodyA");
  addScorerRow("tbodyB");
}

function refreshScorersSelectOptions(){
  ["tbodyA","tbodyB"].forEach(tid=>{
    const rows = [...$(tid).querySelectorAll("tr")];
    rows.forEach(r=>{
      const sel = r.querySelector("select[data-role='player']");
      if(!sel) return;
      const current = sel.value;
      sel.innerHTML = buildOptionsHTML(current);
    });
  });
}

function readScorersFromUI(tbodyId){
  const rows = [...$(tbodyId).querySelectorAll("tr")];
  const out = [];
  for(const r of rows){
    const sel = r.querySelector("select[data-role='player']");
    const g = r.querySelector("input[data-role='goals']");
    const pid = String(sel?.value || "").trim();
    const goals = Number(g?.value || 0);
    if(!pid) continue;
    if(!Number.isFinite(goals) || goals <= 0) continue;
    out.push({ player_id: pid, goals });
  }
  return out;
}

function buildScorersText(teamA, teamB){
  const idToName = new Map(PLAYERS.map(p=>[String(p.id), p.name]));
  const fmt = (arr) => arr.map(x => `${idToName.get(String(x.player_id)) || x.player_id} ${x.goals}`).join(", ");
  const a = teamA.length ? `Squadra A: ${fmt(teamA)}` : "";
  const b = teamB.length ? `Squadra B: ${fmt(teamB)}` : "";
  if(a && b) return `${a}\n${b}`;
  return a || b || null;
}

/* ===== Form fill/clear ===== */
function clearForm(){
  CURRENT = null;
  $("matchSelect").value = "";
  $("matchDate").value = "";
  $("matchTime").value = "21:00";
  $("venue").value = "Campo a 6 - Aradeo";
  $("keeperA").value = "";
  $("keeperB").value = "";
  $("scoreA").value = "";
  $("scoreB").value = "";
  renderPlayersBox([]);
  renderTeamBox("teamABox", []);
  renderTeamBox("teamBBox", []);
  clearScorersUI();
  updateCurrentHint();
  updateVoteUI();
}

function fillForm(m){
  CURRENT = m;

  $("matchSelect").value = m.id;
  $("matchDate").value = m.match_date || "";
  $("matchTime").value = String(m.match_time || "21:00:00").slice(0,5);
  $("venue").value = m.venue || "Campo a 6 - Aradeo";
  $("keeperA").value = m.keeper_a || "";
  $("keeperB").value = m.keeper_b || "";

  renderPlayersBox(m.called_up || []);

  $("scoreA").value = (m.score_a==null ? "" : m.score_a);
  $("scoreB").value = (m.score_b==null ? "" : m.score_b);

  const taIds = Array.isArray(m.team_a) ? m.team_a : [];
  const tbIds = Array.isArray(m.team_b) ? m.team_b : [];
  renderTeamBox("teamABox", taIds);
  renderTeamBox("teamBBox", tbIds);

  $("tbodyA").innerHTML = "";
  $("tbodyB").innerHTML = "";

  const sc = m.scorers || {};
  const sA = Array.isArray(sc.team_a) ? sc.team_a : [];
  const sB = Array.isArray(sc.team_b) ? sc.team_b : [];

  if(sA.length){
    sA.forEach(x => addScorerRow("tbodyA", x.player_id || "", x.goals || ""));
  }else addScorerRow("tbodyA");

  if(sB.length){
    sB.forEach(x => addScorerRow("tbodyB", x.player_id || "", x.goals || ""));
  }else addScorerRow("tbodyB");

  refreshScorersSelectOptions();

  updateCurrentHint();
  updateVoteUI();
  setMsg("Partita caricata. Puoi salvare o inserire dati fine partita.", "ok");
}

/* ===== Nuovo giocatore (modal + insert) ===== */
const modalOverlay = $("modalOverlay");
const btnAddPlayer = $("btnAddPlayer");
const btnCloseModal = $("btnCloseModal");
const btnCancelModal = $("btnCancelModal");
const btnCreatePlayer = $("btnCreatePlayer");
const newPlayerName = $("newPlayerName");

function openModal(){
  modalOverlay.style.display = "flex";
  newPlayerName.value = "";
  setTimeout(()=>newPlayerName.focus(), 10);
}
function closeModal(){
  modalOverlay.style.display = "none";
}
btnAddPlayer.onclick = openModal;
btnCloseModal.onclick = closeModal;
btnCancelModal.onclick = closeModal;
modalOverlay.addEventListener("click", (e)=>{
  if(e.target === modalOverlay) closeModal();
});
newPlayerName.addEventListener("keydown", (e)=>{
  if(e.key === "Escape") closeModal();
  if(e.key === "Enter") btnCreatePlayer.click();
});

async function createPlayer(){
  const name = (newPlayerName.value || "").trim();
  if(!name) return setMsg("Inserisci un nome valido.", "err");

  // check duplicato soft (case-insensitive)
  const lower = name.toLowerCase();
  const exists = PLAYERS.find(p => String(p.name||"").trim().toLowerCase() === lower);
  if(exists){
    setMsg(`‚ö†Ô∏è Esiste gi√†: "${exists.name}". Selezionalo dalla lista.`, "err");
    closeModal();
    return;
  }

  btnCreatePlayer.disabled = true;

  try{
    setMsg("‚ûï Creo giocatore‚Ä¶");

    // FIX constraint:
    // - role: "FIELD" (MAIUSCOLO)
    // - avatar: default.png
    // - position: "" (facoltativo)
    const payload = {
      name,
      role: "FIELD",
      avatar: DEFAULT_AVATAR,
      position: ""
    };

    const { data, error } = await client
      .from("players")
      .insert([payload])
      .select("id,name,role,position,avatar")
      .single();

    if(error) throw error;

    PLAYERS = [...PLAYERS, {
      id: data.id,
      name: data.name || "",
      role: data.role || "FIELD",
      position: data.position || "",
      avatar: data.avatar || DEFAULT_AVATAR
    }].sort((a,b)=>String(a.name).localeCompare(String(b.name),"it"));

    const prevChecked = getCalledUp();
    renderPlayersBox(prevChecked);

    // auto-spunta il nuovo se c'√® spazio
    const now = getCalledUp();
    if(now.length < 12){
      const cb = $("playersBox").querySelector(`input[value="${data.id}"]`);
      if(cb){ cb.checked = true; }
      updateCount();
      refreshScorersSelectOptions();
      refreshTeamsUI();
    }

    closeModal();
    setMsg(`‚úÖ Giocatore aggiunto: ${data.name}`, "ok");

  }catch(e){
    console.error(e);
    setMsg("‚ùå Errore creazione giocatore: " + (e.message||e), "err");
  }finally{
    btnCreatePlayer.disabled = false;
  }
}
btnCreatePlayer.onclick = createPlayer;

/* ===== Actions ===== */
async function saveMatch(){
  const match_date = $("matchDate").value;
  const match_time = $("matchTime").value ? ($("matchTime").value + ":00") : "21:00:00";
  const venue = $("venue").value || "Campo a 6 - Aradeo";
  const keeper_a = $("keeperA").value.trim();
  const keeper_b = $("keeperB").value.trim();
  const called_up = getCalledUp();

  if(!match_date) return setMsg("üìÖ Inserisci la data.", "err");
  if(!keeper_a || !keeper_b) return setMsg("ü•Ö Inserisci i 2 portieri.", "err");
  if(keeper_a.toLowerCase() === keeper_b.toLowerCase()) return setMsg("ü•Ö I portieri devono essere diversi.", "err");
  if(called_up.length > 12) return setMsg("üë• Max 12 convocati.", "err");

  const btn = $("btnSave");
  btn.disabled = true;

  try{
    if(CURRENT && CURRENT.id){
      const upd = { match_date, match_time, venue, keeper_a, keeper_b, called_up };
      setMsg("üíæ Salvataggio partita‚Ä¶");
      const { error } = await client.from("matches").update(upd).eq("id", CURRENT.id);
      if(error) throw error;
      setMsg("‚úÖ Partita aggiornata.", "ok");
    }else{
      const payload = { match_date, match_time, venue, keeper_a, keeper_b, called_up, vote_open: true, voting_open: true };
      setMsg("üíæ Creazione partita‚Ä¶");
      const { data, error } = await client.from("matches").insert([payload]).select("*").single();
      if(error) throw error;
      CURRENT = data;
      setMsg("‚úÖ Partita creata (MVP aperto).", "ok");
    }

    await loadMatches();
    const fresh = await refetchCurrent();
    if(fresh) fillForm(fresh);

  }catch(e){
    console.error(e);
    setMsg("‚ùå Errore salvataggio: " + (e.message||e), "err");
  }finally{
    btn.disabled = false;
  }
}

async function deleteMatch(){
  if(!CURRENT) return setMsg("‚ÑπÔ∏è Seleziona una partita.", "err");
  if(!confirm("Sicuro di eliminare questa partita? (eliminer√† anche i voti MVP)")) return;

  const btn = $("btnDelete");
  btn.disabled = true;

  try{
    setMsg("üóë Eliminazione‚Ä¶ (prima voto MVP)");
    const delVotes = await client.from("mvp_votes").delete().eq("match_id", CURRENT.id);
    if(delVotes.error) console.warn("Delete mvp_votes:", delVotes.error);

    setMsg("üóë Eliminazione‚Ä¶ (partita)");
    const { error } = await client.from("matches").delete().eq("id", CURRENT.id);
    if(error) throw error;

    clearForm();
    await loadMatches();
    setMsg("‚úÖ Partita eliminata (e voti MVP rimossi).", "ok");

  }catch(e){
    console.error(e);
    setMsg("‚ùå Errore eliminazione: " + (e.message||e), "err");
  }finally{
    btn.disabled = false;
  }
}

async function toggleVote(){
  if(!CURRENT) return;

  const btn = $("btnToggleVote");
  btn.disabled = true;

  try{
    const openNow = isVoteOpen(CURRENT);
    const next = !openNow;

    setMsg("üó≥ Aggiorno stato votazione‚Ä¶");
    const { error } = await client.from("matches")
      .update({ vote_open: next, voting_open: next })
      .eq("id", CURRENT.id);

    if(error) throw error;

    await loadMatches();
    const fresh = await refetchCurrent();
    if(fresh) fillForm(fresh);

    setMsg(next ? "‚úÖ Votazione MVP APERTA." : "‚úÖ Votazione MVP CHIUSA.", "ok");

  }catch(e){
    console.error(e);
    setMsg("‚ùå Errore votazione: " + (e.message||e), "err");
  }finally{
    btn.disabled = false;
  }
}

async function saveResultTeamsAndScorers(){
  if(!CURRENT) return setMsg("‚ÑπÔ∏è Seleziona una partita prima.", "err");

  const btn = $("btnSaveResult");
  btn.disabled = true;

  try{
    const sAraw = $("scoreA").value;
    const sBraw = $("scoreB").value;

    const score_a = (sAraw === "" ? null : parseInt(sAraw, 10));
    const score_b = (sBraw === "" ? null : parseInt(sBraw, 10));
    if(score_a != null && Number.isNaN(score_a)) return setMsg("Goal A non valido.", "err");
    if(score_b != null && Number.isNaN(score_b)) return setMsg("Goal B non valido.", "err");

    const team_a = getTeamIds("teamABox");
    const team_b = getTeamIds("teamBBox");
    const dup = team_a.filter(id => team_b.includes(id));
    if(dup.length) return setMsg("Un giocatore non pu√≤ stare in entrambe le formazioni.", "err");

    const scorA = readScorersFromUI("tbodyA");
    const scorB = readScorersFromUI("tbodyB");
    const scorers = (scorA.length || scorB.length) ? { team_a: scorA, team_b: scorB } : null;
    const scorers_text = buildScorersText(scorA, scorB);

    setMsg("üèÅ Salvataggio fine partita‚Ä¶");

    const payload1 = { score_a, score_b, team_a, team_b, scorers, scorers_text };

    let { error } = await client.from("matches").update(payload1).eq("id", CURRENT.id);

    // fallback se scorers_text non esiste
    if(error && String(error.message||"").toLowerCase().includes("scorers_text")){
      const payload2 = { score_a, score_b, team_a, team_b, scorers };
      const r2 = await client.from("matches").update(payload2).eq("id", CURRENT.id);
      error = r2.error;
    }

    if(error) throw error;

    setMsg("‚úÖ Salvato! (risultato + formazioni + marcatori)", "ok");

    await loadMatches();
    const fresh = await refetchCurrent();
    if(fresh) fillForm(fresh);

  }catch(e){
    console.error(e);
    setMsg("‚ùå Errore: " + (e.message||e), "err");
  }finally{
    btn.disabled = false;
  }
}

/* ===== Events ===== */
$("btnSave").onclick = saveMatch;
$("btnDelete").onclick = deleteMatch;
$("btnSaveResult").onclick = saveResultTeamsAndScorers;
$("btnToggleVote").onclick = toggleVote;

$("btnNew").onclick = () => { clearForm(); setMsg("‚ûï Nuova partita: compila e salva.", "ok"); };
$("btnRefresh").onclick = async () => { setMsg("üîÑ Aggiorno‚Ä¶"); await loadMatches(); setMsg("‚úÖ Lista aggiornata.", "ok"); };

$("addRowA").onclick = () => addScorerRow("tbodyA");
$("addRowB").onclick = () => addScorerRow("tbodyB");

$("matchSelect").onchange = async () => {
  const id = $("matchSelect").value;
  if(!id){ clearForm(); return; }
  const m = MATCHES.find(x => String(x.id) === String(id));
  if(m){
    CURRENT = { id: m.id };
    try{
      const fresh = await refetchCurrent();
      if(fresh) fillForm(fresh);
      else fillForm(m);
    }catch(e){
      console.error(e);
      fillForm(m);
    }
  }
};

$("btnLogout").onclick = async () => {
  setMsg("üö™ Logout‚Ä¶");
  const { error } = await client.auth.signOut();
  if(error) return setMsg("‚ùå Errore logout: " + error.message, "err");
  location.href = "admin.html";
};

/* ===== Init ===== */
(async()=>{
  const ok = await requireSession();
  if(!ok) return;

  try{
    setMsg("‚è≥ Caricamento‚Ä¶");
    await loadPlayers();
    await loadMatches();
    clearForm();
    setMsg("‚úÖ Pronto.", "ok");
  }catch(e){
    console.error(e);
    setMsg("‚ùå Errore init: " + (e.message||e), "err");
  }
})();
</script>
</body>
</html>
