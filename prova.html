<!doctype html>

<html lang="it">

<head>

ย <meta charset="utf-8">

ย <meta name="viewport" content="width=device-width, initial-scale=1">

ย <title>Quelli della pensione</title>


ย <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">


ย <style>

ยยย :root{

ยยยยย --bg:#f4f6f8;

ยยยยย --card:#ffffff;

ยยยยย --text:#111827;

ยยยยย --muted:#6b7280;

ยยยยย --border:#e5e7eb;

ยยยยย --shadow:0 6px 20px rgba(0,0,0,.08);

ยยยยย --pill:#eeeeee;

ยยยยย --logo1:#111;

ยยยยย --logo2:#333;

ยยยยย --btn:#111;


ยยยยย --okBg:#dcfce7; --okText:#166534; --okBd:rgba(34,197,94,.35);

ยยยยย --warnBg:#fff7ed; --warnText:#9a3412; --warnBd:rgba(249,115,22,.35);

ยยยยย --riskBg:#ffe4e6; --riskText:#9f1239; --riskBd:rgba(244,63,94,.35);

ยยย }

ยยย body.dark{

ยยยยย --bg:#0f1115;

ยยยยย --card:#171a21;

ยยยยย --text:#e5e7eb;

ยยยยย --muted:#a1a1aa;

ยยยยย --border:#2a2f3a;

ยยยยย --shadow:0 10px 28px rgba(0,0,0,.45);

ยยยยย --pill:#222631;

ยยยยย --logo1:#0b0e14;

ยยยยย --logo2:#2a3242;

ยยยยย --btn:#0b0e14;


ยยยยย --okBg:rgba(34,197,94,.15); --okText:#86efac; --okBd:rgba(34,197,94,.35);

ยยยยย --warnBg:rgba(249,115,22,.14); --warnText:#fdba74; --warnBd:rgba(249,115,22,.35);

ยยยยย --riskBg:rgba(244,63,94,.16); --riskText:#fda4af; --riskBd:rgba(244,63,94,.35);

ยยย }


ยยย *{box-sizing:border-box}

ยยย body{

ยยยยย margin:0;

ยยยยย font-family:Inter,system-ui;

ยยยยย background:var(--bg);

ยยยยย color:var(--text);

ยยยยย transition:.2s;

ยยย }

ยยย .wrap{max-width:760px;margin:auto;padding:16px}


ยยย .card{

ยยยยย background:var(--card);

ยยยยย border:1px solid var(--border);

ยยยยย border-radius:16px;

ยยยยย padding:14px;

ยยยยย box-shadow:var(--shadow);

ยยยยย margin:12px 0;

ยยย }


ยยย .header{text-align:center}


ยยย /* โ LOGO "MONETA" */

ยยย .logo{

ยยยยย width:80px;height:80px;border-radius:999px;

ยยยยย background:linear-gradient(135deg,var(--logo1),var(--logo2));

ยยยยย margin:auto;

ยยยยย display:flex;align-items:center;justify-content:center;

ยยยยย color:#fff;font-family:'Bebas Neue';font-size:34px;

ยยยยย letter-spacing:2px;

ยยยยย cursor:pointer;

ยยยยย transform-style:preserve-3d;

ยยยยย will-change:transform;

ยยย }

ยยย .logo.spin{ animation: coinSpin 900ms ease-in-out; }

ยยย @keyframes coinSpin{

ยยยยย 0%{transform:rotateY(0deg)}

ยยยยย 50%{transform:rotateY(180deg)}

ยยยยย 100%{transform:rotateY(360deg)}

ยยย }


ยยย h1{

ยยยยย font-family:'Bebas Neue';

ยยยยย letter-spacing:2px;

ยยยยย font-size:48px;

ยยยยย margin:10px 0 0;

ยยยยย text-transform:uppercase;

ยยย }

ยยย .subtitle{color:var(--muted);font-size:14px}


ยยย .heroImgWrap{border-radius:16px;overflow:hidden}

ยยย .heroImgWrap img{

ยยยยย width:100%;

ยยยยย display:block;

ยยยยย max-height:360px;

ยยยยย object-fit:cover;

ยยย }

ยยย @media(max-width:600px){

ยยยยย .heroImgWrap img{max-height:240px}

ยยย }

ยยย .heroCaption{

ยยยยย margin-top:10px;

ยยยยย text-align:center;

ยยยยย font-family:'Bebas Neue';

ยยยยย letter-spacing:3px;

ยยยยย font-size:26px;

ยยยยย font-weight:900;

ยยยยย text-transform:uppercase;

ยยย }


ยยย .line{margin-top:8px}

ยยย .pill{

ยยยยย display:inline-block;

ยยยยย background:var(--pill);

ยยยยย border-radius:999px;

ยยยยย padding:6px 10px;

ยยยยย margin:4px 6px 0 0;

ยยยยย font-weight:900;

ยยยยย border:1px solid var(--border);

ยยย }

ยยย .badge{

ยยยยย display:inline-block;

ยยยยย background:#111;

ยยยยย color:#fff;

ยยยยย padding:6px 12px;

ยยยยย border-radius:999px;

ยยยยย font-weight:900;

ยยย }

ยยย body.dark .badge{background:#0b0e14}

ยยย .muted{color:var(--muted)}


ยยย .mapWrap{

ยยยยย margin-top:12px;

ยยยยย border-radius:12px;

ยยยยย overflow:hidden;

ยยยยย border:1px solid var(--border)

ยยย }

ยยย iframe{width:100%;height:260px;border:0}


ยยย .mapActions{

ยยยยย display:flex;

ยยยยย justify-content:flex-end;

ยยยยย gap:10px;

ยยยยย margin-top:10px;

ยยยยย flex-wrap:wrap;

ยยย }

ยยย .btn{

ยยยยย border:0;

ยยยยย background:var(--btn);

ยยยยย color:#fff;

ยยยยย padding:12px 14px;

ยยยยย border-radius:14px;

ยยยยย font-weight:900;

ยยยยย cursor:pointer;

ยยยยย text-decoration:none;

ยยยยย display:inline-flex;

ยยยยย align-items:center;

ยยยยย gap:8px;

ยยยยย user-select:none;

ยยย }

ยยย .btn.ghost{

ยยยยย background:transparent;

ยยยยย color:var(--text);

ยยยยย border:1px solid var(--border);

ยยย }


ยยย .nav{

ยยยยย display:flex;

ยยยยย justify-content:space-between;

ยยยยย gap:10px;

ยยยยย flex-wrap:wrap;

ยยยยย font-size:14px;

ยยย }

ยยย .nav a{color:var(--text);text-decoration:none;font-weight:800}


ยยย .fab{

ยยยยย position:fixed;

ยยยยย right:16px;bottom:16px;

ยยยยย width:54px;height:54px;

ยยยยย border-radius:999px;

ยยยยย border:1px solid var(--border);

ยยยยย background:var(--card);

ยยยยย box-shadow:var(--shadow);

ยยยยย cursor:pointer;

ยยยยย font-size:22px;

ยยย }


ยยย .kit{display:inline-flex;align-items:center;gap:6px}

ยยย .kit svg{width:18px;height:18px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.25))}


ยยย /* MVP box */

ยยย .mvpBox{

ยยยยย margin-top:12px;

ยยยยย padding:12px;

ยยยยย border:1px solid var(--border);

ยยยยย border-radius:14px;

ยยยยย background:rgba(0,0,0,.02);

ยยย }

ยยย body.dark .mvpBox{background:rgba(255,255,255,.03)}

ยยย .mvpTitle{

ยยยยย font-weight:900;

ยยยยย display:flex;

ยยยยย align-items:center;

ยยยยย justify-content:space-between;

ยยยยย gap:10px;

ยยยยย flex-wrap:wrap;

ยยย }

ยยย .mvpMainRow{

ยยยยย display:flex;

ยยยยย align-items:center;

ยยยยย gap:10px;

ยยยยย margin-top:10px;

ยยย }

ยยย .mvpAvatar{

ยยยยย width:48px;height:48px;border-radius:999px;

ยยยยย border:1px solid var(--border);

ยยยยย object-fit:cover;

ยยยยย background:#000;

ยยยยย flex:0 0 auto;

ยยย }

ยยย .mvpText{font-weight:900}

ยยย .mvpSub{color:var(--muted);font-weight:800;font-size:13px;margin-top:2px}

ยยย .mvpTop3{margin-top:10px}


ยยย .mvpRow{

ยยยยย display:flex;align-items:center;justify-content:space-between;

ยยยยย border:1px solid var(--border);

ยยยยย border-radius:12px;

ยยยยย padding:8px 10px;

ยยยยย background:transparent;

ยยยยย margin-top:8px;

ยยยยย font-weight:800;

ยยย }

ยยย .mvpLeft{display:flex;align-items:center;gap:10px}

ยยย .medal{

ยยยยย width:28px;height:28px;border-radius:999px;

ยยยยย display:flex;align-items:center;justify-content:center;

ยยยยย border:1px solid var(--border);

ยยยยย background:var(--card);

ยยยยย font-weight:900;

ยยย }


ยยย /* โ METEO */

ยยย .weatherBox{

ยยยยย margin-top:12px;

ยยยยย padding:12px;

ยยยยย border:1px solid var(--border);

ยยยยย border-radius:14px;

ยยยยย background:rgba(0,0,0,.02);

ยยย }

ยยย body.dark .weatherBox{background:rgba(255,255,255,.03)}

ยยย .weatherHead{

ยยยยย display:flex;align-items:center;justify-content:space-between;

ยยยยย gap:10px;flex-wrap:wrap;font-weight:900;

ยยย }

ยยย .weatherBig{font-size:46px;line-height:1;margin-top:8px;text-align:center}

ยยย .weatherLine{margin-top:8px;font-weight:900;text-align:center}

ยยย .weatherMini{margin-top:6px;text-align:center;color:var(--muted);font-size:13px;font-weight:700}

ยยย .alertPill{

ยยยยย display:inline-block;border-radius:999px;padding:7px 10px;

ยยยยย font-weight:900;border:1px solid var(--border);margin:0;

ยยย }

ยยย .alert-ok{ background:var(--okBg); color:var(--okText); border-color:var(--okBd); }

ยยย .alert-warn{ background:var(--warnBg); color:var(--warnText); border-color:var(--warnBd); }

ยยย .alert-risk{ background:var(--riskBg); color:var(--riskText); border-color:var(--riskBd); }


ยยย /* โ Players pills with avatars */

ยยย .playersWrap{margin-top:6px}

ยยย .playerPill{

ยยยยย display:inline-flex;

ยยยยย align-items:center;

ยยยยย gap:10px;

ยยยยย padding:8px 10px;

ยยยยย border-radius:999px;

ยยยยย border:1px solid var(--border);

ยยยยย background:var(--pill);

ยยยยย margin:6px 8px 0 0;

ยยยยย max-width:100%;

ยยย }

ยยย .playerAvatar{

ยยยยย width:42px;height:42px;border-radius:999px;

ยยยยย border:1px solid var(--border);

ยยยยย object-fit:cover;

ยยยยย background:#000;

ยยยยย flex:0 0 auto;

ยยย }

ยยย .playerTxt{display:flex;flex-direction:column;line-height:1.1;min-width:0}

ยยย .playerName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

ยยย .playerPos{font-size:12px;font-weight:800;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}


ยยย /* โ FORMazioni header (GK VS GK) */

ยยย .formationsHead{

ยยยยย margin-top:12px;

ยยยยย padding:12px;

ยยยยย border:1px solid var(--border);

ยยยยย border-radius:16px;

ยยยยย background:rgba(0,0,0,.02);

ยยย }

ยยย body.dark .formationsHead{background:rgba(255,255,255,.03)}

ยยย .formationsTitle{

ยยยยย font-family:'Bebas Neue';

ยยยยย letter-spacing:2px;

ยยยยย font-size:26px;

ยยยยย margin:0 0 10px 0;

ยยยยย text-transform:uppercase;

ยยยยย text-align:center;

ยยย }

ยยย .vsRow{

ยยยยย display:flex;align-items:center;justify-content:space-between;

ยยยยย gap:10px;flex-wrap:wrap;

ยยย }

ยยย .gkChip{

ยยยยย display:flex;align-items:center;gap:10px;

ยยยยย border:1px solid var(--border);

ยยยยย border-radius:999px;

ยยยยย padding:8px 10px;

ยยยยย background:var(--card);

ยยยยย flex:1 1 240px;

ยยยยย min-width:240px;

ยยย }

ยยย .gkAvatar{

ยยยยย width:54px;height:54px;border-radius:999px;

ยยยยย border:1px solid var(--border);

ยยยยย object-fit:cover;

ยยยยย background:#000;

ยยย }

ยยย .gkTxt{display:flex;flex-direction:column;line-height:1.1;min-width:0}

ยยย .gkName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

ยยย .gkNote{font-size:12px;font-weight:900;color:var(--muted)}

ยยย .vsBadge{

ยยยยย font-family:'Bebas Neue';

ยยยยย letter-spacing:2px;

ยยยยย font-size:30px;

ยยยยย padding:6px 10px;

ยยยยย border-radius:14px;

ยยยยย border:1px solid var(--border);

ยยยยย background:var(--card);

ยยยยย font-weight:900;

ยยยยย flex:0 0 auto;

ยยย }


ยยย /* โ glove entrance animation */

ยยย .glove{

ยยยยย display:inline-block;

ยยยยย margin-left:6px;

ยยยยย transform:translateY(-6px) scale(.9);

ยยยยย opacity:0;

ยยยยย animation: gloveIn 650ms ease-out forwards;

ยยย }

ยยย @keyframes gloveIn{

ยยยยย 0%{transform:translateY(-10px) scale(.7);opacity:0}

ยยยยย 55%{transform:translateY(2px) scale(1.12);opacity:1}

ยยยยย 100%{transform:translateY(0) scale(1);opacity:1}

ยยย }

ย </style>

</head>


<body>

<div class="wrap">


ย <!-- HEADER -->

ย <div class="header">

ยยย <div id="logoCoin" class="logo" title="Tocca per girare ๐ช">QDP</div>

ยยย <h1>Quelli della pensione</h1>

ยยย <div class="subtitle">Ogni maledetto giovedรฌ โข Ore 21 โข Campo a 6 Aradeo</div>

ย </div>


ย <!-- HERO -->

ย <div class="card">

ยยย <div class="heroImgWrap">

ยยยยย <img src="foto.jpg" alt="Quelli della pensione">

ยยย </div>

ยยย <div class="heroCaption">OGNI MALEDETTO GIOVEDร</div>

ย </div>


ย <!-- PARTITA -->

ย <div class="card">

ยยย <div id="status" class="muted">Caricamentoโฆ</div>

ยยย <div id="info"></div>


ยยย <!-- MVP -->

ยยย <div id="mvpBox" class="mvpBox" style="display:none">

ยยยยย <div class="mvpTitle">

ยยยยยยย <div id="mvpTitle">๐ MVP</div>

ยยยยยยย <div id="mvpStatePill" class="pill" style="margin:0"></div>

ยยยยย </div>


ยยยยย <div class="mvpMainRow">

ยยยยยยย <img id="mvpAvatar" class="mvpAvatar" src="avatars/default.png" alt="mvp">

ยยยยยยย <div>

ยยยยยยยยย <div id="mvpMain" class="mvpText">Caricamentoโฆ</div>

ยยยยยยยยย <div id="mvpSub" class="mvpSub"></div>

ยยยยยยย </div>

ยยยยย </div>


ยยยยย <div id="mvpTop3" class="mvpTop3" style="display:none"></div>

ยยย </div>


ยยย <!-- MAPPA -->

ยยย <div id="mapBox" class="mapWrap" style="display:none">

ยยยยย <iframe

ยยยยยยย id="mapFrame"

ยยยยยยย loading="lazy"

ยยยยยยย referrerpolicy="no-referrer-when-downgrade"

ยยยยยยย src="https://www.google.com/maps?q=40.1239395,18.1203671&z=18&output=embed">

ยยยยย </iframe>

ยยย </div>


ยยย <div id="mapActions" class="mapActions" style="display:none">

ยยยยย <a id="mapLink" class="btn" href="#" target="_blank" rel="noopener">๐ Portami al campo</a>

ยยยยย <a id="mapOpen" class="btn ghost" href="#" target="_blank" rel="noopener">๐บ Apri su Maps</a>

ยยย </div>


ยยย <!-- METEO -->

ยยย <div id="weatherBox" class="weatherBox" style="display:none">

ยยยยย <div class="weatherHead">

ยยยยยยย <div>๐ค Meteo partita</div>

ยยยยยยย <span id="weatherAlert" class="alertPill">โ</span>

ยยยยย </div>

ยยยยย <div id="weatherBig" class="weatherBig">โณ</div>

ยยยยย <div id="weatherLine" class="weatherLine">Caricamento meteoโฆ</div>

ยยยยย <div id="weatherMini" class="weatherMini"></div>

ยยย </div>


ยยย <!-- MARCATORI -->

ยยย <div id="scorersBox" style="display:none;margin-top:12px">

ยยยยย <div class="line"><b>โฝ Marcatori</b></div>

ยยยยย <div id="scorersText" class="muted"></div>

ยยย </div>


ยยย <!-- CONVOCATI -->

ยยย <div class="line"><b>Convocati</b></div>

ยยย <div id="called" class="playersWrap muted">โ</div>


ยยย <!-- FORMAZIONI HEAD -->

ยยย <div id="formationsHead" class="formationsHead" style="display:none">

ยยยยย <div class="formationsTitle">FORMAZIONI</div>

ยยยยย <div class="vsRow">

ยยยยยยย <div class="gkChip">

ยยยยยยยยย <img id="gkAAvatar" class="gkAvatar" src="avatars/default.png" alt="GK A">

ยยยยยยยยย <div class="gkTxt">

ยยยยยยยยยยย <div id="gkAName" class="gkName">โ</div>

ยยยยยยยยยยย <div class="gkNote">Portiere <span class="glove">๐งค</span></div>

ยยยยยยยยย </div>

ยยยยยยย </div>


ยยยยยยย <div class="vsBadge">VS</div>


ยยยยยยย <div class="gkChip" style="justify-content:flex-end;text-align:right">

ยยยยยยยยย <div class="gkTxt" style="align-items:flex-end">

ยยยยยยยยยยย <div id="gkBName" class="gkName">โ</div>

ยยยยยยยยยยย <div class="gkNote">Portiere <span class="glove">๐งค</span></div>

ยยยยยยยยย </div>

ยยยยยยยยย <img id="gkBAvatar" class="gkAvatar" src="avatars/default.png" alt="GK B">

ยยยยยยย </div>

ยยยยย </div>

ยยย </div>


ยยย <!-- TEAMS -->

ยยย <div id="teamsBox" style="display:none;margin-top:12px">

ยยยยย <div class="line kit"><span id="tAIcon"></span><b>Squadra A</b></div>

ยยยยย <div id="teamA" class="playersWrap muted"></div>


ยยยยย <div class="line kit" style="margin-top:10px"><span id="tBIcon"></span><b>Squadra B</b></div>

ยยยยย <div id="teamB" class="playersWrap muted"></div>

ยยย </div>

ย </div>


ย <!-- NAV -->

ย <div class="card nav muted">

ยยย <a href="storico.html">๐ Storico</a>

ยยย <a href="marcatori.html">โฝ Marcatori</a>

ยยย <a href="mvp.html">๐ Vota MVP</a>

ยยย <a href="foto.html">๐ธ Foto</a>

ยยย <a href="componenti.html">๐ฅ Componenti</a>

ยยย <a href="admin.html">๐ Admin</a>

ย </div>


</div>


<button id="themeToggle" class="fab">๐</button>


<script src="config.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>


<script>

/* THEME */

const themeBtn = document.getElementById("themeToggle");

function setTheme(mode){

ย document.body.classList.toggle("dark", mode === "dark");

ย themeBtn.textContent = (mode === "dark") ? "โ๏ธ" : "๐";

ย localStorage.setItem("qdp_theme", mode);

}

setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");

themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");


/* LOGO MONETA */

const logoCoin = document.getElementById("logoCoin");

function spinLogo(){

ย logoCoin.classList.remove("spin");

ย void logoCoin.offsetWidth;

ย logoCoin.classList.add("spin");

}

logoCoin.addEventListener("click", spinLogo);

logoCoin.addEventListener("touchstart", spinLogo, {passive:true});


/* SUPABASE */

if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){

ย alert("config.js non caricato o non valido");

ย throw new Error("Missing config");

}

const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


/* DOM */

const statusEl = document.getElementById("status");

const infoEl = document.getElementById("info");

const calledEl = document.getElementById("called");


const mapBox = document.getElementById("mapBox");

const mapFrame = document.getElementById("mapFrame");

const mapActions = document.getElementById("mapActions");

const mapLink = document.getElementById("mapLink");

const mapOpen = document.getElementById("mapOpen");


const scorersBox = document.getElementById("scorersBox");

const scorersText = document.getElementById("scorersText");


const teamsBox = document.getElementById("teamsBox");

const teamAEl = document.getElementById("teamA");

const teamBEl = document.getElementById("teamB");

const tAIcon = document.getElementById("tAIcon");

const tBIcon = document.getElementById("tBIcon");


const formationsHead = document.getElementById("formationsHead");

const gkAAvatar = document.getElementById("gkAAvatar");

const gkBAvatar = document.getElementById("gkBAvatar");

const gkAName = document.getElementById("gkAName");

const gkBName = document.getElementById("gkBName");


/* MVP DOM */

const mvpBox = document.getElementById("mvpBox");

const mvpTitle = document.getElementById("mvpTitle");

const mvpStatePill = document.getElementById("mvpStatePill");

const mvpAvatar = document.getElementById("mvpAvatar");

const mvpMain = document.getElementById("mvpMain");

const mvpSub = document.getElementById("mvpSub");

const mvpTop3 = document.getElementById("mvpTop3");


/* METEO DOM */

const weatherBox = document.getElementById("weatherBox");

const weatherBig = document.getElementById("weatherBig");

const weatherLine = document.getElementById("weatherLine");

const weatherMini = document.getElementById("weatherMini");

const weatherAlert = document.getElementById("weatherAlert");


/* MAP */

const FIXED_MAP_APP_URL = "https://maps.app.goo.gl/SfZ5e8wr9qXLVn826";

const FIELD_LAT = 40.1239395;

const FIELD_LNG = 18.1203671;


/* AVATAR PATH */

const AVATAR_BASE = "avatars/";

const DEFAULT_AVATAR = "default.png";


function avatarUrl(filename){

ย const f = String(filename || "").trim();

ย return AVATAR_BASE + (f ? f : DEFAULT_AVATAR);

}


/* HELPERS */

function kitSVG(main, stripe){

ย return `

ย <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">

ยยย <path d="M18 12 L26 6 H38 L46 12 L58 20 L52 33 L46 29 V58 H18 V29 L12 33 L6 20 Z"

ยยยยย fill="${main}" stroke="rgba(0,0,0,.35)" stroke-width="2"/>

ยยย <path d="M30 10 H34 V58 H30 Z" fill="${stripe}" opacity="0.85"/>

ย </svg>`;

}

function formatDateFull(iso){

ย try{

ยยย return new Date(iso).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

ย }catch(e){ return String(iso||""); }

}

function escapeHtml(s){

ย return String(s ?? "")

ยยย .replaceAll("&","&amp;")

ยยย .replaceAll("<","&lt;")

ยยย .replaceAll(">","&gt;")

ยยย .replaceAll('"',"&quot;")

ยยย .replaceAll("'","&#039;");

}

function medal(i){

ย if(i===0) return "๐ฅ";

ย if(i===1) return "๐ฅ";

ย if(i===2) return "๐ฅ";

ย return String(i+1);

}

function normName(s){

ย return String(s||"").trim().toLowerCase().replace(/\s+/g," ");

}

function isGK(player){

ย const r = String(player?.role||"").toLowerCase();

ย const p = String(player?.position||"").toLowerCase();

ย return r === "gk" || p.includes("port");

}

function gkNameWithGlove(player){

ย const n = player?.name || "";

ย return `${escapeHtml(n)}<span class="glove">๐งค</span>`;

}


/* Stato votazione: APERTA se almeno una colonna รจ true */

function isVoteOpen(match){

ย return (match?.vote_open === true) || (match?.voting_open === true);

}


/* MAP LINKS */

function setupMapLinks(){

ย mapLink.href = FIXED_MAP_APP_URL;

ย mapOpen.href = `https://www.google.com/maps?q=${FIELD_LAT},${FIELD_LNG}`;

}


/* METEO (Open-Meteo) */

function wxEmojiFromCode(code){

ย const c = Number(code);

ย if(c === 0) return "โ๏ธ";

ย if(c === 1) return "๐ค๏ธ";

ย if(c === 2) return "โ";

ย if(c === 3) return "โ๏ธ";

ย if([45,48].includes(c)) return "๐ซ๏ธ";

ย if([51,53,55].includes(c)) return "๐ฆ๏ธ";

ย if([56,57,61,63,65,66,67,80,81,82].includes(c)) return "๐ง๏ธ";

ย if([71,73,75,77].includes(c)) return "โ๏ธ";

ย if([95,96,99].includes(c)) return "โ๏ธ";

ย return "๐ฅ๏ธ";

}

function wxTextFromCode(code){

ย const c = Number(code);

ย if(c === 0) return "Sereno";

ย if(c === 1) return "Quasi sereno";

ย if(c === 2) return "Parzialmente nuvoloso";

ย if(c === 3) return "Nuvoloso";

ย if([45,48].includes(c)) return "Nebbia";

ย if([51,53,55].includes(c)) return "Pioviggine";

ย if([56,57].includes(c)) return "Pioggia gelata";

ย if([61,63,65].includes(c)) return "Pioggia";

ย if([66,67].includes(c)) return "Pioggia gelata";

ย if([71,73,75,77].includes(c)) return "Neve";

ย if([80,81,82].includes(c)) return "Rovesci";

ย if([95,96,99].includes(c)) return "Temporale";

ย return "Variabile";

}

function riskLevel({code, precipProb, wind, temp}){

ย const c = Number(code);

ย const pp = Number(precipProb ?? 0);

ย const w = Number(wind ?? 0);

ย const t = Number(temp ?? 0);


ย const isThunder = [95,96,99].includes(c);

ย const isSnow = [71,73,75,77].includes(c);

ย const isHeavyRain = [65,67,82].includes(c);


ย if(isThunder || isSnow || isHeavyRain || pp >= 70 || w >= 55) return "risk";

ย if(pp >= 35 || w >= 35 || t <= 4 || t >= 33) return "warn";

ย return "ok";

}

function setWeatherAlert(level, text){

ย weatherAlert.className = "alertPill " + (level==="ok" ? "alert-ok" : level==="warn" ? "alert-warn" : "alert-risk");

ย weatherAlert.textContent = text;

}

async function loadWeather(matchDateISO, matchTimeStr){

ย weatherBox.style.display = "block";

ย weatherBig.textContent = "โณ";

ย weatherLine.textContent = "Caricamento meteoโฆ";

ย weatherMini.textContent = "";

ย setWeatherAlert("warn","ATTENDIโฆ");


ย try{

ยยย const hhmm = String(matchTimeStr||"21:00").slice(0,5);

ยยย const target = `${matchDateISO}T${hhmm}`;


ยยย const url =

ยยยยย "https://api.open-meteo.com/v1/forecast" +

ยยยยย `?latitude=${encodeURIComponent(FIELD_LAT)}` +

ยยยยย `&longitude=${encodeURIComponent(FIELD_LNG)}` +

ยยยยย "&hourly=temperature_2m,precipitation_probability,windspeed_10m,weathercode" +

ยยยยย "&timezone=Europe%2FRome";


ยยย const res = await fetch(url, {cache:"no-store"});

ยยย if(!res.ok) throw new Error("Meteo non disponibile");

ยยย const j = await res.json();


ยยย const times = j?.hourly?.time || [];

ยยย if(!times.length) throw new Error("Dati meteo vuoti");


ยยย let bestIdx = 0;

ยยย let bestDiff = Infinity;

ยยย const targetMs = new Date(target).getTime();


ยยย for(let i=0;i<times.length;i++){

ยยยยย const ms = new Date(times[i]).getTime();

ยยยยย const diff = Math.abs(ms - targetMs);

ยยยยย if(diff < bestDiff){

ยยยยยยย bestDiff = diff;

ยยยยยยย bestIdx = i;

ยยยยย }

ยยย }


ยยย const temp = j.hourly.temperature_2m?.[bestIdx];

ยยย const pp = j.hourly.precipitation_probability?.[bestIdx];

ยยย const wind = j.hourly.windspeed_10m?.[bestIdx];

ยยย const code = j.hourly.weathercode?.[bestIdx];


ยยย const emoji = wxEmojiFromCode(code);

ยยย const desc = wxTextFromCode(code);

ยยย const lvl = riskLevel({code, precipProb: pp, wind, temp});


ยยย if(lvl === "ok"){

ยยยยย setWeatherAlert("ok","โ OK");

ยยยยย weatherLine.textContent = `Condizioni buone per giocare. ${emoji} ${desc}`;

ยยย }else if(lvl === "warn"){

ยยยยย setWeatherAlert("warn","โ๏ธ ATTENZIONE");

ยยยยย weatherLine.textContent = `${emoji} ${desc} โข Occhio alle condizioni`;

ยยย }else{

ยยยยย setWeatherAlert("risk","โ RISCHIO PARTITA");

ยยยยย weatherLine.textContent = `${emoji} ${desc} โข Possibile partita a rischio`;

ยยย }


ยยย weatherBig.textContent = emoji;

ยยย weatherMini.textContent = `๐ก ${Math.round(temp)}ยฐCย โขย ๐ง ${pp}%ย โขย ๐จ ${Math.round(wind)} km/hย โขย โฐ ${hhmm}`;

ย }catch(e){

ยยย console.error(e);

ยยย weatherBox.style.display = "block";

ยยย weatherBig.textContent = "๐ฆ๏ธ";

ยยย setWeatherAlert("warn","โ๏ธ METEO");

ยยย weatherLine.textContent = "Meteo non disponibile al momento.";

ยยย weatherMini.textContent = "";

ย }

}


/* MVP */

async function loadMVP(matchId, playersById){

ย try{

ยยย const { data: votes, error } = await client

ยยยยย .from("mvp_votes")

ยยยยย .select("voted_player")

ยยยยย .eq("match_id", matchId);


ยยย if(error) throw error;


ยยย const counts = new Map();

ยยย (votes||[]).forEach(v=>{

ยยยยย const id = String(v.voted_player || "");

ยยยยย if(!id) return;

ยยยยย counts.set(id, (counts.get(id)||0) + 1);

ยยย });


ยยย if(counts.size === 0){

ยยยยย mvpMain.textContent = "Nessun voto ancora.";

ยยยยย mvpSub.textContent = "";

ยยยยย mvpAvatar.src = avatarUrl(DEFAULT_AVATAR);

ยยยยย mvpTop3.style.display = "none";

ยยยยย return;

ยยย }


ยยย const rows = [...counts.entries()]

ยยยยย .map(([id,c])=>{

ยยยยยยย const p = playersById.get(String(id));

ยยยยยยย return {

ยยยยยยยยย id,

ยยยยยยยยย name: p?.name || id,

ยยยยยยยยย avatar: p?.avatar || DEFAULT_AVATAR,

ยยยยยยยยย votes: c

ยยยยยยย };

ยยยยย })

ยยยยย .sort((a,b)=> b.votes - a.votes || String(a.name).localeCompare(String(b.name),"it"));


ยยย const topVotes = rows[0].votes;

ยยย const tops = rows.filter(r=>r.votes===topVotes);


ยยย if(tops.length === 1){

ยยยยย mvpAvatar.src = avatarUrl(tops[0].avatar);

ยยยยย mvpMain.textContent = `${tops[0].name}`;

ยยยยย mvpSub.textContent = `${topVotes} voto/i`;

ยยย }else{

ยยยยย // paritร: avatar del primo ma testo paritร

ยยยยย mvpAvatar.src = avatarUrl(tops[0].avatar);

ยยยยย mvpMain.textContent = `Paritร: ${tops.map(t=>t.name).join(", ")}`;

ยยยยย mvpSub.textContent = `${topVotes} voto/i`;

ยยย }


ยยย const top3 = rows.slice(0,3);

ยยย mvpTop3.innerHTML = top3.map((r,i)=>`

ยยยยย <div class="mvpRow">

ยยยยยยย <div class="mvpLeft">

ยยยยยยยยย <div class="medal">${escapeHtml(medal(i))}</div>

ยยยยยยยยย <img class="mvpAvatar" style="width:36px;height:36px" src="${escapeHtml(avatarUrl(r.avatar))}" alt="">

ยยยยยยยยย <div>${escapeHtml(r.name)}</div>

ยยยยยยย </div>

ยยยยยยย <div>${r.votes}</div>

ยยยยย </div>

ยยย `).join("");

ยยย mvpTop3.style.display = "block";


ย }catch(e){

ยยย console.error(e);

ยยย mvpMain.textContent = "Errore MVP";

ยยย mvpSub.textContent = "";

ยยย mvpAvatar.src = avatarUrl(DEFAULT_AVATAR);

ยยย mvpTop3.style.display = "none";

ย }

}


/* Render player pill */

function renderPlayerPill(p){

ย const gk = isGK(p);

ย const nameHtml = gk ? (escapeHtml(p.name) + `<span class="glove">๐งค</span>`) : escapeHtml(p.name);

ย const pos = String(p.position||"").trim();

ย const posHtml = pos ? escapeHtml(pos) : "โ";


ย return `

ยยย <span class="playerPill">

ยยยยย <img class="playerAvatar" src="${escapeHtml(avatarUrl(p.avatar))}" alt="">

ยยยยย <span class="playerTxt">

ยยยยยยย <span class="playerName">${nameHtml}</span>

ยยยยยยย <span class="playerPos">${posHtml}</span>

ยยยยย </span>

ยยย </span>

ย `;

}

function handleMatchEnded(m) {

ย // โ Nascondo meteo

ย if (weatherBox) weatherBox.style.display = "none";


ย // โ Nascondo convocati

ย if (calledEl) calledEl.style.display = "none";

ย if (calledTitleEl) calledTitleEl.style.display = "none";


ย // โ Mostro formazioni e squadre

ย if (formationsHead) formationsHead.style.display = "block";

ย if (teamsBox) teamsBox.style.display = "block";


ย // ๐ Fischio finale (una sola volta)

ย if (!window.__whistlePlayed) {

ยยย window.__whistlePlayed = true;

ยยย try {

ยยยยย finalWhistle.currentTime = 0;

ยยยยย finalWhistle.play().catch(()=>{});

ยยย } catch(e){}

ย }

}


ย // Stato partita

ย statusEl.textContent = "๐ PARTITA TERMINATA";

}

async function load(){

ย const { data, error } = await client

ยยย .from("matches")

ยยย .select("id,match_date,match_time,venue,keeper_a,keeper_b,score_a,score_b,called_up,team_a,team_b,scorers_text,vote_open,voting_open")

ยยย .order("match_date",{ascending:false})

ยยย .order("match_time",{ascending:false})

ยยย .limit(1);


ย if(error){

ยยย statusEl.textContent = "Errore caricamento partita";

ยยย infoEl.innerHTML = `<div class="muted">${escapeHtml(error.message)}</div>`;

ยยย weatherBox.style.display = "none";

ยยย return;

ย }


ย if(!data || !data.length){

ยยย statusEl.textContent = "Nessuna partita creata";

ยยย weatherBox.style.display = "none";

ยยย mapBox.style.display = "none";

ยยย mapActions.style.display = "none";

ยยย mvpBox.style.display = "none";

ยยย formationsHead.style.display = "none";

ยยย teamsBox.style.display = "none";

ยยย calledEl.textContent = "โ";

ยยย return;

ย }


ย const m = data[0];

statusEl.textContent = "Partita trovata โ";


// โ Se esiste il risultato โ partita terminata (nascondi meteo+convocati + fischio)

if (m.score_a !== null && m.score_b !== null) {

ย handleMatchEnded(m);

}


ย const time = String(m.match_time||"").slice(0,5);

ย const result = (m.score_a!=null && m.score_b!=null) ? `${m.score_a}-${m.score_b}` : "da giocare";

ย const voteOpen = isVoteOpen(m);


ย // MVP UI

ย mvpBox.style.display = "block";

ย mvpTitle.textContent = voteOpen ? "๐ MVP (provvisorio)" : "๐ MVP (finale)";

ย mvpStatePill.textContent = voteOpen ? "๐ข Votazione aperta" : "๐ด Votazione chiusa";

ย mvpMain.textContent = "Caricamentoโฆ";

ย mvpSub.textContent = "";

ย mvpAvatar.src = avatarUrl(DEFAULT_AVATAR);

ย mvpTop3.style.display = "none";


ย infoEl.innerHTML = `

ยยย <div class="line"><b>๐ ${escapeHtml(formatDateFull(m.match_date))}</b></div>

ยยย <div class="line"><b>โฐ ${escapeHtml(time)}</b></div>

ยยย <div class="line kit">${kitSVG("#facc15","#111")} <b>Squadra A:</b> ${escapeHtml(m.keeper_a || "")} <span class="glove">๐งค</span></div>

ยยย <div class="line kit">${kitSVG("#ef4444","#fff")} <b>Squadra B:</b> ${escapeHtml(m.keeper_b || "")} <span class="glove">๐งค</span></div>

ยยย <div class="line"><span class="badge">๐ ${escapeHtml(result)}</span></div>

ย `;


ย // Marcatori

ย if(m.scorers_text && String(m.scorers_text).trim() !== ""){

ยยย scorersBox.style.display="block";

ยยย scorersText.innerHTML = escapeHtml(m.scorers_text).replaceAll("\n","<br>");

ย }else{

ยยย scorersBox.style.display="none";

ย }


ย // MAPPA

ย mapBox.style.display = "block";

ย mapActions.style.display = "flex";

ย mapFrame.src = `https://www.google.com/maps?q=${FIELD_LAT},${FIELD_LNG}&z=18&output=embed`;

ย setupMapLinks();


ย // METEO (campo Aradeo)

ย await loadWeather(m.match_date, m.match_time);


ย // Carica players (convocati + squadre) per avere avatar/role/position

ย const calledIds = Array.isArray(m.called_up) ? m.called_up : [];

ย const teamAIds = Array.isArray(m.team_a) ? m.team_a : [];

ย const teamBIds = Array.isArray(m.team_b) ? m.team_b : [];


ย const allIds = [...new Set([...calledIds, ...teamAIds, ...teamBIds].map(String))];


ย let players = [];

ย if(allIds.length){

ยยย const { data:p, error:pe } = await client

ยยยยย .from("players")

ยยยยย .select("id,name,role,position,avatar")

ยยยยย .in("id", allIds);


ยยย if(!pe) players = p || [];

ย }


ย const playersById = new Map(players.map(p=>[String(p.id), p]));

ย const playersByName = new Map(players.map(p=>[normName(p.name), p]));


ย // Convocati (avatar + pos sotto + guanti solo GK)

ย if(calledIds.length){

ยยย const calledPlayers = calledIds

ยยยยย .map(id => playersById.get(String(id)))

ยยยยย .filter(Boolean);


ยยย calledEl.classList.remove("muted");

ยยย calledEl.innerHTML = calledPlayers.map(renderPlayerPill).join("");

ย }else{

ยยย calledEl.classList.add("muted");

ยยย calledEl.textContent = "โ";

ย }


ย // MVP con avatar

ย await loadMVP(m.id, playersById);


ย // Formazioni + Squadre

ย const hasTeams = teamAIds.length || teamBIds.length;

ย if(hasTeams){

ยยย teamsBox.style.display = "block";

ยยย tAIcon.innerHTML = kitSVG("#facc15","#111");

ยยย tBIcon.innerHTML = kitSVG("#ef4444","#fff");


ยยย const aPlayers = teamAIds.map(id=>playersById.get(String(id))).filter(Boolean);

ยยย const bPlayers = teamBIds.map(id=>playersById.get(String(id))).filter(Boolean);


handleMatchEnded(m, aPlayers, bPlayers);

ยยย teamAEl.classList.remove("muted");

ยยย teamBEl.classList.remove("muted");


ยยย teamAEl.innerHTML = aPlayers.length ? aPlayers.map(renderPlayerPill).join("") : `<span class="muted">โ</span>`;

ยยย teamBEl.innerHTML = bPlayers.length ? bPlayers.map(renderPlayerPill).join("") : `<span class="muted">โ</span>`;


ยยย // FORMATIONS HEAD: GK vs GK (prendo dal nome inserito in match keeper_a / keeper_b)

ยยย const ka = playersByName.get(normName(m.keeper_a)) || aPlayers.find(isGK) || players.find(isGK);

ยยย const kb = playersByName.get(normName(m.keeper_b)) || bPlayers.find(isGK) || players.find(isGK);


ยยย formationsHead.style.display = "block";

ยยย gkAAvatar.src = avatarUrl(ka?.avatar || DEFAULT_AVATAR);

ยยย gkBAvatar.src = avatarUrl(kb?.avatar || DEFAULT_AVATAR);


ยยย gkAName.innerHTML = ka ? (escapeHtml(ka.name) + `<span class="glove">๐งค</span>`) : "โ";

ยยย gkBName.innerHTML = kb ? (escapeHtml(kb.name) + `<span class="glove">๐งค</span>`) : "โ";


ย }else{

ยยย formationsHead.style.display = "none";

ยยย teamsBox.style.display = "none";

ย }

}

/* ===============================

ยย FIX RISULTATO PARTITA

ยย =============================== */


function handleMatchEnded(match, teamAPlayers, teamBPlayers){

ย const hasResult = match.score_a !== null && match.score_b !== null;


ย if(!hasResult) return;


ย // โ Nascondo meteo e convocati

ย if(weatherBox) weatherBox.style.display = "none";

ย if(calledEl) calledEl.style.display = "none";

ย if(calledTitleEl) calledTitleEl.style.display = "none";


ย // ๐ Fischio finale UNA SOLA VOLTA

ย if(!window.__whistlePlayed){

ยยย try{

ยยยยย finalWhistle.volume = 0.9;

ยยยยย finalWhistle.play().catch(()=>{});

ยยยยย window.__whistlePlayed = true;

ยยย }catch(e){}

ย }


ย // ๐งค PORTIERI CORRETTI (NON INVERTITI)

ย const gkA = teamAPlayers.find(p => isGK(p));

ย const gkB = teamBPlayers.find(p => isGK(p));


ย if(gkA){

ยยย gkAAvatar.src = avatarUrl(gkA.avatar);

ยยย gkAName.innerHTML = escapeHtml(gkA.name) + ' <span class="glove">๐งค</span>';

ย }


ย if(gkB){

ยยย gkBAvatar.src = avatarUrl(gkB.avatar);

ยยย gkBName.innerHTML = escapeHtml(gkB.name) + ' <span class="glove">๐งค</span>';

ย }

}

load();

</script>

</body>

</html>
