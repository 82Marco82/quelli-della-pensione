<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee; --logo1:#111; --logo2:#333; --btn:#111;
      --okBg:#dcfce7; --okText:#166534; --okBd:rgba(34,197,94,.35);
      --warnBg:#fff7ed; --warnText:#9a3412; --warnBd:rgba(249,115,22,.35);
      --riskBg:#ffe4e6; --riskText:#9f1239; --riskBd:rgba(244,63,94,.35);
      --danger:#b00020;
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
      --border:#2a2f3a; --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631; --logo1:#0b0e14; --logo2:#2a3242; --btn:#0b0e14;
      --okBg:rgba(34,197,94,.15); --okText:#86efac; --okBd:rgba(34,197,94,.35);
      --warnBg:rgba(249,115,22,.14); --warnText:#fdba74; --warnBd:rgba(249,115,22,.35);
      --riskBg:rgba(244,63,94,.16); --riskText:#fda4af; --riskBd:rgba(244,63,94,.35);
      --danger:#ff4d4d;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    .wrap{max-width:760px;margin:auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow);margin:12px 0}
    .header{text-align:center}

    .logo{
      width:80px;height:80px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      margin:auto;display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:34px;letter-spacing:2px;
      cursor:pointer;transform-style:preserve-3d;will-change:transform;
    }
    .logo.spin{ animation: coinSpin 900ms ease-in-out; }
    @keyframes coinSpin{0%{transform:rotateY(0deg)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}

    h1{font-family:'Bebas Neue';letter-spacing:2px;font-size:48px;margin:10px 0 0;text-transform:uppercase}
    .subtitle{color:var(--muted);font-size:14px}

    .heroImgWrap{border-radius:16px;overflow:hidden}
    .heroImgWrap img{width:100%;display:block;max-height:360px;object-fit:cover}
    @media(max-width:600px){ .heroImgWrap img{max-height:240px} }
    .heroCaption{margin-top:10px;text-align:center;font-family:'Bebas Neue';letter-spacing:3px;font-size:26px;font-weight:900;text-transform:uppercase}

    .line{margin-top:8px}
    .pill{display:inline-block;background:var(--pill);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-weight:900;border:1px solid var(--border)}
    .badge{display:inline-block;background:#111;color:#fff;padding:6px 12px;border-radius:999px;font-weight:900}
    body.dark .badge{background:#0b0e14}
    .muted{color:var(--muted)}

    .fab{position:fixed;right:16px;bottom:16px;width:54px;height:54px;border-radius:999px;border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);cursor:pointer;font-size:22px}

    /* players pills */
    .playersWrap{margin-top:6px}
    .playerPill{
      display:inline-flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:var(--pill);margin:6px 8px 0 0;max-width:100%;
    }
    .playerAvatar{width:42px;height:42px;border-radius:999px;border:1px solid var(--border);object-fit:cover;background:#000;flex:0 0 auto}
    .playerTxt{display:flex;flex-direction:column;line-height:1.1;min-width:0}
    .playerName{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .playerPos{font-size:12px;font-weight:800;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .glove{display:inline-block;margin-left:6px;transform:translateY(-6px) scale(.9);opacity:0;animation: gloveIn 650ms ease-out forwards;}
    @keyframes gloveIn{0%{transform:translateY(-10px) scale(.7);opacity:0}55%{transform:translateY(2px) scale(1.12);opacity:1}100%{transform:translateY(0) scale(1);opacity:1}}

    /* comments */
    .commentsBox{margin-top:14px;border-top:1px solid var(--border);padding-top:12px}
    .commentsTitle{
      font-family:'Bebas Neue';letter-spacing:2px;font-size:22px;margin:0 0 10px;
      text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .msg{
      margin-top:10px;padding:12px;border-radius:12px;font-size:13px;border:1px solid var(--border);
      background:rgba(0,0,0,.02);white-space:pre-wrap;
    }
    body.dark .msg{background:rgba(255,255,255,.03)}
    .msg.ok{background:var(--okBg);color:var(--okText);border-color:var(--okBd);font-weight:900}
    .msg.err{background:var(--riskBg);color:var(--riskText);border-color:var(--riskBd);font-weight:900}
    .msg.warn{background:var(--warnBg);color:var(--warnText);border-color:var(--warnBd);font-weight:900}

    textarea{
      width:100%;min-height:90px;resize:vertical;
      padding:12px;border-radius:12px;border:1px solid var(--border);
      background:transparent;color:var(--text);outline:none;font-family:Inter;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:0;background:var(--btn);color:#fff;padding:12px 14px;border-radius:14px;
      font-weight:900;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;user-select:none;
    }
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.danger{background:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .commentRow{border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin-top:10px}
    .commentTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .commentMeta{font-size:12px;color:var(--muted);font-weight:800}
    .commentText{margin-top:8px;font-weight:700;white-space:pre-wrap}

    /* Admin toggle (come in foto) */
    .adminBar{
      display:none;
      margin-top:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(0,0,0,.02);
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-weight:900;
    }
    body.dark .adminBar{background:rgba(255,255,255,.03)}
    .adminBar .mini{font-size:12px;color:var(--muted);font-weight:800}
    .togglePill{
      display:inline-flex;align-items:center;gap:10px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--pill);
    }
    .togglePill button{
      border:0;cursor:pointer;
      padding:8px 10px;border-radius:999px;
      font-weight:900;
      background:var(--btn);
      color:#fff;
    }
    .togglePill button.off{ background:var(--danger); }
  </style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div id="logoCoin" class="logo" title="Tocca per girare ü™ô">QDP</div>
    <h1>Quelli della pensione</h1>
    <div class="subtitle">Ogni maledetto gioved√¨ ‚Ä¢ Ore 21 ‚Ä¢ Campo a 6 Aradeo</div>
  </div>

  <div class="card">
    <div class="heroImgWrap">
      <img src="foto.jpg" alt="Quelli della pensione">
    </div>
    <div class="heroCaption">OGNI MALEDETTO GIOVED√å</div>
  </div>

  <div class="card">
    <div id="status" class="muted">Caricamento‚Ä¶</div>
    <div id="info"></div>

    <div id="scorersBox" style="display:none;margin-top:12px">
      <div class="line"><b>‚öΩ Marcatori</b></div>
      <div id="scorersText" class="muted"></div>
    </div>

    <div class="line"><b>Convocati</b></div>
    <div id="called" class="playersWrap muted">‚Äî</div>

    <!-- COMMENTI -->
    <div id="commentsBox" class="commentsBox" style="display:none">
      <div class="commentsTitle">
        <span>üî• COMMENTI A CALDO ‚Ä¢ PARTITA GIOCATA</span>
        <span id="commentsCount" class="pill" style="margin:0">0</span>
      </div>

      <!-- Admin ON/OFF -->
      <div id="adminBar" class="adminBar">
        <div>
          üõ° Modalit√† Admin: <span id="adminState">OFF</span>
          <div class="mini">Se ON puoi eliminare commenti.</div>
        </div>
        <div class="togglePill">
          <span id="adminBadge">OFF</span>
          <button id="btnToggleAdmin" class="off" type="button">Attiva</button>
        </div>
      </div>

      <div id="commentsMsg" class="msg" style="display:none"></div>

      <div id="authHint" class="msg warn" style="display:none">
        Devi essere loggato per commentare (Strada A). Vai su <b>Admin</b> e fai login.
      </div>

      <div id="formWrap" style="display:none">
        <textarea id="commentText" maxlength="600" placeholder="Scrivi un commento‚Ä¶ (max 600 caratteri)"></textarea>
        <div class="row">
          <button id="btnSend" class="btn" type="button">‚úÖ Pubblica</button>
          <button id="btnReload" class="btn ghost" type="button">üîÑ Aggiorna</button>
        </div>
      </div>

      <div id="commentsList"></div>
    </div>
  </div>

  <!-- NAV (senza storico) -->
  <div class="card" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)">
    <a href="marcatori.html" style="color:inherit;text-decoration:none;font-weight:800">‚öΩ Marcatori</a>
    <a href="mvp.html" style="color:inherit;text-decoration:none;font-weight:800">üèÜ Vota MVP</a>
    <a href="foto.html" style="color:inherit;text-decoration:none;font-weight:800">üì∏ Foto</a>
    <a href="componenti.html" style="color:inherit;text-decoration:none;font-weight:800">üë• Componenti</a>
    <a href="admin.html" style="color:inherit;text-decoration:none;font-weight:800">üîê Admin</a>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* THEME */
const themeBtn = document.getElementById("themeToggle");
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

/* LOGO */
const logoCoin = document.getElementById("logoCoin");
function spinLogo(){
  logoCoin.classList.remove("spin");
  void logoCoin.offsetWidth;
  logoCoin.classList.add("spin");
}
logoCoin.addEventListener("click", spinLogo);
logoCoin.addEventListener("touchstart", spinLogo, {passive:true});

/* SUPABASE */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* DOM */
const statusEl = document.getElementById("status");
const infoEl = document.getElementById("info");
const calledEl = document.getElementById("called");
const scorersBox = document.getElementById("scorersBox");
const scorersText = document.getElementById("scorersText");

/* COMMENTS DOM */
const commentsBox = document.getElementById("commentsBox");
const commentsList = document.getElementById("commentsList");
const commentsCount = document.getElementById("commentsCount");
const commentsMsg = document.getElementById("commentsMsg");
const authHint = document.getElementById("authHint");
const formWrap = document.getElementById("formWrap");
const commentText = document.getElementById("commentText");
const btnSend = document.getElementById("btnSend");
const btnReload = document.getElementById("btnReload");

/* Admin toggle DOM */
const adminBar = document.getElementById("adminBar");
const adminState = document.getElementById("adminState");
const adminBadge = document.getElementById("adminBadge");
const btnToggleAdmin = document.getElementById("btnToggleAdmin");

/* AVATARS */
const AVATAR_BASE = "avatars/";
const DEFAULT_AVATAR = "default.png";
function avatarUrl(filename){
  const f = String(filename || "").trim();
  return AVATAR_BASE + (f ? f : DEFAULT_AVATAR);
}

/* HELPERS */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function formatDateFull(iso){
  try{
    return new Date(iso).toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
  }catch(e){ return String(iso||""); }
}
function normName(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g," "); }
function isGK(player){
  const r = String(player?.role||"").toLowerCase();
  const p = String(player?.position||"").toLowerCase();
  return r === "gk" || p.includes("port");
}
function renderPlayerPill(p){
  const gk = isGK(p);
  const nameHtml = gk ? (escapeHtml(p.name) + `<span class="glove">üß§</span>`) : escapeHtml(p.name);
  const pos = String(p.position||"").trim();
  const posHtml = pos ? escapeHtml(pos) : "‚Äî";
  return `
    <span class="playerPill">
      <img class="playerAvatar" src="${escapeHtml(avatarUrl(p.avatar))}" alt="">
      <span class="playerTxt">
        <span class="playerName">${nameHtml}</span>
        <span class="playerPos">${posHtml}</span>
      </span>
    </span>
  `;
}

/* SESSION + ADMIN (Strada A) */
let SESSION = null;
let IS_ADMIN = false;
let ADMIN_MODE = false; // toggle ON/OFF
let CURRENT_MATCH_ID = null;

async function getSession(){
  const { data:{ session } } = await client.auth.getSession();
  return session || null;
}

/*
  ‚úÖ STRADA A: tabella admins con colonna "id" (uuid) = auth.uid()
  (non user_id)
*/
async function checkIsAdmin(userId){
  if(!userId) return false;
  const { data, error } = await client
    .from("admins")
    .select("id")
    .eq("id", userId)
    .maybeSingle();
  if(error) return false;
  return !!data;
}

/* Admin toggle UI */
function setAdminMode(on){
  ADMIN_MODE = !!on;
  localStorage.setItem("qdp_admin_mode_comments", ADMIN_MODE ? "1" : "0");

  adminState.textContent = ADMIN_MODE ? "ON" : "OFF";
  adminBadge.textContent = ADMIN_MODE ? "ON" : "OFF";
  btnToggleAdmin.textContent = ADMIN_MODE ? "Disattiva" : "Attiva";
  btnToggleAdmin.className = ADMIN_MODE ? "" : "off";
}

function initAdminBar(){
  if(!IS_ADMIN){
    adminBar.style.display = "none";
    ADMIN_MODE = false;
    return;
  }
  adminBar.style.display = "flex";
  const saved = localStorage.getItem("qdp_admin_mode_comments") === "1";
  setAdminMode(saved);
}

btnToggleAdmin.onclick = async ()=>{
  setAdminMode(!ADMIN_MODE);
  await loadComments(); // rerender con/senza cestini
};

/* COMMENTS UI */
function showMsg(text, kind){
  commentsMsg.style.display = "block";
  commentsMsg.className = "msg " + (kind || "");
  commentsMsg.textContent = text;
}
function hideMsg(){
  commentsMsg.style.display = "none";
  commentsMsg.textContent = "";
}
function shortId(id){
  const s = String(id||"");
  return (s.length <= 12) ? s : (s.slice(0,6) + "‚Ä¶" + s.slice(-4));
}

function renderComment(c){
  const created = c?.created_at ? new Date(c.created_at).toLocaleString("it-IT") : "";
  const who = c?.user_id ? ("utente " + shortId(c.user_id)) : "utente";

  const canDelete = IS_ADMIN && ADMIN_MODE;
  const delBtn = canDelete
    ? `<button class="btn danger" data-del="${escapeHtml(c.id)}" type="button">üóë Elimina</button>`
    : "";

  return `
    <div class="commentRow">
      <div class="commentTop">
        <div class="commentMeta">üïí ${escapeHtml(created)} ‚Ä¢ üë§ ${escapeHtml(who)}</div>
        ${delBtn}
      </div>
      <div class="commentText">${escapeHtml(c.text || "")}</div>
    </div>
  `;
}

async function loadComments(){
  if(!CURRENT_MATCH_ID) return;

  try{
    hideMsg();
    commentsList.innerHTML = `<div class="muted">Carico commenti‚Ä¶</div>`;

    const { data, error } = await client
      .from("match_comments")
      .select("id,match_id,user_id,text,created_at")
      .eq("match_id", CURRENT_MATCH_ID)
      .order("created_at", { ascending: false });

    if(error) throw error;

    const rows = data || [];
    commentsCount.textContent = String(rows.length);

    if(!rows.length){
      commentsList.innerHTML = `<div class="muted">Nessun commento ancora.</div>`;
      return;
    }

    commentsList.innerHTML = rows.map(renderComment).join("");

    // bind delete se attivo
    if(IS_ADMIN && ADMIN_MODE){
      [...commentsList.querySelectorAll("button[data-del]")].forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute("data-del");
          if(!id) return;
          if(!confirm("Eliminare questo commento?")) return;

          btn.disabled = true;
          try{
            const { error } = await client.from("match_comments").delete().eq("id", id);
            if(error) throw error;

            showMsg("‚úÖ Commento eliminato.", "ok");
            await loadComments();
          }catch(e){
            console.error(e);
            showMsg("‚ùå Errore eliminazione: " + (e.message || e), "err");
          }finally{
            btn.disabled = false;
          }
        };
      });
    }

  }catch(e){
    console.error(e);
    commentsList.innerHTML = `<div class="muted">‚Äî</div>`;
    showMsg("Errore caricamento commenti: " + (e.message || e), "err");
  }
}

async function sendComment(){
  const txt = String(commentText.value || "").trim();
  if(!txt) return showMsg("Scrivi un commento prima di pubblicare.", "warn");
  if(!CURRENT_MATCH_ID) return;

  if(!SESSION?.user?.id){
    return showMsg("Devi essere loggato per commentare (Strada A).", "warn");
  }

  btnSend.disabled = true;
  try{
    hideMsg();

    const payload = {
      match_id: CURRENT_MATCH_ID,
      user_id: SESSION.user.id,
      text: txt
    };

    const { error } = await client.from("match_comments").insert([payload]);
    if(error) throw error;

    commentText.value = "";
    showMsg("‚úÖ Commento pubblicato.", "ok");
    await loadComments();

  }catch(e){
    console.error(e);
    showMsg("‚ùå Errore invio commento: " + (e.message || e), "err");
  }finally{
    btnSend.disabled = false;
  }
}

btnSend.onclick = sendComment;
btnReload.onclick = loadComments;

/* LOAD MATCH */
async function load(){
  SESSION = await getSession();
  IS_ADMIN = await checkIsAdmin(SESSION?.user?.id);
  initAdminBar();

  const { data, error } = await client
    .from("matches")
    .select("id,match_date,match_time,venue,keeper_a,keeper_b,score_a,score_b,called_up,scorers_text")
    .order("match_date",{ascending:false})
    .order("match_time",{ascending:false})
    .limit(1);

  if(error){
    statusEl.textContent = "Errore caricamento partita";
    infoEl.innerHTML = `<div class="muted">${escapeHtml(error.message)}</div>`;
    return;
  }

  if(!data || !data.length){
    statusEl.textContent = "Nessuna partita creata";
    calledEl.textContent = "‚Äî";
    return;
  }

  const m = data[0];
  CURRENT_MATCH_ID = m.id;

  const time = String(m.match_time||"").slice(0,5);
  const played = (m.score_a!=null && m.score_b!=null);
  const result = played ? `${m.score_a}-${m.score_b}` : "da giocare";

  statusEl.textContent = "Partita trovata ‚úÖ";

  infoEl.innerHTML = `
    <div class="line"><b>üìÖ ${escapeHtml(formatDateFull(m.match_date))}</b></div>
    <div class="line"><b>‚è∞ ${escapeHtml(time)}</b></div>
    <div class="line"><b>ü•Ö Squadra A:</b> ${escapeHtml(m.keeper_a || "")} <span class="glove">üß§</span></div>
    <div class="line"><b>ü•Ö Squadra B:</b> ${escapeHtml(m.keeper_b || "")} <span class="glove">üß§</span></div>
    <div class="line"><span class="badge">üèÅ ${escapeHtml(result)}</span></div>
  `;

  if(m.scorers_text && String(m.scorers_text).trim() !== ""){
    scorersBox.style.display="block";
    scorersText.innerHTML = escapeHtml(m.scorers_text).replaceAll("\n","<br>");
  }else{
    scorersBox.style.display="none";
  }

  // Convocati con avatar/pos
  const calledIds = Array.isArray(m.called_up) ? m.called_up : [];
  const ids = [...new Set(calledIds.map(String))];

  let players = [];
  if(ids.length){
    const { data:p, error:pe } = await client
      .from("players")
      .select("id,name,role,position,avatar")
      .in("id", ids);
    if(!pe) players = p || [];
  }
  const byId = new Map(players.map(p=>[String(p.id), p]));

  if(calledIds.length){
    const calledPlayers = calledIds.map(id => byId.get(String(id))).filter(Boolean);
    calledEl.classList.remove("muted");
    calledEl.innerHTML = calledPlayers.map(renderPlayerPill).join("");
  }else{
    calledEl.classList.add("muted");
    calledEl.textContent = "‚Äî";
  }

  // COMMENTI solo se partita giocata
  if(played){
    commentsBox.style.display = "block";

    // admin bar solo se admin (gi√† gestito initAdminBar)
    // login required per scrivere
    if(SESSION?.user?.id){
      authHint.style.display = "none";
      formWrap.style.display = "block";
    }else{
      authHint.style.display = "block";
      formWrap.style.display = "none";
    }

    await loadComments();
  }else{
    commentsBox.style.display = "none";
  }
}

load();
</script>
</body>
</html>
