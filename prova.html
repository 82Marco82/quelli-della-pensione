<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quelli della Pensione</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#f4f6f8;
  color:#111;
}
.wrap{max-width:720px;margin:auto;padding:16px}
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  margin-bottom:16px;
}
h1{text-align:center;margin:8px 0;font-size:32px}
.subtitle{text-align:center;color:#666;font-size:14px}

.resultCard{
  border:1px solid #e5e7eb;
  border-radius:20px;
  padding:16px;
  text-align:center;
}
.resultHeader{
  font-weight:900;
  margin-bottom:12px;
}
.resultRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.resAvatar{
  width:64px;
  height:64px;
  border-radius:999px;
  object-fit:cover;
  border:1px solid #ddd;
}
.resScore{
  font-size:42px;
  font-weight:900;
}
.hidden{display:none}
</style>
</head>

<body>
<div class="wrap">

<h1>QUELLI DELLA PENSIONE</h1>
<div class="subtitle">Ogni maledetto gioved√¨ ‚Ä¢ Ore 21</div>

<div id="status" class="card">Caricamento‚Ä¶</div>

<!-- RISULTATO -->
<div id="resultCard" class="card resultCard hidden">
  <div class="resultHeader">üèÅ PARTITA TERMINATA</div>
  <div class="resultRow">
    <img id="avatarA" class="resAvatar">
    <div id="score" class="resScore">0 - 0</div>
    <img id="avatarB" class="resAvatar">
  </div>
</div>

<!-- CONVOCATI / METEO (spariscono) -->
<div id="extraBox" class="card">
  <b>Convocati & Meteo</b>
  <div class="subtitle">Visibili solo prima del risultato</div>
</div>

</div>

<audio id="whistle" src="final-whistle-1.mp3" preload="auto"></audio>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const statusEl = document.getElementById("status");
const resultCard = document.getElementById("resultCard");
const extraBox = document.getElementById("extraBox");
const scoreEl = document.getElementById("score");
const avatarA = document.getElementById("avatarA");
const avatarB = document.getElementById("avatarB");
const whistle = document.getElementById("whistle");

let whistlePlayed = false;

function avatar(file){
  return "avatars/" + (file || "default.png");
}

async function loadPage(){
  const { data: matches } = await client
    .from("matches")
    .select("*")
    .order("date", { ascending:false })
    .limit(1);

  if(!matches || !matches.length){
    statusEl.textContent = "Nessuna partita";
    return;
  }

  const m = matches[0];
  statusEl.textContent = "Partita trovata ‚úÖ";

  if(m.score_a !== null && m.score_b !== null){
    await showResult(m);
  }
}

async function showResult(match){
  const { data: teamA } = await client
    .from("team_a")
    .select("players(name,avatar,role)")
    .eq("match_id", match.id);

  const { data: teamB } = await client
    .from("team_b")
    .select("players(name,avatar,role)")
    .eq("match_id", match.id);

  const gkA = teamA.map(x=>x.players).find(p=>p.role==="GK");
  const gkB = teamB.map(x=>x.players).find(p=>p.role==="GK");

  avatarA.src = avatar(gkA?.avatar);
  avatarB.src = avatar(gkB?.avatar);
  scoreEl.textContent = `${match.score_a} - ${match.score_b}`;

  resultCard.classList.remove("hidden");
  extraBox.classList.add("hidden");

  if(!whistlePlayed){
    whistle.play().catch(()=>{});
    whistlePlayed = true;
  }
}

loadPage();
</script>
</body>
</html>
