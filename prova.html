<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Foto ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --logo1:#111;
      --logo2:#333;
      --btn:#111;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --logo1:#0b0e14;
      --logo2:#2a3242;
      --btn:#0b0e14;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui;
      background:var(--bg);
      color:var(--text);
      transition:.2s;
    }
    .wrap{max-width:860px;margin:auto;padding:16px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .header{text-align:center}
    .logo{
      width:80px;height:80px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      margin:auto;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:34px;
      letter-spacing:2px;
      user-select:none;
    }
    h1{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:10px 0 0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px;margin-top:2px}

    .nav{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:14px;
    }
    .nav a{ color:var(--text); text-decoration:none; font-weight:800; }

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn.danger{ background:var(--danger); }
    .btn.small{ padding:10px 12px; border-radius:12px; font-size:14px; }

    input[type="text"]{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      outline:none;
      font-weight:700;
    }

    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--pill);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      border:1px solid var(--border);
    }
    .pill.ok{ color:#0f5132; background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.30); }
    .pill.admin{ color:#1d4ed8; background:rgba(59,130,246,.14); border-color:rgba(59,130,246,.25); }

    /* Gallery */
    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media(max-width:720px){
      .grid{ grid-template-columns:repeat(2, 1fr); }
    }
    .tile{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
      position:relative;
    }
    .tile img{
      width:100%;
      height:240px;
      object-fit:cover;
      display:block;
      background:#000;
    }
    @media(max-width:720px){
      .tile img{ height:210px; }
    }
    .tileBar{
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cap{
      font-weight:800;
      font-size:14px;
      color:var(--text);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:70%;
    }
    .date{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .dangerMini{
      position:absolute;
      top:10px;
      right:10px;
      display:none;
    }
    .tile.admin .dangerMini{ display:inline-flex; }
  </style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div id="logo" class="logo">QDP</div>
    <h1>Foto</h1>
    <div class="subtitle">Carica la tua foto ‚Ä¢ Poi premi Aggiorna</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="row">
        <span id="adminPill" class="pill admin" style="display:none;">üîê Admin attivo</span>
        <span id="msgPill" class="pill ok" style="display:none;">‚úÖ Fatto</span>
      </div>
      <button id="refreshBtn" class="btn ghost">üîÑ Aggiorna</button>
    </div>

    <div style="height:10px"></div>

    <div class="row">
      <input id="caption" type="text" placeholder="Scrivi una descrizione (opzionale)">
    </div>

    <div style="height:10px"></div>

    <div class="row" style="justify-content:space-between;">
      <input id="file" type="file" accept="image/*" style="flex:1;min-width:220px;">
      <button id="uploadBtn" class="btn">‚¨ÜÔ∏è Carica foto</button>
    </div>

    <div style="height:10px"></div>
    <div class="muted" style="font-size:13px">
      Le foto appaiono qui sotto dopo il caricamento (o con ‚ÄúAggiorna‚Äù).
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <b>Galleria</b><div class="muted" id="countText" style="font-size:13px;margin-top:2px">‚Äî</div>
      </div>
      <a class="btn ghost" href="index.html">üè† Home</a>
    </div>

    <div style="height:12px"></div>
    <div id="grid" class="grid"></div>
    <div id="empty" class="muted" style="display:none;text-align:center;padding:18px">Nessuna foto caricata.</div>
  </div>

  <div class="card nav muted">
    <a href="storico.html">üìö Storico</a>
    <a href="marcatori.html">‚öΩ Marcatori</a>
    <a href="mvp.html">üèÜ Vota MVP</a>
    <a href="componenti.html">üë• Componenti</a>
    <a href="admin.html">üîê Admin</a>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* THEME */
const themeBtn = document.getElementById("themeToggle");
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

/* SUPABASE */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* CONFIG */
const BUCKET = "photos";     // bucket storage
const TABLE  = "photos";     // tabella db
const MAX_MB = 8;

/* DOM */
const fileEl = document.getElementById("file");
const captionEl = document.getElementById("caption");
const uploadBtn = document.getElementById("uploadBtn");
const refreshBtn = document.getElementById("refreshBtn");
const grid = document.getElementById("grid");
const empty = document.getElementById("empty");
const countText = document.getElementById("countText");
const msgPill = document.getElementById("msgPill");
const adminPill = document.getElementById("adminPill");

/* ADMIN MODE (Livello 1) */
function setAdmin(on){
  localStorage.setItem("qdp_admin", on ? "1" : "0");
  adminPill.style.display = on ? "inline-flex" : "none";
}
function isAdmin(){
  return localStorage.getItem("qdp_admin") === "1";
}
(function readAdminFromUrl(){
  const q = new URLSearchParams(location.search);
  if(q.has("admin")){
    setAdmin(q.get("admin") === "1");
    // pulisco l'URL (cos√¨ non resta brutto)
    history.replaceState({}, "", location.pathname);
  }else{
    adminPill.style.display = isAdmin() ? "inline-flex" : "none";
  }
})();

function toast(text){
  msgPill.textContent = text;
  msgPill.style.display = "inline-flex";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> msgPill.style.display="none", 1700);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDate(ts){
  try{
    return new Date(ts).toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
  }catch(e){ return ""; }
}

function fileExt(name){
  const m = String(name||"").toLowerCase().match(/\.(jpg|jpeg|png|webp|gif)$/);
  return m ? m[1] : "jpg";
}

async function uploadPhoto(){
  const f = fileEl.files?.[0];
  if(!f){ alert("Scegli una foto"); return; }

  const sizeMb = f.size / (1024*1024);
  if(sizeMb > MAX_MB){
    alert(`Foto troppo grande (${sizeMb.toFixed(1)}MB). Max ${MAX_MB}MB.`);
    return;
  }

  uploadBtn.disabled = true;
  uploadBtn.textContent = "‚è≥ Caricamento‚Ä¶";

  try{
    const ext = fileExt(f.name);
    const path = `${Date.now()}_${Math.random().toString(16).slice(2)}.${ext}`;

    // 1) upload in storage
    const { error: upErr } = await client.storage.from(BUCKET).upload(path, f, {
      cacheControl: "3600",
      upsert: false,
      contentType: f.type || undefined,
    });
    if(upErr) throw upErr;

    // 2) insert riga in tabella
    const cap = (captionEl.value || "").trim();
    const { error: insErr } = await client.from(TABLE).insert([{ path, caption: cap || null }]);
    if(insErr) throw insErr;

    // reset
    fileEl.value = "";
    captionEl.value = "";
    toast("‚úÖ Foto caricata");
    await loadGallery();

  }catch(e){
    console.error(e);
    alert("Errore upload: " + (e?.message || "sconosciuto"));
  }finally{
    uploadBtn.disabled = false;
    uploadBtn.textContent = "‚¨ÜÔ∏è Carica foto";
  }
}

async function deletePhoto(row){
  if(!isAdmin()) return;
  const ok = confirm("Vuoi eliminare questa foto?");
  if(!ok) return;

  try{
    // 1) elimina dal bucket
    const { error: rmErr } = await client.storage.from(BUCKET).remove([row.path]);
    if(rmErr) throw rmErr;

    // 2) elimina riga db
    const { error: delErr } = await client.from(TABLE).delete().eq("id", row.id);
    if(delErr) throw delErr;

    toast("üóëÔ∏è Eliminata");
    await loadGallery();
  }catch(e){
    console.error(e);
    alert("Errore elimina: " + (e?.message || "sconosciuto"));
  }
}

async function loadGallery(){
  grid.innerHTML = "";
  empty.style.display = "none";
  countText.textContent = "Caricamento‚Ä¶";

  const { data, error } = await client
    .from(TABLE)
    .select("id, created_at, path, caption")
    .order("created_at",{ascending:false})
    .limit(60);

  if(error){
    console.error(error);
    countText.textContent = "Errore caricamento";
    empty.style.display = "block";
    return;
  }

  const rows = data || [];
  countText.textContent = `${rows.length} foto`;

  if(rows.length === 0){
    empty.style.display = "block";
    return;
  }

  for(const row of rows){
    const { data: pub } = client.storage.from(BUCKET).getPublicUrl(row.path);
    const url = pub?.publicUrl || "";

    const tile = document.createElement("div");
    tile.className = "tile" + (isAdmin() ? " admin" : "");

    tile.innerHTML = `
      <img src="${escapeHtml(url)}" alt="Foto">
      <button class="btn danger small dangerMini" title="Elimina">üóëÔ∏è</button>
      <div class="tileBar">
        <div style="min-width:0">
          <div class="cap">${escapeHtml(row.caption || "‚Äî")}</div>
          <div class="date">${escapeHtml(fmtDate(row.created_at))}</div>
        </div>
        <a class="btn ghost small" href="${escapeHtml(url)}" target="_blank" rel="noopener">üîç</a>
      </div>
    `;

    const delBtn = tile.querySelector(".dangerMini");
    if(delBtn){
      delBtn.onclick = () => deletePhoto(row);
    }

    grid.appendChild(tile);
  }

  adminPill.style.display = isAdmin() ? "inline-flex" : "none";
}

/* Events */
uploadBtn.onclick = uploadPhoto;
refreshBtn.onclick = loadGallery;

/* load */
loadGallery();
</script>
</body>
</html>
