<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Componenti ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --logo1:#111;
      --logo2:#333;
      --btn:#111;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chipBg:rgba(0,0,0,.02);
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --logo1:#0b0e14;
      --logo2:#2a3242;
      --btn:#0b0e14;
      --chipBg:rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    .wrap{max-width:980px;margin:auto;padding:16px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin-bottom:10px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:70px;height:70px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:32px;letter-spacing:2px;
      box-shadow:var(--shadow);
      cursor:pointer; user-select:none;
      transform-style:preserve-3d; will-change:transform;
    }
    .logo.spin{animation:coinSpin 900ms ease-in-out}
    @keyframes coinSpin{0%{transform:rotateY(0deg)}50%{transform:rotateY(180deg)}100%{transform:rotateY(360deg)}}

    .titleWrap{line-height:1.1}
    .title{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px;margin-top:2px}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .btn{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.small{padding:10px 12px;border-radius:12px;font-size:14px}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn);color:#111}

    .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-family:inherit;
      outline:none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--pill);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      border:1px solid var(--border);
      white-space:nowrap;
      max-width:100%;
    }

    .toast{
      display:none;
      margin-top:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(22,163,74,.10);
      color:var(--text);
      font-weight:800;
      white-space:pre-wrap;
    }
    .toast.show{display:block}
    .toast.bad{background:rgba(239,68,68,.10)}
    .toast.warn{background:rgba(245,158,11,.12)}

    .nav{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font-size:14px}
    .nav a{color:var(--text);text-decoration:none;font-weight:800}

    /* ‚úÖ FIX PC: grid adattiva (non schiaccia le card) */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
    }

    .playerCard{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      box-shadow:var(--shadow);
      cursor:pointer;
      transition:transform .12s ease;
      min-height:110px;

      /* ‚úÖ FIX PC: card stabile (evita sfasamenti con tag) */
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:10px;
    }
    .playerCard:hover{transform:translateY(-1px)}

    /* ‚úÖ FIX PC: avatar centrato e testo full width */
    .avatar{
      width:64px;height:64px;border-radius:999px;
      border:1px solid var(--border);
      object-fit:cover;
      background:#000;
      flex:0 0 auto;
      margin:0 auto;
    }
    .pTxt{min-width:0;flex:1;width:100%}

    .pName{
      font-weight:900;
      font-size:16px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      width:100%;
      text-align:center;
    }
    .pMeta{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;font-size:12px;color:var(--text);
      white-space:nowrap;
    }
    .tag.gk{border-color:rgba(245,158,11,.45)}
    .pBio{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      word-break:break-word;
      width:100%;
      text-align:center;
    }
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div id="logoCoin" class="logo" title="Tocca per girare ü™ô">QDP</div>
      <div class="titleWrap">
        <h1 class="title">COMPONENTI</h1>
        <div class="subtitle">Rosa ‚Ä¢ Avatar ‚Ä¢ Ruoli ‚Ä¢ Presenze ‚Ä¢ MVP ‚Ä¢ Gol ‚Ä¢ V/P/S</div>
      </div>
    </div>

    <div class="row">
      <a class="btn ghost" href="index.html">‚¨ÖÔ∏è Home</a>
      <button id="adminBtn" class="btn small warn" type="button">üîê Admin: OFF</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="searchInput" class="input" type="text" placeholder="üîé Cerca giocatore... (nome, ruolo, bio)">
      <div class="spacer"></div>
      <div id="countPill" class="pill">üë• 0</div>
      <button id="refreshBtn" class="btn ghost" type="button">üîÑ Aggiorna</button>
    </div>

    <div id="adminHint" class="pill" style="display:none;margin-top:10px;white-space:normal">
      ‚úÖ Admin attivo (clicca un giocatore per scrivere/modificare descrizione)
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:900">üë• Rosa</div>
      <div class="spacer"></div>
      <div class="mini">Tip: clicca un giocatore per vedere/modificare la descrizione (solo admin).</div>
    </div>
    <div id="grid" class="grid" style="margin-top:12px"></div>
  </div>

  <div class="card nav muted">
    <a href="storico.html">üìö Storico</a>
    <a href="marcatori.html">‚öΩ Marcatori</a>
    <a href="mvp.html">üèÜ Vota MVP</a>
    <a href="foto.html">üì∏ Foto</a>
    <a href="componenti.html">üë• Componenti</a>
    <a href="admin.html">üîê Admin</a>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ===== THEME ===== */
const themeBtn = document.getElementById("themeToggle");
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

/* LOGO MONETA */
const logoCoin = document.getElementById("logoCoin");
function spinLogo(){
  logoCoin.classList.remove("spin");
  void logoCoin.offsetWidth;
  logoCoin.classList.add("spin");
}
logoCoin.addEventListener("click", spinLogo);
logoCoin.addEventListener("touchstart", spinLogo, {passive:true});

/* ===== SUPABASE ===== */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== DOM ===== */
const adminBtn = document.getElementById("adminBtn");
const adminHint = document.getElementById("adminHint");
const toast = document.getElementById("toast");
const refreshBtn = document.getElementById("refreshBtn");
const grid = document.getElementById("grid");
const countPill = document.getElementById("countPill");
const searchInput = document.getElementById("searchInput");

/* ===== CONFIG ===== */
const TABLE_PLAYERS = "players";
const TABLE_MATCHES = "matches";
const TABLE_VOTES = "mvp_votes";
const AVATAR_BASE = "avatars/";
const DEFAULT_AVATAR = "default.png";

/* ===== HELPERS ===== */
function showToast(msg, type="ok"){
  toast.classList.remove("show","bad","warn");
  if(type==="bad") toast.classList.add("bad");
  if(type==="warn") toast.classList.add("warn");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 2600);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function norm(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g," "); }
function avatarUrl(filename){
  const f = String(filename || "").trim();
  return AVATAR_BASE + (f ? f : DEFAULT_AVATAR);
}
function safeBio(p){ return (p?.bio ?? p?.note ?? p?.description ?? "").toString().trim(); }
function isGK(p){
  const r = String(p?.role||"").toLowerCase();
  const pos = String(p?.position||"").toLowerCase();
  return r === "gk" || pos.includes("port");
}
function bump(map, id, inc=1){
  const k = String(id||"");
  if(!k) return;
  map.set(k, (map.get(k)||0) + inc);
}
function isMatchEnded(m){
  const a = m?.score_a, b = m?.score_b;
  return a !== null && a !== undefined && b !== null && b !== undefined && a !== "" && b !== "";
}
function safeArr(v){ return Array.isArray(v) ? v : []; }

/* ===== ADMIN SESSION ===== */
async function getSession(){
  const { data } = await client.auth.getSession();
  return data?.session || null;
}
function isAdminSession(session){ return !!(session && session.user); }

let adminOn = false;
async function refreshAdminUI(){
  const session = await getSession();
  adminOn = isAdminSession(session);
  adminBtn.textContent = adminOn ? "üîê Admin: ON" : "üîê Admin: OFF";
  adminBtn.classList.toggle("warn", !adminOn);
  adminBtn.classList.toggle("ok", adminOn);
  adminHint.style.display = adminOn ? "inline-flex" : "none";
  return adminOn;
}

adminBtn.onclick = async () => {
  const session = await getSession();
  if(isAdminSession(session)){
    await client.auth.signOut();
    showToast("Admin disattivato.", "warn");
    await refreshAdminUI();
    await loadAll();
    return;
  }
  const email = prompt("Email admin:");
  if(!email) return;
  const password = prompt("Password admin:");
  if(!password) return;

  const { error } = await client.auth.signInWithPassword({ email, password });
  if(error){
    console.error(error);
    showToast("Login fallito.", "bad");
    return;
  }
  showToast("Admin attivo ‚úÖ");
  await refreshAdminUI();
  await loadAll();
};

/* ===== STATS MAPS ===== */
const appearances = new Map();
const mvpWins = new Map();
const goals = new Map();

/* ‚úÖ vittorie/pareggi/sconfitte */
const wins = new Map();
const draws = new Map();
const losses = new Map();

/* scorers parser (tollerante) */
function parseScorersToGoals(scorersAny){
  const out = new Map();
  const s = scorersAny;
  if(!s) return out;

  if(typeof s === "object" && !Array.isArray(s)){
    if(Array.isArray(s.items)){
      s.items.forEach(it=>{
        const pid = it.player_id || it.player || it.id;
        const g = Number(it.goals ?? it.g ?? it.goal ?? it.count ?? 0);
        if(pid && Number.isFinite(g) && g>0) bump(out, pid, g);
      });
      return out;
    }
    Object.keys(s).forEach(k=>{
      const v = Number(s[k]);
      if(Number.isFinite(v) && v>0) bump(out, k, v);
    });
    return out;
  }

  if(Array.isArray(s)){
    s.forEach(it=>{
      if(!it) return;
      if(typeof it === "string"){
        const parts = it.split(":");
        if(parts.length===2){
          const pid = parts[0].trim();
          const g = Number(parts[1]);
          if(pid && Number.isFinite(g) && g>0) bump(out, pid, g);
        }
        return;
      }
      const pid = it.player_id || it.player || it.id;
      const g = Number(it.goals ?? it.g ?? it.goal ?? it.count ?? 0);
      if(pid && Number.isFinite(g) && g>0) bump(out, pid, g);
    });
    return out;
  }

  return out;
}

/* ===== DATA ===== */
let ALL = [];

function renderCard(p){
  const gk = isGK(p);
  const nameHtml = gk ? `${escapeHtml(p.name||"")} <span title="Portiere">üß§</span>` : escapeHtml(p.name||"");
  const pos = String(p.position || "").trim() || "‚Äî";
  const roleLabel = gk ? "PORTIERE" : "GIOCATORE";

  const pid = String(p.id);
  const pres = appearances.get(pid) || 0;
  const mvps = mvpWins.get(pid) || 0;
  const gol  = goals.get(pid) || 0;

  const v = wins.get(pid) || 0;
  const x = draws.get(pid) || 0;
  const s = losses.get(pid) || 0;

  const bio = safeBio(p);

  return `
    <div class="playerCard" data-id="${escapeHtml(p.id)}" title="${adminOn ? "Clicca per modificare descrizione" : "Clicca per vedere descrizione"}">
      <img class="avatar" src="${escapeHtml(avatarUrl(p.avatar))}" alt="avatar"
           onerror="this.onerror=null;this.src='${escapeHtml(avatarUrl(DEFAULT_AVATAR))}'">
      <div class="pTxt">
        <div class="pName">${nameHtml}</div>

        <div class="pMeta">
          <span class="tag ${gk ? "gk" : ""}">${gk ? "üß§ " : ""}${roleLabel}</span>
          <span class="tag">üìå ${escapeHtml(pos)}</span>
          <span class="tag">üéΩ Pres. ${pres}</span>
          <span class="tag">üèÜ MVP ${mvps}</span>
          <span class="tag">‚öΩ Gol ${gol}</span>
          <span class="tag">‚úÖ V ${v}</span>
          <span class="tag">‚ûñ P ${x}</span>
          <span class="tag">‚ùå S ${s}</span>
        </div>

        <div class="pBio">${bio ? escapeHtml(bio) : (adminOn ? "‚úçÔ∏è (clicca per inserire descrizione)" : "‚Äî")}</div>
      </div>
    </div>
  `;
}

function applyFilter(){
  const q = norm(searchInput.value);
  const list = q
    ? ALL.filter(p => norm(p.name).includes(q) || norm(p.position).includes(q) || norm(p.role).includes(q) || norm(safeBio(p)).includes(q))
    : ALL.slice();

  countPill.textContent = `üë• ${list.length}`;
  grid.innerHTML = list.map(renderCard).join("") || `<div class="mini muted">Nessun giocatore.</div>`;

  [...grid.querySelectorAll(".playerCard")].forEach(card=>{
    card.onclick = () => onCardClick(card.getAttribute("data-id"));
  });
}

async function onCardClick(playerId){
  const p = ALL.find(x => String(x.id) === String(playerId));
  if(!p) return;

  const bio = safeBio(p);

  if(adminOn){
    const next = prompt(
      `Descrizione per ${p.name} (max 180 caratteri)\n\n‚ö†Ô∏è Serve colonna "bio" (text) in tabella players.`,
      bio
    );
    if(next === null) return;

    const clean = String(next||"").trim().slice(0,180);

    const { error } = await client
      .from(TABLE_PLAYERS)
      .update({ bio: clean })
      .eq("id", p.id);

    if(error){
      console.error(error);
      showToast("Errore salvataggio: manca colonna 'bio' o policy UPDATE.", "bad");
      return;
    }

    showToast("Descrizione salvata ‚úÖ");
    await loadAll();
    return;
  }

  alert(`${p.name}\n\n${bio ? bio : "Nessuna descrizione."}`);
}

/* ===== LOAD ===== */
async function loadPlayers(){
  const { data, error } = await client
    .from(TABLE_PLAYERS)
    .select("*")
    .order("name", { ascending:true });

  if(error) throw error;

  ALL = (data || []).map(p=>({
    id: p.id,
    name: p.name || "",
    role: p.role || "",
    position: p.position || "",
    avatar: p.avatar || p.avatar_file || p.avatar_url || DEFAULT_AVATAR,
    bio: p.bio ?? p.note ?? p.description ?? ""
  }));
}

async function loadMatchesForStats(){
  const { data, error } = await client
    .from(TABLE_MATCHES)
    .select("id,match_date,called_up,team_a,team_b,score_a,score_b,scorers")
    .order("match_date", { ascending:false })
    .limit(600);

  if(error) throw error;
  return data || [];
}

async function loadVotesForStats(){
  const { data, error } = await client
    .from(TABLE_VOTES)
    .select("match_id,voted_player")
    .limit(8000);

  if(error) throw error;
  return data || [];
}

function computeStats(matches, votes){
  appearances.clear(); mvpWins.clear(); goals.clear();
  wins.clear(); draws.clear(); losses.clear();

  for(const m of (matches||[])){
    const called = Array.isArray(m.called_up) ? m.called_up : [];
    called.forEach(pid => bump(appearances, pid, 1));

    const gmap = parseScorersToGoals(m.scorers);
    for(const [pid, g] of gmap.entries()){
      bump(goals, pid, g);
    }

    if(isMatchEnded(m)){
      const sa = Number(m.score_a);
      const sb = Number(m.score_b);
      if(Number.isFinite(sa) && Number.isFinite(sb)){
        const teamA = safeArr(m.team_a).map(String);
        const teamB = safeArr(m.team_b).map(String);

        if(sa > sb){
          teamA.forEach(pid => bump(wins, pid, 1));
          teamB.forEach(pid => bump(losses, pid, 1));
        }else if(sa < sb){
          teamA.forEach(pid => bump(losses, pid, 1));
          teamB.forEach(pid => bump(wins, pid, 1));
        }else{
          teamA.forEach(pid => bump(draws, pid, 1));
          teamB.forEach(pid => bump(draws, pid, 1));
        }
      }
    }
  }

  const byMatch = new Map();
  for(const v of (votes||[])){
    const mid = String(v.match_id || "");
    const pid = String(v.voted_player || "");
    if(!mid || !pid) continue;
    if(!byMatch.has(mid)) byMatch.set(mid, new Map());
    const mm = byMatch.get(mid);
    mm.set(pid, (mm.get(pid)||0) + 1);
  }

  for(const mm of byMatch.values()){
    let best = 0;
    for(const c of mm.values()) best = Math.max(best, c);
    if(best <= 0) continue;
    for(const [pid, c] of mm.entries()){
      if(c === best) bump(mvpWins, pid, 1);
    }
  }
}

async function loadAll(){
  await refreshAdminUI();
  grid.innerHTML = `<div class="mini muted">Carico‚Ä¶</div>`;

  try{
    await loadPlayers();
  }catch(e){
    console.error(e);
    grid.innerHTML = `<div class="mini muted">Errore caricamento players: ${escapeHtml(e.message || String(e))}</div>`;
    return;
  }

  let matches = [], votes = [];
  let warn = [];

  try{
    matches = await loadMatchesForStats();
  }catch(e){
    console.error(e);
    warn.push("‚ö†Ô∏è Non riesco a leggere matches (RLS/permessi): Presenze/Gol/V-P-S = 0");
  }

  try{
    votes = await loadVotesForStats();
  }catch(e){
    console.error(e);
    warn.push("‚ö†Ô∏è Non riesco a leggere mvp_votes (RLS/permessi): MVP = 0");
  }

  computeStats(matches, votes);

  if(warn.length) showToast(warn.join("\n"), "warn");

  applyFilter();
}

refreshBtn.onclick = () => loadAll();
searchInput.oninput = () => applyFilter();

/* INIT */
loadAll();
</script>
</body>
</html>
