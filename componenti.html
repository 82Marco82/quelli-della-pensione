<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Componenti ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --logo1:#111;
      --logo2:#333;
      --chipBg:rgba(0,0,0,.04);
      --btnBg:#111;
      --btnText:#fff;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --logo1:#0b0e14;
      --logo2:#2a3242;
      --chipBg:rgba(255,255,255,.04);
      --btnBg:#0b0e14;
      --btnText:#fff;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    .wrap{max-width:900px;margin:auto;padding:16px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
      overflow:hidden;
    }

    .header{text-align:center}
    .logo{
      width:74px;height:74px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      margin:auto;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:30px;
      letter-spacing:2px;
    }
    h1{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:10px 0 0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px}

    .row{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;flex-wrap:wrap;
    }

    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;font-size:12px;
      white-space:nowrap;
    }

    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }
    .btn{
      border:1px solid var(--border);
      background:var(--btnBg);
      color:var(--btnText);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--text);
    }

    .list{margin-top:8px}
    .playerCard{
      text-decoration:none;
      color:inherit;
      display:block;
    }
    .playerTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .leftBlock{min-width:0}
    .name{
      font-weight:900;
      font-size:16px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:520px;
    }
    .mini{font-size:12px;color:var(--muted);margin-top:6px}

    .rankBadge{
      width:30px;height:30px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      border:1px solid var(--border);
      background:var(--card);
      flex:0 0 auto;
    }
    .rightPills{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .nav{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-size:14px;
    }
    .nav a{color:var(--text);text-decoration:none;font-weight:800}
    .nav a:hover{text-decoration:underline}

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div class="logo">QDP</div>
    <h1>Componenti</h1>
    <div class="subtitle">Quelli della pensione</div>
  </div>

  <div class="card">
    <div class="toolbar">
      <div>
        <div id="status" class="muted">Caricamento‚Ä¶</div>
        <div id="substatus" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="row" style="margin:0">
        <button id="btnSortPresence" class="btn">ü•á Classifica presenze</button>
        <button id="btnSortAZ" class="btn ghost">A‚ÄìZ</button>
        <button id="btnRefresh" class="btn ghost">üîÑ Aggiorna</button>
      </div>
    </div>
  </div>

  <div id="list" class="list"></div>

  <div class="card nav muted">
    <a href="index.html">üè† Home</a>
    <a href="mvp.html">üèÜ MVP</a>
    <a href="storico.html">üìö Storico</a>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ===== THEME ===== */
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  document.getElementById("themeToggle").textContent = mode === "dark" ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
document.getElementById("themeToggle").onclick = () => {
  setTheme(document.body.classList.contains("dark") ? "light" : "dark");
};

/* ===== SUPABASE ===== */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== DOM ===== */
const statusEl = document.getElementById("status");
const substatusEl = document.getElementById("substatus");
const listEl = document.getElementById("list");
const btnSortPresence = document.getElementById("btnSortPresence");
const btnSortAZ = document.getElementById("btnSortAZ");
const btnRefresh = document.getElementById("btnRefresh");

/* ===== HELPERS ===== */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function medal(i){
  if(i===0) return "ü•á";
  if(i===1) return "ü•à";
  if(i===2) return "ü•â";
  return String(i+1);
}
function isVoteClosed(m){
  // chiusa se entrambe false / null / non true
  const a = (m?.vote_open === true);
  const b = (m?.voting_open === true);
  return !(a || b);
}

/* ===== STATE ===== */
let PLAYERS = []; // {id,name}
let MATCHES = []; // {id, called_up, vote_open, voting_open}
let PRESENCE = new Map(); // player_id -> presenze
let MVP_WINS = new Map(); // player_id -> wins (partite chiuse)
let TOTAL_MATCHES = 0;

let SORT_MODE = "presence"; // "presence" | "az"

/* ===== DATA LOAD ===== */
async function loadAll(){
  statusEl.textContent = "Caricamento‚Ä¶";
  substatusEl.textContent = "";
  listEl.innerHTML = "";

  // players
  const { data: players, error: eP } = await client
    .from("players")
    .select("id,name")
    .order("name",{ascending:true});
  if(eP) throw eP;
  PLAYERS = players || [];

  // matches (servono convocati + stato voto)
  const { data: matches, error: eM } = await client
    .from("matches")
    .select("id,called_up,vote_open,voting_open");
  if(eM) throw eM;
  MATCHES = matches || [];
  TOTAL_MATCHES = MATCHES.length;

  // presenze
  PRESENCE = new Map();
  MATCHES.forEach(m=>{
    (Array.isArray(m.called_up) ? m.called_up : []).forEach(id=>{
      const k = String(id);
      PRESENCE.set(k, (PRESENCE.get(k) || 0) + 1);
    });
  });

  // MVP wins: calcolo solo su partite con votazione CHIUSA
  MVP_WINS = new Map();
  const closedMatchIds = MATCHES.filter(isVoteClosed).map(m=>m.id);

  if(closedMatchIds.length){
    const { data: votes, error: eV } = await client
      .from("mvp_votes")
      .select("match_id,voted_player")
      .in("match_id", closedMatchIds);
    if(eV) throw eV;

    // raggruppo voti per match
    const byMatch = new Map();
    (votes || []).forEach(v=>{
      const mid = String(v.match_id);
      if(!byMatch.has(mid)) byMatch.set(mid, []);
      byMatch.get(mid).push(String(v.voted_player || ""));
    });

    // per ogni match: trova top (gestisce parit√† => tutti vincono)
    for(const [mid, arr] of byMatch.entries()){
      const counts = new Map();
      arr.forEach(pid=>{
        if(!pid) return;
        counts.set(pid, (counts.get(pid) || 0) + 1);
      });
      if(!counts.size) continue;

      const entries = [...counts.entries()].sort((a,b)=>b[1]-a[1]);
      const top = entries[0][1];
      const winners = entries.filter(e=>e[1]===top).map(e=>e[0]);

      winners.forEach(pid=>{
        MVP_WINS.set(pid, (MVP_WINS.get(pid) || 0) + 1);
      });
    }
  }

  render();
}

/* ===== RENDER ===== */
function render(){
  const totalPlayers = PLAYERS.length;
  const played = TOTAL_MATCHES;

  statusEl.textContent = `Totale componenti: ${totalPlayers}`;
  substatusEl.textContent = `Partite in archivio: ${played}`;

  const rows = PLAYERS.map(p=>{
    const id = String(p.id);
    const pres = PRESENCE.get(id) || 0;
    const pct = played > 0 ? Math.round((pres / played) * 100) : 0;
    const wins = MVP_WINS.get(id) || 0;

    return { id, name: p.name, pres, pct, wins };
  });

  if(SORT_MODE === "presence"){
    rows.sort((a,b)=> b.pres - a.pres || b.wins - a.wins || String(a.name).localeCompare(String(b.name),"it"));
  }else{
    rows.sort((a,b)=> String(a.name).localeCompare(String(b.name),"it"));
  }

  listEl.innerHTML = rows.map((r, idx)=>{
    const rank = (SORT_MODE === "presence") ? medal(idx) : "üë§";
    const rankTitle = (SORT_MODE === "presence") ? "Posizione in classifica presenze" : "Giocatore";

    return `
      <a class="playerCard" href="giocatore.html?id=${encodeURIComponent(r.id)}">
        <div class="card">
          <div class="playerTop">
            <div class="row" style="margin:0;flex:1;min-width:0">
              <div class="row" style="margin:0;align-items:center;flex:1;min-width:0;gap:10px">
                <div class="rankBadge" title="${escapeHtml(rankTitle)}">${escapeHtml(rank)}</div>
                <div class="leftBlock">
                  <div class="name" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</div>
                  <div class="mini">Tocca per aprire la scheda</div>
                </div>
              </div>

              <div class="rightPills">
                <span class="pill">üë• Presenze: ${r.pres}</span>
                <span class="pill">üìä ${r.pct}%</span>
                <span class="pill">üèÜ MVP: ${r.wins}</span>
              </div>
            </div>
          </div>
        </div>
      </a>
    `;
  }).join("");
}

/* ===== EVENTS ===== */
btnSortPresence.onclick = ()=>{ SORT_MODE = "presence"; render(); };
btnSortAZ.onclick = ()=>{ SORT_MODE = "az"; render(); };
btnRefresh.onclick = loadAll;

/* ===== INIT ===== */
loadAll().catch(err=>{
  console.error(err);
  statusEl.textContent = "Errore caricamento componenti";
  substatusEl.textContent = err?.message ? String(err.message) : "";
  listEl.innerHTML = `<div class="card"><div class="muted">${escapeHtml(err?.message || String(err))}</div></div>`;
});
</script>
</body>
</html>
