<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Componenti ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --chipBg:rgba(0,0,0,.04);
      --btn:#111;
      --btnText:#fff;
      --pill:#eeeeee;
      --logo1:#111; --logo2:#333;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --chipBg:rgba(255,255,255,.04);
      --btn:#0b0e14;
      --btnText:#fff;
      --pill:#222631;
      --logo1:#0b0e14; --logo2:#2a3242;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    .wrap{max-width:860px;margin:auto;padding:16px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .header{text-align:center}
    .logo{
      width:74px;height:74px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      margin:auto;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:30px;letter-spacing:2px;
    }
    h1{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:10px 0 0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px;margin-top:6px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .space{height:10px}

    .btn{
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--btnText);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--text);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .controlsLeft{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* LISTA */
    .list{margin-top:10px}

    .playerCard{
      padding:16px;
      border-radius:22px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      user-select:none;
    }

    .playerTop{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }

    /* IMPORTANTISSIMO: evita troncamento su mobile */
    .playerLeft{
      flex:1;
      min-width:0;
    }

    .badgeMedal{
      width:34px;height:34px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;
      flex:0 0 auto;
    }

    .playerName{
      font-weight:900;
      font-size:22px;
      line-height:1.1;

      /* FIX: niente ... */
      white-space:normal !important;
      overflow:visible !important;
      text-overflow:clip !important;
      word-break:break-word;
      overflow-wrap:anywhere;
    }

    .playerSub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
      margin-top:14px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }

    .nav{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:14px;
    }
    .nav a{color:var(--text);text-decoration:none;font-weight:800}
    .nav a:hover{text-decoration:underline}

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
      display:flex;align-items:center;justify-content:center;
      z-index:9999;
    }

    .infoBox{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      margin-top:10px;
    }

    .msg{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--chipBg);
      color:var(--muted);
      white-space:pre-wrap;
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="header">
      <div class="logo">QDP</div>
      <h1>Componenti</h1>
      <div class="subtitle">Quelli della pensione</div>
    </div>

    <div class="card">
      <div class="infoBox">
        <span class="pill">üë• Totale componenti: <span id="totPlayers">‚Äî</span></span>
        <span class="pill">üìö Partite in archivio: <span id="totMatches">‚Äî</span></span>
      </div>

      <div class="controls">
        <div class="controlsLeft">
          <button id="btnSortPresence" class="btn">üèÖ Classifica presenze</button>
          <button id="btnSortAZ" class="btn ghost">A‚ÄìZ</button>
        </div>
        <button id="btnRefresh" class="btn ghost">üîÑ Aggiorna</button>
      </div>

      <div id="status" class="msg">Caricamento‚Ä¶</div>
    </div>

    <div id="list" class="list"></div>

    <div class="card nav muted">
      <a href="index.html">üè† Home</a>
      <a href="storico.html">üìö Storico</a>
      <a href="marcatori.html">‚öΩ Marcatori</a>
      <a href="admin.html">üîê Admin</a>
    </div>

  </div>

  <button id="themeToggle" class="fab">üåô</button>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    /* ===== THEME ===== */
    function setTheme(mode){
      document.body.classList.toggle("dark", mode === "dark");
      document.getElementById("themeToggle").textContent = mode === "dark" ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("qdp_theme", mode);
    }
    setTheme(localStorage.getItem("qdp_theme")==="dark" ? "dark" : "light");
    document.getElementById("themeToggle").onclick = () => {
      setTheme(document.body.classList.contains("dark") ? "light" : "dark");
    };

    /* ===== SUPABASE ===== */
    if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
      alert("Errore: config.js non caricato");
      throw new Error("Missing config");
    }
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const totPlayersEl = document.getElementById("totPlayers");
    const totMatchesEl = document.getElementById("totMatches");
    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");

    const btnSortPresence = document.getElementById("btnSortPresence");
    const btnSortAZ = document.getElementById("btnSortAZ");
    const btnRefresh = document.getElementById("btnRefresh");

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function medal(i){
      if(i===0) return "ü•á";
      if(i===1) return "ü•à";
      if(i===2) return "ü•â";
      return String(i+1);
    }

    function isVoteOpen(m){
      return (m?.vote_open === true) || (m?.voting_open === true);
    }

    let SORT_MODE = "presence"; // "presence" | "az"

    btnSortPresence.onclick = () => { SORT_MODE = "presence"; render(); };
    btnSortAZ.onclick = () => { SORT_MODE = "az"; render(); };
    btnRefresh.onclick = () => loadAll();

    let PLAYERS = []; // [{id,name}]
    let MATCHES = []; // [{id,called_up,vote_open,voting_open}]
    let MVP_VOTES = []; // [{match_id,voted_player}]

    let PRESENCE_MAP = new Map(); // playerId -> presenze
    let MVP_WIN_MAP = new Map();  // playerId -> mvp wins (per match closed)
    let TOTAL_MATCHES = 0;

    function setStatus(text){
      statusEl.textContent = text;
      statusEl.style.display = text ? "block" : "none";
    }

    async function loadAll(){
      try{
        setStatus("Caricamento‚Ä¶");
        listEl.innerHTML = "";

        // players
        const { data: players, error: eP } = await client
          .from("players")
          .select("id,name")
          .order("name",{ascending:true});
        if(eP) throw eP;
        PLAYERS = players || [];

        // matches (archivio)
        const { data: matches, error: eM } = await client
          .from("matches")
          .select("id,called_up,vote_open,voting_open,match_date,match_time")
          .order("match_date",{ascending:false})
          .order("match_time",{ascending:false})
          .limit(1000);
        if(eM) throw eM;
        MATCHES = matches || [];
        TOTAL_MATCHES = MATCHES.length;

        // votes
        const matchIds = MATCHES.map(m=>m.id);
        if(matchIds.length){
          const { data: votes, error: eV } = await client
            .from("mvp_votes")
            .select("match_id,voted_player")
            .in("match_id", matchIds);
          if(eV) throw eV;
          MVP_VOTES = votes || [];
        }else{
          MVP_VOTES = [];
        }

        computeStats();
        render();
        setStatus("");

      }catch(err){
        console.error(err);
        setStatus("‚ùå Errore caricamento: " + (err?.message || String(err)));
      }
    }

    function computeStats(){
      PRESENCE_MAP = new Map();
      MVP_WIN_MAP = new Map();

      // presenze: quante volte compare in called_up
      for(const m of MATCHES){
        const cu = Array.isArray(m.called_up) ? m.called_up : [];
        for(const pid of cu){
          const k = String(pid);
          PRESENCE_MAP.set(k, (PRESENCE_MAP.get(k) || 0) + 1);
        }
      }

      // MVP wins per match chiusa:
      // 1) raggruppo voti per match
      const votesByMatch = new Map();
      for(const v of MVP_VOTES){
        const mk = String(v.match_id);
        if(!votesByMatch.has(mk)) votesByMatch.set(mk, []);
        votesByMatch.get(mk).push(v);
      }

      // 2) per ogni match chiusa: conto voti e assegno 1 win ai leader (anche in parit√†)
      for(const m of MATCHES){
        if(isVoteOpen(m)) continue; // solo chiuse
        const mk = String(m.id);
        const vv = votesByMatch.get(mk) || [];
        if(!vv.length) continue;

        const counts = new Map();
        for(const x of vv){
          const pid = String(x.voted_player || "");
          if(!pid) continue;
          counts.set(pid, (counts.get(pid) || 0) + 1);
        }
        if(!counts.size) continue;

        let top = 0;
        for(const c of counts.values()) top = Math.max(top, c);
        const leaders = [...counts.entries()].filter(([_,c])=>c===top).map(([pid])=>pid);

        for(const pid of leaders){
          MVP_WIN_MAP.set(pid, (MVP_WIN_MAP.get(pid) || 0) + 1);
        }
      }
    }

    function render(){
      // header counters
      totPlayersEl.textContent = String(PLAYERS.length);
      totMatchesEl.textContent = String(TOTAL_MATCHES);

      // buttons style
      if(SORT_MODE === "presence"){
        btnSortPresence.className = "btn";
        btnSortAZ.className = "btn ghost";
      }else{
        btnSortPresence.className = "btn ghost";
        btnSortAZ.className = "btn";
      }

      // rows
      const rows = PLAYERS.map(p=>{
        const id = String(p.id);
        const presenze = PRESENCE_MAP.get(id) || 0;
        const mvp = MVP_WIN_MAP.get(id) || 0;
        const perc = TOTAL_MATCHES > 0 ? Math.round((presenze / TOTAL_MATCHES) * 100) : 0;
        return { id, name: p.name || id, presenze, perc, mvp };
      });

      if(SORT_MODE === "presence"){
        rows.sort((a,b)=> b.presenze - a.presenze || a.name.localeCompare(b.name,"it"));
      }else{
        rows.sort((a,b)=> a.name.localeCompare(b.name,"it"));
      }

      if(!rows.length){
        listEl.innerHTML = `<div class="card"><div class="muted">Nessun componente trovato.</div></div>`;
        return;
      }

      listEl.innerHTML = rows.map((r, idx)=>{
        const showMedal = (SORT_MODE === "presence");
        const medalHtml = showMedal ? `<div class="badgeMedal">${escapeHtml(medal(idx))}</div>` : `<div class="badgeMedal">üë§</div>`;

        return `
          <div class="playerCard" data-id="${escapeHtml(r.id)}" style="margin-top:12px">
            <div class="playerTop">
              ${medalHtml}

              <div class="playerLeft">
                <div class="playerName">${escapeHtml(r.name)}</div>
                <div class="playerSub">Tocca per aprire la scheda</div>

                <div class="chips">
                  <div class="chip">üë• Presenze: ${escapeHtml(r.presenze)}</div>
                  <div class="chip">üìä ${escapeHtml(r.perc)}%</div>
                  <div class="chip">üèÜ MVP: ${escapeHtml(r.mvp)}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      // click -> giocatore.html?id=
      [...document.querySelectorAll(".playerCard")].forEach(card=>{
        card.addEventListener("click", ()=>{
          const id = card.getAttribute("data-id");
          if(!id) return;
          location.href = `giocatore.html?id=${encodeURIComponent(id)}`;
        });
      });
    }

    loadAll();
  </script>
</body>
</html>
