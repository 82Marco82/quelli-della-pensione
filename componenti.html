<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QDP ‚Ä¢ Componenti</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --logo1:#111;
      --logo2:#333;
      --btn:#111;
      --ok:#16a34a;
      --bad:#ef4444;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --logo1:#0b0e14;
      --logo2:#2a3242;
      --btn:#0b0e14;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    .wrap{max-width:980px;margin:18px auto;padding:16px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:64px;height:64px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:28px;letter-spacing:2px;
      box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .titleWrap{line-height:1.1}
    .title{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px;margin-top:2px}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--pill);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      border:1px solid var(--border);
      white-space:nowrap;
    }

    .btn{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn.small{padding:10px 12px; border-radius:12px; font-size:14px}
    .btn.ok{background:var(--ok)}
    .btn.bad{background:var(--bad)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:12px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:repeat(3, 1fr)} }
    @media(max-width:760px){ .grid{grid-template-columns:repeat(2, 1fr)} }
    @media(max-width:480px){ .grid{grid-template-columns:1fr} }

    .pCard{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .pTop{
      display:flex;
      gap:12px;
      padding:12px;
      align-items:center;
    }
    .avatar{
      width:64px;height:64px;border-radius:999px;
      border:1px solid var(--border);
      flex:0 0 auto;
      object-fit:cover;
      background:#000;
    }
    .pName{
      font-weight:900;
      font-size:16px;
      line-height:1.15;
    }
    .tags{margin-top:6px; display:flex; flex-wrap:wrap; gap:6px}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.02);
      font-weight:900;
      font-size:12px;
    }
    body.dark .tag{background:rgba(255,255,255,.03)}
    .tag.gk{background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.35)}
    .tag.field{background:rgba(0,0,0,.02)}
    body.dark .tag.field{background:rgba(255,255,255,.03)}

    .pBottom{
      padding:12px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .nav{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:14px;
    }
    .nav a{
      color:var(--text);
      text-decoration:none;
      font-weight:800;
    }

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
    }

    .errBox{
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.08);
      border-radius:14px;
      padding:12px;
      font-weight:900;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo">QDP</div>
      <div class="titleWrap">
        <h1 class="title">Componenti</h1>
        <div class="subtitle">Giocatori ‚Ä¢ Avatar ‚Ä¢ Ruoli</div>
      </div>
    </div>

    <div class="row">
      <a class="btn ghost" href="index.html">‚¨ÖÔ∏è Home</a>
      <button id="refreshBtn" class="btn small ghost" type="button">üîÑ Aggiorna</button>
      <button id="themeToggle" class="btn small ghost" type="button">üåô</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div id="countPill" class="pill">üë• 0 giocatori</div>
      <div class="spacer"></div>
      <div class="pill">üìå Avatar: cartella <b>/avatars</b> (1.png‚Ä¶18.png + default.png)</div>
    </div>

    <div id="msg" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:900">üßë‚Äçü§ù‚Äçüßë Lista</div>
      <div class="spacer"></div>
      <div class="muted" style="font-weight:800">Se vedi errore qui sotto, √® quasi sempre una colonna/policy.</div>
    </div>

    <div id="grid" class="grid" style="margin-top:12px"></div>
  </div>

  <!-- NAV (come index) -->
  <div class="card nav muted">
    <a href="storico.html">üìö Storico</a>
    <a href="marcatori.html">‚öΩ Marcatori</a>
    <a href="mvp.html">üèÜ Vota MVP</a>
    <a href="foto.html">üì∏ Foto</a>
    <a href="componenti.html">üë• Componenti</a>
    <a href="admin.html">üîê Admin</a>
  </div>

</div>

<button id="themeToggleFab" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ===== THEME ===== */
const themeBtn = document.getElementById("themeToggle");
const themeFab = document.getElementById("themeToggleFab");

function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  const icon = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  themeBtn.textContent = icon;
  themeFab.textContent = icon;
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");
themeFab.onclick = themeBtn.onclick;

/* ===== SUPABASE ===== */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

/* ===== DOM ===== */
const gridEl = document.getElementById("grid");
const msgEl = document.getElementById("msg");
const countPill = document.getElementById("countPill");
document.getElementById("refreshBtn").onclick = () => loadPlayers();

/* ===== CONFIG ===== */
const TABLE_PLAYERS = "players";
const AVATAR_BASE = "./avatars/";
const DEFAULT_AVATAR = "default.png";

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showError(text){
  msgEl.innerHTML = `<div class="errBox">‚ùå ${escapeHtml(text)}</div>`;
}
function clearMsg(){
  msgEl.innerHTML = "";
}

function roleLabel(role){
  const r = String(role || "").toLowerCase();
  if(r === "gk") return "Portiere (GK)";
  if(r === "field") return "Giocatore";
  return role ? String(role) : "‚Äî";
}

/* ‚úÖ select ‚Äúintelligente‚Äù: se una colonna non esiste, riprova */
async function safeSelectPlayers(){
  const tries = [
    "id,name,role,position,avatar",
    "id,name,role,position,avatar_file",
    "id,name,role,position,avatar_path",
    "id,name,role,position",
    "id,name,role",
    "id,name"
  ];

  let lastErr = null;
  for(const sel of tries){
    const { data, error } = await client
      .from(TABLE_PLAYERS)
      .select(sel)
      .order("name", { ascending:true });

    if(!error) return { data: data || [], used: sel };
    lastErr = error;
    const msg = String(error.message || "");
    // se √® un errore diverso da ‚Äúcolonna non esiste‚Äù, fermiamoci subito
    if(!msg.toLowerCase().includes("column") && !msg.toLowerCase().includes("does not exist")){
      break;
    }
  }
  throw lastErr || new Error("Errore select players");
}

function getAvatarFile(p){
  // prova a leggere vari nomi colonna, in base a come l‚Äôhai chiamata
  const file =
    p.avatar ||
    p.avatar_file ||
    p.avatar_path ||
    "";
  const clean = String(file || "").trim();
  return clean ? clean : DEFAULT_AVATAR;
}

function playerCard(p){
  const name = String(p.name || "‚Äî");
  const role = String(p.role || "");
  const position = String(p.position || "");
  const av = getAvatarFile(p);

  const isGK = role.toLowerCase() === "gk";

  const avatarUrl = AVATAR_BASE + av;

  return `
    <div class="pCard">
      <div class="pTop">
        <img class="avatar"
          src="${escapeHtml(avatarUrl)}"
          alt="avatar"
          loading="lazy"
          onerror="this.onerror=null;this.src='${escapeHtml(AVATAR_BASE + DEFAULT_AVATAR)}';"
        >
        <div style="min-width:0">
          <div class="pName">${escapeHtml(name)}</div>
          <div class="tags">
            <span class="tag ${isGK ? "gk" : "field"}">${isGK ? "üß§ GK" : "üëü FIELD"}</span>
            <span class="tag">üìå ${escapeHtml(position || "‚Äî")}</span>
          </div>
        </div>
      </div>
      <div class="pBottom">ID: ${escapeHtml(String(p.id || "").slice(0,8))}‚Ä¶</div>
    </div>
  `;
}

async function loadPlayers(){
  clearMsg();
  gridEl.innerHTML = `<div class="muted" style="font-weight:900">Caricamento‚Ä¶</div>`;

  try{
    const res = await safeSelectPlayers();
    const players = res.data || [];

    countPill.textContent = `üë• ${players.length} giocatori`;

    if(!players.length){
      gridEl.innerHTML = `<div class="muted" style="font-weight:900">Nessun giocatore trovato.</div>`;
      return;
    }

    gridEl.innerHTML = players.map(playerCard).join("");

    // info tecnica (utile se qualcosa non torna)
    msgEl.innerHTML = `<div class="muted" style="font-weight:900">‚úÖ Caricati con select: <b>${escapeHtml(res.used)}</b></div>`;

  }catch(e){
    console.error(e);
    countPill.textContent = `üë• 0 giocatori`;
    gridEl.innerHTML = "";
    showError((e && e.message) ? e.message : String(e));
  }
}

loadPlayers();
</script>
</body>
</html>
