<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quelli della pensione</title>

  <!-- Font "bello" -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c162b;
      --txt:#eaf2ff;
      --muted:#aab6d3;
      --line:rgba(255,255,255,.10);
      --accent:#64b5ff;
      --good:#39d98a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(100,181,255,.20), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(57,217,138,.12), transparent 60%),
                  var(--bg);
      color:var(--txt);
      min-height:100vh;
      padding:16px;
      display:flex;
      justify-content:center;
    }

    .wrap{
      width:100%;
      max-width: 780px;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
    }

    .logo{
      width:46px; height:46px;
      border-radius:50%;
      background: linear-gradient(135deg, rgba(100,181,255,.35), rgba(57,217,138,.25));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-weight:900;
      letter-spacing:.5px;
    }

    h1{
      margin:0;
      font-family: Anton, Inter, sans-serif;
      font-size: 42px;
      letter-spacing: 1px;
      line-height: 1;
      text-transform: uppercase;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-weight:600;
    }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:6px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      text-decoration:none;
      padding:10px 12px;
      border-radius: 14px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .12s ease, background .12s ease, border .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.22);}
    .btn.primary{ background: rgba(100,181,255,.14); border-color: rgba(100,181,255,.35); }
    .btn.primary:hover{ background: rgba(100,181,255,.22); }
    .btn.good{ background: rgba(57,217,138,.14); border-color: rgba(57,217,138,.35); }
    .btn.good:hover{ background: rgba(57,217,138,.22); }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .hero{
      padding:14px;
    }
    .photo{
      position:relative;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:#000;
    }
    .photo img{
      width:100%;
      display:block;
      height:auto;
    }
    .photo .caption{
      position:absolute;
      left:12px;
      bottom:10px;
      padding:8px 10px;
      font-weight:900;
      letter-spacing:.6px;
      border-radius: 12px;
      background: rgba(0,0,0,.50);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
      text-transform: uppercase;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      padding:14px;
    }

    @media (min-width: 760px){
      .grid{
        grid-template-columns: 1.15fr .85fr;
        align-items:start;
      }
    }

    .box{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding:14px;
    }
    .box h2{
      margin:0 0 10px 0;
      font-size:16px;
      letter-spacing:.2px;
    }

    .muted{ color:var(--muted); }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      font-weight:800;
    }
    .pill.ok{ background: rgba(57,217,138,.12); border-color: rgba(57,217,138,.25); }
    .pill.warn{ background: rgba(255,204,102,.12); border-color: rgba(255,204,102,.25); }
    .pill.bad{ background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.25); }

    .divider{
      height:1px;
      background: var(--line);
      margin:12px 0;
    }

    .teams{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 520px){
      .teams{
        grid-template-columns: 1fr 1fr;
      }
    }

    .team{
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:54px;
    }
    .team .left{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .jersey{
      width:26px; height:26px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 8px 25px rgba(0,0,0,.25);
      flex: 0 0 auto;
    }
    .jersey.yellow{ background: linear-gradient(180deg, #ffd54d, #ffb300); }
    .jersey.red{ background: linear-gradient(180deg, #ff5c5c, #d81b60); }

    .team .title{
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .team .label{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      text-transform: uppercase;
      letter-spacing:.7px;
    }

    .result{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      margin-top:10px;
      animation: fadeUp .25s ease-out;
    }
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .result strong{ font-size:18px; }
    .small{ font-size:13px; }

    .called{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .chip{
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      font-weight:800;
      font-size:13px;
    }

    .map{
      margin-top:12px;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
    }
    .map iframe{
      width:100%;
      height:260px;
      border:0;
      display:block;
    }

    .error{
      margin-top:10px;
      color: var(--bad);
      font-weight:800;
    }
    .loading{
      color:var(--muted);
      font-weight:800;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(100,181,255,.9);
      box-shadow: 0 0 0 0 rgba(100,181,255,.65);
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(100,181,255,.45); }
      70%{ box-shadow: 0 0 0 12px rgba(100,181,255,0); }
      100%{ box-shadow: 0 0 0 0 rgba(100,181,255,0); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">
          <div class="logo">QP</div>
          <div>
            <h1>Quelli della pensione</h1>
            <div class="sub">Ogni maledetto gioved√¨ ‚Ä¢ Ore 21 ‚Ä¢ Campo a 6 Aradeo</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="dashboard.html">üìö Storico</a>
        <a class="btn primary" href="admin.html">üîß Area Admin</a>
      </div>
    </div>

    <div class="card hero">
      <div class="photo">
        <img src="foto.jpg" alt="Quelli della pensione">
        <div class="caption">Ogni maledetto gioved√¨</div>
      </div>
    </div>

    <div class="grid">
      <div class="box">
        <h2>Partita</h2>
        <div id="status" class="loading"><span class="dot"></span>Caricamento‚Ä¶</div>
        <div id="match" style="margin-top:12px;"></div>
        <div id="err" class="error"></div>
      </div>

      <div class="box">
        <h2>Convocati</h2>
        <div class="muted small">Massimo 12. Se non ci sono convocati, qui resta vuoto.</div>
        <div id="called" class="called"></div>

        <div class="divider"></div>

        <h2>Voto MVP</h2>
        <div id="voteBox" class="muted small">Il voto appare solo quando l‚Äôadmin lo apre.</div>
      </div>
    </div>
  </div>

  <!-- 1) Config (DEVE esistere e impostare window.SUPABASE_URL / window.SUPABASE_ANON_KEY) -->
  <script src="config.js" onerror="document.getElementById('err').textContent='ERRORE: config.js non caricato';"></script>

  <!-- 2) Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ===== Helpers =====
    function fmtDate(d){
      // d: 'YYYY-MM-DD'
      if(!d) return '';
      const [y,m,dd]=d.split('-');
      return `${dd}/${m}/${y}`;
    }

    function safeText(s){ return (s ?? '').toString(); }

    // ===== Init =====
    const errEl = document.getElementById('err');
    const statusEl = document.getElementById('status');
    const matchEl = document.getElementById('match');
    const calledEl = document.getElementById('called');
    const voteBox = document.getElementById('voteBox');

    function setError(msg){
      errEl.textContent = msg || '';
    }

    function supabaseConfigOk(){
      return window.SUPABASE_URL && window.SUPABASE_ANON_KEY &&
             window.SUPABASE_URL.startsWith('http') &&
             window.SUPABASE_ANON_KEY.startsWith('ey');
    }

    if(!supabaseConfigOk()){
      statusEl.innerHTML = `<span class="pill bad">‚ö†Ô∏è Config Supabase non valida</span>`;
      setError('Controlla config.js: devono esserci SUPABASE_URL e SUPABASE_ANON_KEY corretti.');
      throw new Error('Supabase config missing/invalid');
    }

    const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    async function loadLatestMatch(){
      setError('');
      statusEl.innerHTML = `<span class="dot"></span>Caricamento‚Ä¶`;

      // Prendo l‚Äôultima partita inserita (match_date + match_time)
      // Se preferisci ‚Äúla prossima‚Äù, poi la adattiamo con un filtro su data >= oggi.
      const { data: matches, error } = await client
        .from('matches')
        .select('id, match_date, match_time, venue, voting_open, team_a_keeper_id, team_b_keeper_id, score_a, score_b, called_up')
        .order('match_date', { ascending: false })
        .order('match_time', { ascending: false })
        .limit(1);

      if(error){
        statusEl.innerHTML = `<span class="pill bad">‚ùå Errore</span>`;
        setError('Errore matches: ' + error.message);
        return;
      }

      if(!matches || matches.length === 0){
        statusEl.innerHTML = `<span class="pill warn">üìå Nessuna partita creata</span>`;
        matchEl.innerHTML = `<div class="muted">Quando crei una partita dall‚ÄôAdmin, apparir√† qui.</div>`;
        calledEl.innerHTML = '';
        voteBox.innerHTML = `<div class="muted small">Nessuna partita: niente voto.</div>`;
        return;
      }

      const m = matches[0];

      // Carico i portieri (nomi) dalla tabella players
      let keeperA = 'Squadra A';
      let keeperB = 'Squadra B';

      const keeperIds = [m.team_a_keeper_id, m.team_b_keeper_id].filter(Boolean);
      if(keeperIds.length){
        const { data: keepers, error: kerr } = await client
          .from('players')
          .select('id, name')
          .in('id', keeperIds);

        if(!kerr && keepers){
          const map = new Map(keepers.map(x => [x.id, x.name]));
          keeperA = map.get(m.team_a_keeper_id) || keeperA;
          keeperB = map.get(m.team_b_keeper_id) || keeperB;
        }
      }

      // Stato partita
      const played = (m.score_a !== null && m.score_b !== null);
      statusEl.innerHTML = played
        ? `<span class="pill ok">‚úÖ Partita giocata</span>`
        : `<span class="pill warn">üïí Da giocare</span>`;

      // Card partita
      const dateStr = fmtDate(m.match_date);
      const timeStr = safeText(m.match_time || '21:00');
      const venueStr = safeText(m.venue || 'Campo a 6 - Aradeo');

      // Risultato
      const resultHtml = played
        ? `<div class="result">
             <div>
               <div class="muted small">Risultato</div>
               <strong>üèÅ ${m.score_a}-${m.score_b}</strong>
             </div>
             <span class="pill ok">GIOCATA</span>
           </div>`
        : `<div class="result">
             <div>
               <div class="muted small">Risultato</div>
               <strong>üèÅ Risultato: da giocare</strong>
             </div>
             <span class="pill warn">DA GIOCARE</span>
           </div>`;

      matchEl.innerHTML = `
        <div class="row">
          <span class="pill">üìÖ ${dateStr}</span>
          <span class="pill">üïò ${timeStr}</span>
          <span class="pill">üìç ${venueStr}</span>
        </div>

        <div class="divider"></div>

        <div class="teams">
          <div class="team">
            <div class="left">
              <div class="jersey yellow" title="Squadra A"></div>
              <div style="min-width:0">
                <div class="label">Squadra A</div>
                <div class="title">${safeText(keeperA)}</div>
              </div>
            </div>
          </div>

          <div class="team">
            <div class="left">
              <div class="jersey red" title="Squadra B"></div>
              <div style="min-width:0">
                <div class="label">Squadra B</div>
                <div class="title">${safeText(keeperB)}</div>
              </div>
            </div>
          </div>
        </div>

        ${resultHtml}

        <div class="map">
          <iframe
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps?q=Campo%20a%206%20Aradeo&output=embed">
          </iframe>
        </div>
      `;

      // Convocati (called_up: array uuid)
      calledEl.innerHTML = '';
      const calledIds = Array.isArray(m.called_up) ? m.called_up : [];

      if(calledIds.length){
        const { data: players, error: perr } = await client
          .from('players')
          .select('id, name')
          .in('id', calledIds);

        if(perr){
          // non blocchiamo pagina, solo messaggio
          calledEl.innerHTML = `<div class="muted small">Convocati non disponibili.</div>`;
        } else {
          // ordina per nome
          players.sort((a,b) => a.name.localeCompare(b.name, 'it'));
          players.forEach(p => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = p.name;
            calledEl.appendChild(chip);
          });
        }
      } else {
        calledEl.innerHTML = `<div class="muted">Nessun convocato</div>`;
      }

      // Voto MVP (se aperto mostra link)
      if(m.voting_open){
        voteBox.innerHTML = `
          <a class="btn good" href="vota.html?match=${encodeURIComponent(m.id)}">
            ‚≠ê Vota MVP
          </a>
        `;
      } else {
        voteBox.innerHTML = `<div class="muted small">Voto MVP: <b>chiuso</b>.</div>`;
      }
    }

    loadLatestMatch();
  </script>
</body>
</html>
