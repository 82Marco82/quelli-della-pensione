<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Quelli della pensione</title>

<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* ================= BASE ================= */
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow:0 6px 20px rgba(0,0,0,.08);
}
body.dark{
  --bg:#0f1115;
  --card:#171a21;
  --text:#e5e7eb;
  --muted:#a1a1aa;
  --border:#2a2f3a;
  --shadow:0 10px 28px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:760px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  box-shadow:var(--shadow);
  margin:14px 0;
}

/* ================= HEADER ================= */
.header{text-align:center}
.logo{
  width:80px;height:80px;border-radius:999px;
  background:#111;
  margin:auto;
  display:flex;align-items:center;justify-content:center;
  color:#fff;font-family:'Bebas Neue';font-size:36px;
}
h1{font-family:'Bebas Neue';letter-spacing:2px;font-size:46px;margin:10px 0}

/* ================= PLAYER CARD ================= */
.pCard{
  display:flex;
  align-items:center;
  gap:14px;
  padding:12px;
  border:1px solid var(--border);
  border-radius:16px;
  margin-top:10px;
}
.pAvatar{
  width:58px;
  height:58px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #fff;
}
.pName{
  font-weight:900;
  font-size:16px;
}
.pRole{
  font-size:13px;
  color:var(--muted);
  font-weight:800;
}

/* ================= FORMATIONS HEADER ================= */
.formHeader{
  text-align:center;
  padding:18px;
}
.vsWrap{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:20px;
}
.vsAvatar{
  width:70px;height:70px;border-radius:50%;
  object-fit:cover;
  border:4px solid #fff;
  animation: glovesIn .6s ease;
}
.vsText{
  font-family:'Bebas Neue';
  font-size:28px;
  letter-spacing:2px;
}
@keyframes glovesIn{
  from{transform:scale(.6);opacity:0}
  to{transform:scale(1);opacity:1}
}

/* ================= MVP ================= */
.mvpRow{
  display:flex;
  align-items:center;
  gap:12px;
  margin-top:10px;
}
.mvpAvatar{
  width:54px;height:54px;border-radius:50%;
  object-fit:cover;
}
</style>
</head>

<body>
<div class="wrap">

<div class="header card">
  <div class="logo">QDP</div>
  <h1>Quelli della pensione</h1>
</div>

<div class="card">
  <h3>Convocati</h3>
  <div id="called">‚Äî</div>
</div>

<div id="formationsBox" class="card" style="display:none">
  <div class="formHeader">
    <div class="vsWrap">
      <img id="gkAImg" class="vsAvatar">
      <div class="vsText">VS</div>
      <img id="gkBImg" class="vsAvatar">
    </div>
    <h2 style="margin-top:12px;font-family:'Bebas Neue'">FORMAZIONI</h2>
  </div>

  <h3>Squadra A</h3>
  <div id="teamA"></div>

  <h3 style="margin-top:14px">Squadra B</h3>
  <div id="teamB"></div>
</div>

<div class="card">
  <h3>üèÜ MVP</h3>
  <div id="mvpBox">‚Äî</div>
</div>

</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
const AVATAR_BASE="avatars/";
const DEFAULT_AVATAR="default.png";

function avatar(a){return AVATAR_BASE+(a||DEFAULT_AVATAR);}
function isGK(p){return (p.role||"").toUpperCase()==="GK";}
function rankPos(p){
  if(isGK(p))return 0;
  const s=(p.position||"").toLowerCase();
  if(s.includes("dif"))return 1;
  if(s.includes("centro"))return 2;
  if(s.includes("att"))return 3;
  if(s.includes("jolly"))return 4;
  return 5;
}

const client=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

async function load(){
  const {data:match}=await client.from("matches")
    .select("id,called_up,team_a,team_b")
    .order("match_date",{ascending:false}).limit(1).single();

  const ids=[...(match.called_up||[])];
  const {data:players}=await client.from("players")
    .select("id,name,role,position,avatar").in("id",ids);

  players.sort((a,b)=>rankPos(a)-rankPos(b)||a.name.localeCompare(b.name,"it"));

  document.getElementById("called").innerHTML=
    players.map(p=>`
      <div class="pCard">
        <img class="pAvatar" src="${avatar(p.avatar)}">
        <div>
          <div class="pName">${p.name}${isGK(p)?" üß§":""}</div>
          <div class="pRole">${p.position}</div>
        </div>
      </div>`).join("");

  if(match.team_a?.length && match.team_b?.length){
    document.getElementById("formationsBox").style.display="block";

    const map=new Map(players.map(p=>[p.id,p]));
    const gkA=match.team_a.map(id=>map.get(id)).find(isGK);
    const gkB=match.team_b.map(id=>map.get(id)).find(isGK);

    if(gkA)document.getElementById("gkAImg").src=avatar(gkA.avatar);
    if(gkB)document.getElementById("gkBImg").src=avatar(gkB.avatar);

    document.getElementById("teamA").innerHTML=
      match.team_a.map(id=>map.get(id)).map(p=>`
        <div class="pCard">
          <img class="pAvatar" src="${avatar(p.avatar)}">
          <div>
            <div class="pName">${p.name}${isGK(p)?" üß§":""}</div>
            <div class="pRole">${p.position}</div>
          </div>
        </div>`).join("");

    document.getElementById("teamB").innerHTML=
      match.team_b.map(id=>map.get(id)).map(p=>`
        <div class="pCard">
          <img class="pAvatar" src="${avatar(p.avatar)}">
          <div>
            <div class="pName">${p.name}${isGK(p)?" üß§":""}</div>
            <div class="pRole">${p.position}</div>
          </div>
        </div>`).join("");
  }

  const {data:votes}=await client.from("mvp_votes")
    .select("voted_player").eq("match_id",match.id);

  const cnt={};
  votes.forEach(v=>cnt[v.voted_player]=(cnt[v.voted_player]||0)+1);
  const arr=Object.entries(cnt).sort((a,b)=>b[1]-a[1]);

  if(!arr.length)return;

  const max=arr[0][1];
  const tops=arr.filter(x=>x[1]===max).map(x=>players.find(p=>p.id===x[0]));

  document.getElementById("mvpBox").innerHTML=
    tops.map(p=>`
      <div class="mvpRow">
        <img class="mvpAvatar" src="${avatar(p.avatar)}">
        <b>${p.name}</b>
      </div>`).join("");
}

load();
</script>
</body>
</html>
