<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <style>
    body{font-family:system-ui;margin:0;background:#f4f6f8}
    .wrap{max-width:980px;margin:24px auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
    .top a{color:#0b5fff;text-decoration:none}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:420px 1fr}}
    .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    h1{margin:0;font-size:20px}
    h2{margin:0 0 10px;font-size:16px}
    label{display:block;font-size:12px;margin:10px 0 6px;color:#333}
    input,select{width:100%;padding:10px;border:1px solid #cfd6dd;border-radius:10px;font-size:14px;background:#fff}
    button{padding:10px 12px;border:0;border-radius:10px;background:#111;color:#fff;font-weight:800;cursor:pointer}
    button.secondary{background:#444}
    button.danger{background:#b00020}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .msg{margin-top:10px;padding:10px;border-radius:10px;background:#f1f5f9;color:#111;font-size:13px;white-space:pre-wrap}
    .ok{background:#dcfce7;color:#166534}
    .err{background:#ffe4e6;color:#9f1239}
    .muted{color:#666;font-size:12px}
    .playersBox{max-height:420px;overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .pRow{display:flex;align-items:center;gap:8px;padding:6px 4px;border-radius:10px}
    .pRow:hover{background:#f6f7fb}
    .pill{display:inline-block;background:#eee;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Dashboard</h1>
        <div class="muted">Quelli della pensione</div>
      </div>
      <div class="row">
        <a href="index.html">Torna al sito</a>
        <button id="btnLogout" class="secondary">Esci</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Crea / aggiorna partita</h2>
        <div id="msg" class="msg">Caricamento…</div>

        <label>Seleziona partita</label>
        <select id="matchSelect">
          <option value="">-- nuova partita --</option>
        </select>

        <div class="row" style="margin-top:10px">
          <button id="btnNew">Nuova partita</button>
          <button id="btnRefresh" class="secondary">Aggiorna lista</button>
        </div>

        <label>Data</label>
        <input id="matchDate" type="date" />

        <label>Ora</label>
        <input id="matchTime" type="time" value="21:00" />

        <label>Campo</label>
        <input id="venue" type="text" value="Campo a 6 - Aradeo" />

        <label>Portiere Squadra A</label>
        <input id="keeperA" type="text" placeholder="Es. Gianni" />

        <label>Portiere Squadra B</label>
        <input id="keeperB" type="text" placeholder="Es. Andrea o Tonino" />

        <label>Convocati (max 12)</label>
        <div class="playersBox" id="playersBox"></div>
        <div class="muted" id="countInfo">Convocati: 0/12</div>

        <div class="row" style="margin-top:12px">
          <button id="btnSave">Salva</button>
          <button id="btnDelete" class="danger">Elimina partita</button>
        </div>
      </div>

      <div class="card">
        <h2>Anteprima</h2>
        <div id="preview" class="muted">Nessuna partita selezionata.</div>
        <div style="margin-top:14px">
          <button id="btnAddPlayer" class="secondary">Aggiungi nuovo giocatore</button>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const msgEl = $("msg");
    const previewEl = $("preview");
    const countInfoEl = $("countInfo");

    function setMsg(t, kind="info"){
      msgEl.className = "msg";
      if(kind==="ok") msgEl.classList.add("ok");
      if(kind==="err") msgEl.classList.add("err");
      msgEl.textContent = t;
    }

    if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
      setMsg("Config mancante: controlla config.js","err");
      throw new Error("Missing config");
    }
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let PLAYERS = [];
    let MATCHES = [];
    let CURRENT = null;

    async function requireSession(){
      const { data: { session }, error } = await client.auth.getSession();
      if(error){ setMsg("Errore sessione: "+error.message,"err"); return false; }
      if(!session){ location.href="admin.html"; return false; }
      return true;
    }

    async function loadPlayers(){
      const { data, error } = await client.from("players").select("id,name").order("name",{ascending:true});
      if(error) throw error;
      PLAYERS = data || [];
      renderPlayersBox();
    }

    async function loadMatches(){
      const { data, error } = await client
        .from("matches")
        .select("id,match_date,match_time,venue,called_up,keeper_a,keeper_b")
        .order("match_date",{ascending:false})
        .order("match_time",{ascending:false})
        .limit(50);
      if(error) throw error;
      MATCHES = data || [];
      renderMatchesSelect();
    }

    function renderMatchesSelect(){
      const sel = $("matchSelect");
      sel.innerHTML = `<option value="">-- nuova partita --</option>`;
      MATCHES.forEach(m=>{
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = `${m.match_date} ${String(m.match_time||"").slice(0,5)} – ${m.venue||""}`.trim();
        sel.appendChild(opt);
      });
    }

    function renderPlayersBox(checkedIds=[]){
      const box = $("playersBox");
      const checked = new Set((checkedIds||[]).map(String));
      box.innerHTML = "";

      PLAYERS.forEach(p=>{
        const row = document.createElement("label");
        row.className = "pRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = p.id;
        cb.checked = checked.has(String(p.id));
        cb.onchange = () => {
          const ids = getCalledUp();
          if(ids.length > 12){
            cb.checked = false;
            setMsg("Max 12 convocati.","err");
          }
          updateCount();
          renderPreview();
        };

        const name = document.createElement("span");
        name.textContent = p.name;

        row.appendChild(cb);
        row.appendChild(name);
        box.appendChild(row);
      });

      updateCount();
    }

    function getCalledUp(){
      return [...$("playersBox").querySelectorAll('input[type="checkbox"]')]
        .filter(x=>x.checked)
        .map(x=>x.value);
    }

    function updateCount(){
      countInfoEl.textContent = `Convocati: ${getCalledUp().length}/12`;
    }

    function fillForm(m){
      CURRENT = m;
      $("matchDate").value = m.match_date || "";
      $("matchTime").value = String(m.match_time||"21:00:00").slice(0,5);
      $("venue").value = m.venue || "Campo a 6 - Aradeo";
      $("keeperA").value = m.keeper_a || "";
      $("keeperB").value = m.keeper_b || "";
      renderPlayersBox(m.called_up || []);
      renderPreview();
    }

    function clearForm(){
      CURRENT = null;
      $("matchSelect").value = "";
      $("matchDate").value = "";
      $("matchTime").value = "21:00";
      $("venue").value = "Campo a 6 - Aradeo";
      $("keeperA").value = "";
      $("keeperB").value = "";
      renderPlayersBox([]);
      previewEl.textContent = "Nessuna partita selezionata.";
    }

    function renderPreview(){
      const d = $("matchDate").value || "-";
      const t = $("matchTime").value || "21:00";
      const v = $("venue").value || "-";
      const a = $("keeperA").value || "-";
      const b = $("keeperB").value || "-";
      const ids = getCalledUp();

      const map = new Map(PLAYERS.map(p=>[String(p.id), p.name]));
      const names = ids.map(id=>map.get(String(id))).filter(Boolean);

      previewEl.innerHTML = `
        <div><b>Data:</b> ${d} ${t}</div>
        <div><b>Campo:</b> ${v}</div>
        <div style="margin-top:8px"><b>Squadra A:</b> ${a}</div>
        <div><b>Squadra B:</b> ${b}</div>
        <div style="margin-top:12px"><b>Convocati (${names.length}/12)</b></div>
        <div>${names.length ? names.map(n=>`<span class="pill">${n}</span>`).join("") : "<span class='muted'>Nessun convocato</span>"}</div>
      `;
    }

    async function save(){
      const match_date = $("matchDate").value;
      const match_time = ($("matchTime").value ? $("matchTime").value + ":00" : "21:00:00");
      const venue = $("venue").value || "Campo a 6 - Aradeo";
      const keeper_a = $("keeperA").value.trim();
      const keeper_b = $("keeperB").value.trim();
      const called_up = getCalledUp();

      if(!match_date) return setMsg("Inserisci la data.","err");
      if(!keeper_a || !keeper_b) return setMsg("Inserisci i 2 portieri.","err");
      if(keeper_a.toLowerCase() === keeper_b.toLowerCase()) return setMsg("I portieri devono essere diversi.","err");
      if(called_up.length > 12) return setMsg("Max 12 convocati.","err");

      const payload = { match_date, match_time, venue, called_up, keeper_a, keeper_b };

      try{
        if(CURRENT && CURRENT.id){
          const { error } = await client.from("matches").update(payload).eq("id", CURRENT.id);
          if(error) throw error;
          setMsg("Partita aggiornata ✅","ok");
        }else{
          const { data, error } = await client.from("matches").insert([payload]).select("*").single();
          if(error) throw error;
          setMsg("Partita creata ✅","ok");
          CURRENT = data;
          $("matchSelect").value = data.id;
        }
        await loadMatches();
      }catch(e){
        console.error(e);
        setMsg("Errore salvataggio: " + (e.message||e),"err");
      }
    }

    async function del(){
      if(!CURRENT) return setMsg("Seleziona una partita.","err");
      if(!confirm("Sicuro di eliminare questa partita?")) return;
      const { error } = await client.from("matches").delete().eq("id", CURRENT.id);
      if(error) return setMsg("Errore eliminazione: "+error.message,"err");
      setMsg("Partita eliminata ✅","ok");
      clearForm();
      await loadMatches();
    }

    async function addPlayer(){
      const name = prompt("Nome nuovo giocatore:");
      if(!name) return;
      const clean = name.trim();
      if(!clean) return;

      const { data: existing, error: e1 } = await client.from("players").select("id").ilike("name", clean).limit(1);
      if(e1) return setMsg("Errore: "+e1.message,"err");
      if(existing && existing.length) return setMsg("Giocatore già presente.","err");

      const { error } = await client.from("players").insert([{ name: clean }]);
      if(error) return setMsg("Errore insert: "+error.message,"err");

      setMsg("Giocatore aggiunto ✅","ok");
      await loadPlayers();
      renderPreview();
    }

    async function logout(){
      setMsg("Logout…");
      const { error } = await client.auth.signOut();
      if(error) return setMsg("Errore logout: "+error.message,"err");
      location.href="admin.html";
    }

    $("matchSelect").addEventListener("change", ()=>{
      const id = $("matchSelect").value;
      if(!id) return clearForm();
      const m = MATCHES.find(x=>String(x.id)===String(id));
      if(m) fillForm(m);
    });

    $("btnNew").addEventListener("click", ()=>{ clearForm(); setMsg("Nuova partita: compila e salva.","ok"); });
    $("btnRefresh").addEventListener("click", async ()=>{ setMsg("Aggiorno…"); await loadMatches(); setMsg("Lista aggiornata ✅","ok"); });
    $("btnSave").addEventListener("click", save);
    $("btnDelete").addEventListener("click", del);
    $("btnAddPlayer").addEventListener("click", addPlayer);
    $("btnLogout").addEventListener("click", logout);

    ["matchDate","matchTime","venue","keeperA","keeperB"].forEach(id=>{
      $(id).addEventListener("input", renderPreview);
      $(id).addEventListener("change", renderPreview);
    });

    (async function init(){
      const ok = await requireSession();
      if(!ok) return;
      try{
        setMsg("Caricamento…");
        await loadPlayers();
        await loadMatches();
        clearForm();
        setMsg("Pronto ✅","ok");
      }catch(e){
        console.error(e);
        setMsg("Errore init: " + (e.message||e),"err");
      }
    })();
  </script>
</body>
</html>
