<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --shadow:0 6px 20px rgba(0,0,0,.08); --border:#e5e7eb; --link:#0b5fff;
      --pill:#eeeeee; --logo1:#111; --logo2:#333; --btn:#111; --btn2:#444; --danger:#b00020;
      --okBg:#dcfce7; --okText:#166534; --errBg:#ffe4e6; --errText:#9f1239;
      --chipBg:rgba(0,0,0,.04);
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
      --shadow:0 10px 28px rgba(0,0,0,.45); --border:#2a2f3a; --link:#7aa7ff;
      --pill:#222631; --logo1:#0b0e14; --logo2:#2a3242; --btn:#0b0e14; --btn2:#2a3242; --danger:#ff4d4d;
      --okBg:rgba(34,197,94,.15); --okText:#86efac; --errBg:rgba(244,63,94,.16); --errText:#fda4af;
      --chipBg:rgba(255,255,255,.04);
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui;margin:0;background:var(--bg);color:var(--text);transition:.2s}
    a{color:var(--link);text-decoration:none}
    .wrap{max-width:1020px;margin:22px auto;padding:16px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:52px;height:52px;border-radius:999px;background:linear-gradient(135deg,var(--logo1),var(--logo2));
      display:flex;align-items:center;justify-content:center;box-shadow:0 10px 22px rgba(0,0,0,.18);
      border:2px solid rgba(255,255,255,.85)}
    body.dark .logo{border:2px solid rgba(255,255,255,.12)}
    .logo span{font-family:'Bebas Neue',sans-serif;color:#fff;font-size:22px;letter-spacing:2px}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:12px}
    .topRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:440px 1fr}}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    h2{margin:0 0 10px;font-size:16px}
    label{display:block;font-size:12px;margin:10px 0 6px;color:var(--muted)}
    input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:14px;background:transparent;color:var(--text);outline:none}
    input:focus,select:focus{border-color:rgba(11,95,255,.45)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:14px;border:1px solid transparent;
      background:var(--btn);color:#fff;font-weight:900;cursor:pointer;user-select:none}
    .btn:active{transform:scale(.99)}
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:var(--danger)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.small{padding:10px 12px;border-radius:12px;font-weight:800}
    .btn.full{width:100%}
    .actionBar{position:sticky;bottom:12px;margin-top:12px;padding:10px;border-radius:16px;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow)}
    .msg{margin-top:10px;padding:12px;border-radius:14px;background:var(--chipBg);border:1px solid var(--border);font-size:13px;white-space:pre-wrap}
    .msg.ok{background:var(--okBg);color:var(--okText);border-color:rgba(34,197,94,.35)}
    .msg.err{background:var(--errBg);color:var(--errText);border-color:rgba(244,63,94,.35);font-weight:800}
    .playersBox{max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:14px;padding:10px}
    .pRow{display:flex;align-items:center;gap:10px;padding:10px 8px;border-radius:12px}
    .pRow:hover{background:var(--chipBg)}
    .pRow input{width:auto;transform:scale(1.15)}
    .countChip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:var(--chipBg);font-weight:900;font-size:12px;margin-top:10px}
    .pill{display:inline-block;background:var(--pill);border-radius:999px;padding:8px 10px;margin:6px 8px 0 0;font-weight:900;border:1px solid var(--border)}
    .hint{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.35}
    .previewBox{border:1px solid var(--border);background:var(--chipBg);border-radius:16px;padding:12px}
    .banner{border:1px solid var(--border);background:linear-gradient(135deg, rgba(11,95,255,.10), rgba(34,197,94,.08));
      border-radius:16px;padding:12px;margin-bottom:12px}
    body.dark .banner{background:linear-gradient(135deg, rgba(122,167,255,.12), rgba(34,197,94,.10))}
    .bannerTitle{font-weight:900}
    .bannerLine{margin-top:6px;color:var(--muted);font-size:13px}
    .fab{position:fixed;right:16px;bottom:16px;width:54px;height:54px;border-radius:999px;border:1px solid var(--border);
      background:var(--card);color:var(--text);font-size:22px;font-weight:900;cursor:pointer;box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center;z-index:9999;user-select:none}
    .fab:active{transform:scale(.98)}
    .twoCols{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){.twoCols{grid-template-columns:1fr 1fr}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"><span>QDP</span></div>
        <div>
          <h1>Dashboard</h1>
          <div class="muted">Quelli della pensione</div>
        </div>
      </div>

      <div class="topRight">
        <a href="index.html">‚¨ÖÔ∏è Torna al sito</a>
        <a href="storico.html">üìö Storico</a>
        <button id="btnLogout" class="btn secondary small">üö™ Esci</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Gestione partita</h2>
        <div id="msg" class="msg">Caricamento‚Ä¶</div>

        <label>Seleziona partita</label>
        <select id="matchSelect">
          <option value="">-- nuova partita --</option>
        </select>

        <div class="row" style="margin-top:10px">
          <button id="btnNew" class="btn ghost small">‚ûï Nuova</button>
          <button id="btnRefresh" class="btn ghost small">üîÑ Aggiorna</button>
        </div>

        <label>Data</label>
        <input id="matchDate" type="date" />

        <label>Ora</label>
        <input id="matchTime" type="time" value="21:00" />

        <label>Campo</label>
        <input id="venue" type="text" value="Campo a 6 - Aradeo" />

        <label>Portiere Squadra A</label>
        <input id="keeperA" type="text" placeholder="Es. Gianni" />

        <label>Portiere Squadra B</label>
        <input id="keeperB" type="text" placeholder="Es. Andrea o Tonino" />

        <label>Convocati (max 12)</label>
        <div class="playersBox" id="playersBox"></div>
        <div class="countChip" id="countInfo">üë• Convocati: 0/12</div>

        <div class="actionBar">
          <div class="row" style="justify-content:space-between;width:100%">
            <button id="btnSave" class="btn" style="flex:1">üíæ Salva</button>
            <button id="btnDelete" class="btn danger" style="flex:1">üóë Elimina</button>
          </div>
          <div class="hint">
            Risultato e formazioni si mettono a fine partita (a destra). Non sono obbligatori.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="banner">
          <div class="bannerTitle">üìå Partita attuale</div>
          <div id="bannerText" class="bannerLine">Nessuna partita caricata.</div>

          <div class="row" style="margin-top:10px">
            <button id="btnCopyLink" class="btn ghost small" style="flex:1">üìã Copia link</button>
            <button id="btnCopyCalled" class="btn ghost small" style="flex:1">üìã Copia convocati</button>
            <button id="btnWhatsApp" class="btn ghost small" style="flex:1">üì§ WhatsApp</button>
          </div>
          <div id="shareMsg" class="hint"></div>
        </div>

        <h2>Fine partita</h2>

        <div class="twoCols">
          <div>
            <label>Gol Squadra A</label>
            <input id="scoreA" type="number" min="0" step="1" placeholder="Es. 6">
          </div>
          <div>
            <label>Gol Squadra B</label>
            <input id="scoreB" type="number" min="0" step="1" placeholder="Es. 4">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnSaveResult" class="btn full">üèÅ Salva risultato (e formazioni)</button>
        </div>

        <div class="hint">
          Le formazioni qui sotto sono <b>facoltative</b>. Se non le inserisci, puoi comunque salvare il risultato.
        </div>

        <h2 style="margin-top:14px">Formazioni (facoltative)</h2>

        <label>Formazione Squadra A</label>
        <div class="playersBox" id="teamABox"></div>

        <label>Formazione Squadra B</label>
        <div class="playersBox" id="teamBBox"></div>

        <h2 style="margin-top:14px">Anteprima</h2>
        <div class="previewBox" id="preview"><span class="muted">Nessuna partita selezionata.</span></div>

        <div style="margin-top:14px" class="row">
          <button id="btnAddPlayer" class="btn secondary full">‚ûï Aggiungi giocatore</button>
        </div>
      </div>
    </div>
  </div>

  <button id="themeToggle" class="fab" title="Tema chiaro/scuro">üåô</button>

  <script>
    const btnTheme = document.getElementById("themeToggle");
    function setTheme(mode){
      document.body.classList.toggle("dark", mode === "dark");
      btnTheme.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("qdp_theme", mode);
    }
    const savedTheme = localStorage.getItem("qdp_theme");
    setTheme(savedTheme === "dark" ? "dark" : "light");
    btnTheme.addEventListener("click", () => setTheme(document.body.classList.contains("dark") ? "light" : "dark"));
  </script>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const msgEl = $("msg");
    const previewEl = $("preview");
    const countInfoEl = $("countInfo");
    const bannerTextEl = $("bannerText");
    const shareMsgEl = $("shareMsg");

    const SITE_LINK = (location.origin + location.pathname).replace(/dashboard\.html$/i, "index.html");

    function setMsg(t, kind="info"){
      msgEl.className = "msg";
      if(kind==="ok") msgEl.classList.add("ok");
      if(kind==="err") msgEl.classList.add("err");
      msgEl.textContent = t;
    }
    function setBanner(text){ bannerTextEl.textContent = text; }
    function setShareMsg(text){ shareMsgEl.textContent = text || ""; }

    if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
      setMsg("Config mancante: controlla config.js","err");
      throw new Error("Missing config");
    }
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let PLAYERS = [];
    let MATCHES = [];
    let CURRENT = null;

    async function requireSession(){
      const { data: { session }, error } = await client.auth.getSession();
      if(error){ setMsg("Errore sessione: "+error.message,"err"); return false; }
      if(!session){ location.href="admin.html"; return false; }
      return true;
    }

    async function loadPlayers(){
      const { data, error } = await client.from("players").select("id,name").order("name",{ascending:true});
      if(error) throw error;
      PLAYERS = data || [];
      renderPlayersBox();
      renderTeamBoxes(); // vuoti finch√© non selezioni partita
    }

    async function loadMatches(){
      const { data, error } = await client
        .from("matches")
        .select("id,match_date,match_time,venue,called_up,keeper_a,keeper_b,score_a,score_b,team_a,team_b,is_finished")
        .order("match_date",{ascending:false})
        .order("match_time",{ascending:false})
        .limit(100);
      if(error) throw error;
      MATCHES = data || [];
      renderMatchesSelect();
    }

    function renderMatchesSelect(){
      const sel = $("matchSelect");
      sel.innerHTML = `<option value="">-- nuova partita --</option>`;
      MATCHES.forEach(m=>{
        const time = String(m.match_time||"").slice(0,5);
        const res = (m.score_a!=null && m.score_b!=null) ? ` ‚Ä¢ ${m.score_a}-${m.score_b}` : "";
        const opt = document.createElement("option");
        opt.value = m.id;
        opt.textContent = `${m.match_date} ${time} ‚Äì ${m.venue||""}${res}`.trim();
        sel.appendChild(opt);
      });
    }

    function renderPlayersBox(checkedIds=[]){
      const box = $("playersBox");
      const checked = new Set((checkedIds||[]).map(String));
      box.innerHTML = "";

      PLAYERS.forEach(p=>{
        const row = document.createElement("label");
        row.className = "pRow";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = p.id;
        cb.checked = checked.has(String(p.id));
        cb.onchange = () => {
          const ids = getCalledUp();
          if(ids.length > 12){
            cb.checked = false;
            setMsg("‚ö†Ô∏è Massimo 12 convocati.","err");
          } else {
            setMsg("‚úÖ Convocati aggiornati (ricorda di salvare).","ok");
          }
          updateCount();
          renderPreview();
          renderBannerFromForm();
          renderTeamBoxes(); // le formazioni seguono i convocati
        };
        const name = document.createElement("span");
        name.textContent = p.name;
        row.appendChild(cb); row.appendChild(name);
        box.appendChild(row);
      });

      updateCount();
    }

    function getCalledUp(){
      return [...$("playersBox").querySelectorAll('input[type="checkbox"]')]
        .filter(x=>x.checked)
        .map(x=>x.value);
    }

    function updateCount(){
      countInfoEl.textContent = `üë• Convocati: ${getCalledUp().length}/12`;
    }

    // --- TEAM BOXES (solo convocati) ---
    function renderTeamBoxes(teamAIds=[], teamBIds=[]){
      const called = new Set(getCalledUp().map(String));
      const aSet = new Set((teamAIds||[]).map(String));
      const bSet = new Set((teamBIds||[]).map(String));

      const teamABox = $("teamABox");
      const teamBBox = $("teamBBox");
      teamABox.innerHTML = "";
      teamBBox.innerHTML = "";

      // mostra solo convocati
      const calledPlayers = PLAYERS.filter(p => called.has(String(p.id)));

      calledPlayers.forEach(p=>{
        // A
        const rowA = document.createElement("label");
        rowA.className = "pRow";
        const cbA = document.createElement("input");
        cbA.type = "checkbox";
        cbA.value = p.id;
        cbA.checked = aSet.has(String(p.id));
        cbA.onchange = () => {
          // evita che uno stia in entrambe
          if(cbA.checked){
            const cbB = teamBBox.querySelector(`input[value="${p.id}"]`);
            if(cbB) cbB.checked = false;
          }
          renderPreview();
        };
        const nameA = document.createElement("span");
        nameA.textContent = p.name;
        rowA.appendChild(cbA); rowA.appendChild(nameA);
        teamABox.appendChild(rowA);

        // B
        const rowB = document.createElement("label");
        rowB.className = "pRow";
        const cbB = document.createElement("input");
        cbB.type = "checkbox";
        cbB.value = p.id;
        cbB.checked = bSet.has(String(p.id));
        cbB.onchange = () => {
          if(cbB.checked){
            const cbA2 = teamABox.querySelector(`input[value="${p.id}"]`);
            if(cbA2) cbA2.checked = false;
          }
          renderPreview();
        };
        const nameB = document.createElement("span");
        nameB.textContent = p.name;
        rowB.appendChild(cbB); rowB.appendChild(nameB);
        teamBBox.appendChild(rowB);
      });
    }

    function getTeamIds(boxId){
      return [...document.getElementById(boxId).querySelectorAll('input[type="checkbox"]')]
        .filter(x=>x.checked)
        .map(x=>x.value);
    }

    function fillForm(m){
      CURRENT = m;

      $("matchDate").value = m.match_date || "";
      $("matchTime").value = String(m.match_time||"21:00:00").slice(0,5);
      $("venue").value = m.venue || "Campo a 6 - Aradeo";
      $("keeperA").value = m.keeper_a || "";
      $("keeperB").value = m.keeper_b || "";

      renderPlayersBox(m.called_up || []);

      $("scoreA").value = (m.score_a==null ? "" : m.score_a);
      $("scoreB").value = (m.score_b==null ? "" : m.score_b);

      // dopo convocati, render team boxes con i valori salvati
      renderTeamBoxes(m.team_a || [], m.team_b || []);

      renderPreview();
      renderBannerFromForm();
      setMsg("üìå Partita caricata. Puoi anche inserire risultato e formazioni.","ok");
    }

    function clearForm(){
      CURRENT = null;
      $("matchSelect").value = "";
      $("matchDate").value = "";
      $("matchTime").value = "21:00";
      $("venue").value = "Campo a 6 - Aradeo";
      $("keeperA").value = "";
      $("keeperB").value = "";
      $("scoreA").value = "";
      $("scoreB").value = "";
      renderPlayersBox([]);
      renderTeamBoxes([],[]);
      previewEl.innerHTML = `<span class="muted">Nessuna partita selezionata.</span>`;
      setBanner("Nessuna partita caricata.");
      setShareMsg("");
    }

    function renderPreview(){
      const d = $("matchDate").value || "-";
      const t = $("matchTime").value || "21:00";
      const v = $("venue").value || "-";
      const a = $("keeperA").value || "-";
      const b = $("keeperB").value || "-";
      const ids = getCalledUp();

      const scoreA = $("scoreA").value;
      const scoreB = $("scoreB").value;
      const hasScore = (scoreA !== "" && scoreB !== "");

      const map = new Map(PLAYERS.map(p=>[String(p.id), p.name]));
      const names = ids.map(id=>map.get(String(id))).filter(Boolean);

      const teamA = getTeamIds("teamABox").map(id=>map.get(String(id))).filter(Boolean);
      const teamB = getTeamIds("teamBBox").map(id=>map.get(String(id))).filter(Boolean);

      previewEl.innerHTML = `
        <div><b>Data:</b> ${d} ${t}</div>
        <div><b>Campo:</b> ${v}</div>
        <div style="margin-top:8px"><b>Squadra A:</b> ${a}</div>
        <div><b>Squadra B:</b> ${b}</div>
        ${hasScore ? `<div style="margin-top:8px"><b>Risultato:</b> ${scoreA}-${scoreB}</div>` : `<div class="muted" style="margin-top:8px">Risultato: (non inserito)</div>`}
        <div style="margin-top:12px"><b>Convocati (${names.length}/12)</b></div>
        <div>${names.length ? names.map(n=>`<span class="pill">${n}</span>`).join("") : "<span class='muted'>Nessun convocato</span>"}</div>
        <div style="margin-top:12px"><b>Formazioni (facoltative)</b></div>
        <div class="muted">A: ${teamA.length ? teamA.join(", ") : "‚Äî"}</div>
        <div class="muted">B: ${teamB.length ? teamB.join(", ") : "‚Äî"}</div>
      `;
    }

    function renderBannerFromForm(){
      const d = $("matchDate").value || "-";
      const t = $("matchTime").value || "21:00";
      const a = $("keeperA").value.trim() || "-";
      const b = $("keeperB").value.trim() || "-";
      const n = getCalledUp().length;
      const sA = $("scoreA").value, sB = $("scoreB").value;
      const res = (sA!=="" && sB!=="") ? ` ‚Ä¢ risultato: ${sA}-${sB}` : "";
      setBanner(`${d} ore ${t} ‚Ä¢ ${a} vs ${b} ‚Ä¢ convocati: ${n}/12${res}`);
      setShareMsg(`Link: ${SITE_LINK}`);
    }

    async function copyText(text, okMsg){
      try{ await navigator.clipboard.writeText(text); setMsg(okMsg, "ok"); }
      catch(e){
        const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
        setMsg(okMsg, "ok");
      }
    }

    async function copyLink(){
      await copyText(SITE_LINK, "‚úÖ Link copiato negli appunti.");
      setShareMsg("‚úÖ Link copiato! Incollalo su WhatsApp.");
    }

    function getCalledUpNames(){
      const ids = getCalledUp();
      const map = new Map(PLAYERS.map(p=>[String(p.id), p.name]));
      return ids.map(id => map.get(String(id))).filter(Boolean);
    }

    async function copyCalled(){
      const names = getCalledUpNames();
      if(!names.length){ setMsg("‚ÑπÔ∏è Nessun convocato da copiare.","err"); return; }

      const d = $("matchDate").value || "";
      const t = $("matchTime").value || "21:00";
      const v = $("venue").value || "Campo a 6 - Aradeo";
      const a = $("keeperA").value.trim() || "-";
      const b = $("keeperB").value.trim() || "-";

      const text =
        `‚öΩ Quelli della pensione\n` +
        `üìÖ ${d} ore ${t}\n` +
        `üìç ${v}\n` +
        `ü•Ö ${a} vs ${b}\n\n` +
        `üë• Convocati (${names.length}/12):\n` +
        names.map((n,i)=>`${i+1}. ${n}`).join("\n") +
        `\n\nüîó ${SITE_LINK}`;

      await copyText(text, "‚úÖ Convocati copiati! Incollali su WhatsApp.");
      setShareMsg("‚úÖ Convocati copiati negli appunti.");
    }

    function openWhatsApp(){
      const d = $("matchDate").value || "";
      const t = $("matchTime").value || "21:00";
      const v = $("venue").value || "Campo a 6 - Aradeo";
      const a = $("keeperA").value.trim() || "-";
      const b = $("keeperB").value.trim() || "-";
      const names = getCalledUpNames();
      const sA = $("scoreA").value, sB = $("scoreB").value;
      const res = (sA!=="" && sB!=="") ? `üèÅ Risultato: ${sA}-${sB}\n` : "";

      const msg =
        `‚öΩ Quelli della pensione\n` +
        `üìÖ ${d} ore ${t}\n` +
        `üìç ${v}\n` +
        `ü•Ö ${a} vs ${b}\n` +
        res + `\n` +
        (names.length ? `üë• Convocati (${names.length}/12):\n${names.map((n,i)=>`${i+1}. ${n}`).join("\n")}\n\n` : "") +
        `üîó ${SITE_LINK}`;

      window.open("https://wa.me/?text=" + encodeURIComponent(msg), "_blank", "noopener");
    }

    async function save(){
      const match_date = $("matchDate").value;
      const match_time = ($("matchTime").value ? $("matchTime").value + ":00" : "21:00:00");
      const venue = $("venue").value || "Campo a 6 - Aradeo";
      const keeper_a = $("keeperA").value.trim();
      const keeper_b = $("keeperB").value.trim();
      const called_up = getCalledUp();

      if(!match_date) return setMsg("üìÖ Inserisci la data.","err");
      if(!keeper_a || !keeper_b) return setMsg("ü•Ö Inserisci i 2 portieri.","err");
      if(keeper_a.toLowerCase() === keeper_b.toLowerCase()) return setMsg("ü•Ö I portieri devono essere diversi.","err");
      if(called_up.length > 12) return setMsg("üë• Max 12 convocati.","err");

      const payload = { match_date, match_time, venue, called_up, keeper_a, keeper_b };

      try{
        if(CURRENT && CURRENT.id){
          setMsg("üíæ Salvataggio‚Ä¶");
          const { error } = await client.from("matches").update(payload).eq("id", CURRENT.id);
          if(error) throw error;
          setMsg("‚úÖ Partita aggiornata.","ok");
        }else{
          setMsg("üíæ Creazione‚Ä¶");
          const { data, error } = await client.from("matches").insert([payload]).select("*").single();
          if(error) throw error;
          CURRENT = data;
          $("matchSelect").value = data.id;
          setMsg("‚úÖ Partita creata.","ok");
        }
        await loadMatches();
        renderBannerFromForm();
        renderTeamBoxes(CURRENT?.team_a||[], CURRENT?.team_b||[]);
      }catch(e){
        console.error(e);
        setMsg("‚ùå Errore salvataggio: " + (e.message||e),"err");
      }
    }

    async function saveResultAndTeams(){
      if(!CURRENT) return setMsg("‚ÑπÔ∏è Seleziona una partita prima.","err");

      const scoreA = $("scoreA").value;
      const scoreB = $("scoreB").value;

      // risultato facoltativo: se uno dei due √® vuoto, li salviamo null
      const score_a = (scoreA === "" ? null : parseInt(scoreA,10));
      const score_b = (scoreB === "" ? null : parseInt(scoreB,10));
      if(score_a != null && Number.isNaN(score_a)) return setMsg("Gol A non valido.","err");
      if(score_b != null && Number.isNaN(score_b)) return setMsg("Gol B non valido.","err");

      const team_a = getTeamIds("teamABox");
      const team_b = getTeamIds("teamBBox");

      // non obbligatorio, ma evitiamo duplicati a/b
      const dup = team_a.filter(id => team_b.includes(id));
      if(dup.length) return setMsg("Un giocatore non pu√≤ stare in entrambe le formazioni.","err");

      const is_finished = (score_a != null && score_b != null);

      setMsg("üèÅ Salvataggio risultato‚Ä¶");
      const { error } = await client.from("matches")
        .update({ score_a, score_b, team_a, team_b, is_finished })
        .eq("id", CURRENT.id);

      if(error) return setMsg("‚ùå Errore: " + error.message, "err");

      setMsg(is_finished ? "‚úÖ Risultato salvato. Partita chiusa." : "‚úÖ Salvato (senza risultato).", "ok");

      // ricarica la partita aggiornata
      await loadMatches();
      const fresh = MATCHES.find(m => String(m.id)===String(CURRENT.id));
      if(fresh) fillForm(fresh);
    }

    async function del(){
      if(!CURRENT) return setMsg("‚ÑπÔ∏è Seleziona una partita.","err");
      if(!confirm("Sicuro di eliminare questa partita?")) return;
      setMsg("üóë Eliminazione‚Ä¶");
      const { error } = await client.from("matches").delete().eq("id", CURRENT.id);
      if(error) return setMsg("‚ùå Errore eliminazione: "+error.message,"err");
      setMsg("‚úÖ Partita eliminata.","ok");
      clearForm();
      await loadMatches();
    }

    async function addPlayer(){
      const name = prompt("Nome nuovo giocatore:");
      if(!name) return;
      const clean = name.trim();
      if(!clean) return;

      const { data: existing, error: e1 } = await client.from("players").select("id").ilike("name", clean).limit(1);
      if(e1) return setMsg("‚ùå Errore: "+e1.message,"err");
      if(existing && existing.length) return setMsg("‚ÑπÔ∏è Giocatore gi√† presente.","err");

      const { error } = await client.from("players").insert([{ name: clean }]);
      if(error) return setMsg("‚ùå Errore insert: "+error.message,"err");

      setMsg("‚úÖ Giocatore aggiunto.","ok");
      await loadPlayers();
      renderPreview();
      renderBannerFromForm();
    }

    async function logout(){
      setMsg("üö™ Logout‚Ä¶");
      const { error } = await client.auth.signOut();
      if(error) return setMsg("‚ùå Errore logout: "+error.message,"err");
      location.href="admin.html";
    }

    $("matchSelect").addEventListener("change", ()=>{
      const id = $("matchSelect").value;
      if(!id) return clearForm();
      const m = MATCHES.find(x=>String(x.id)===String(id));
      if(m) fillForm(m);
    });

    $("btnNew").addEventListener("click", ()=>{ clearForm(); setMsg("‚ûï Nuova partita: compila e salva.","ok"); renderBannerFromForm(); });
    $("btnRefresh").addEventListener("click", async ()=>{ setMsg("üîÑ Aggiorno‚Ä¶"); await loadMatches(); setMsg("‚úÖ Lista aggiornata.","ok"); });
    $("btnSave").addEventListener("click", save);
    $("btnDelete").addEventListener("click", del);
    $("btnAddPlayer").addEventListener("click", addPlayer);
    $("btnLogout").addEventListener("click", logout);

    $("btnCopyLink").addEventListener("click", copyLink);
    $("btnCopyCalled").addEventListener("click", copyCalled);
    $("btnWhatsApp").addEventListener("click", openWhatsApp);

    $("btnSaveResult").addEventListener("click", saveResultAndTeams);

    ["matchDate","matchTime","venue","keeperA","keeperB","scoreA","scoreB"].forEach(id=>{
      $(id).addEventListener("input", ()=>{ renderPreview(); renderBannerFromForm(); });
      $(id).addEventListener("change", ()=>{ renderPreview(); renderBannerFromForm(); });
    });

    (async function init(){
      const ok = await requireSession();
      if(!ok) return;
      try{
        setMsg("‚è≥ Caricamento‚Ä¶");
        await loadPlayers();
        await loadMatches();
        clearForm();
        setMsg("‚úÖ Pronto.","ok");
      }catch(e){
        console.error(e);
        setMsg("‚ùå Errore init: " + (e.message||e),"err");
      }
    })();
  </script>
</body>
</html>
