<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{font-family:Inter;background:#f4f6f8;margin:0;padding:20px}
    .box{max-width:700px;margin:auto;background:#fff;padding:20px;border-radius:12px}
    h1{margin-top:0}
    input,button{padding:10px;border-radius:8px;border:1px solid #ccc}
    button{cursor:pointer;font-weight:700}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;background:#eee;padding:6px 10px;border-radius:999px;margin:4px 6px 0 0}
    .muted{color:#666;font-size:13px}
    .danger{background:#c00;color:#fff;border:0}
  </style>
</head>

<body>
<div class="box">
  <h1>Admin ‚Äì Fine partita</h1>

  <div class="row">
    <input id="scoreA" type="number" min="0" placeholder="Gol Squadra A">
    <input id="scoreB" type="number" min="0" placeholder="Gol Squadra B">
  </div>

  <hr style="margin:20px 0">

  <h3>‚öΩ Marcatori (facoltativi)</h3>
  <div id="scorersBox" class="muted">Nessun marcatore</div>

  <div class="row" style="margin-top:10px">
    <input id="scorerName" placeholder="Nome">
    <input id="scorerGoals" type="number" min="1" placeholder="Gol">
    <button id="addScorer">‚ûï</button>
  </div>

  <hr style="margin:20px 0">

  <button id="save">üíæ Salva risultato</button>
  <div id="msg" class="muted" style="margin-top:10px"></div>
</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let SCORERS = [];
let CURRENT_MATCH_ID = null; // ultima partita

const msg = document.getElementById("msg");

function renderScorers(){
  const box = document.getElementById("scorersBox");
  if(!SCORERS.length){
    box.innerHTML = "<span class='muted'>Nessun marcatore</span>";
    return;
  }
  box.innerHTML = SCORERS.map((s,i)=>`
    <span class="pill">
      ${s.name} (${s.goals})
      <span style="cursor:pointer" onclick="removeScorer(${i})">‚ùå</span>
    </span>
  `).join("");
}

function removeScorer(i){
  SCORERS.splice(i,1);
  renderScorers();
}

document.getElementById("addScorer").onclick = ()=>{
  const name = document.getElementById("scorerName").value.trim();
  const goals = parseInt(document.getElementById("scorerGoals").value);
  if(!name || !goals) return;

  SCORERS.push({ name, goals });
  document.getElementById("scorerName").value="";
  document.getElementById("scorerGoals").value="";
  renderScorers();
};

async function loadLastMatch(){
  const { data } = await client
    .from("matches")
    .select("id,scorers")
    .order("match_date",{ascending:false})
    .limit(1)
    .single();

  if(data){
    CURRENT_MATCH_ID = data.id;
    SCORERS = data.scorers || [];
    renderScorers();
  }
}

document.getElementById("save").onclick = async ()=>{
  const scoreA = parseInt(document.getElementById("scoreA").value);
  const scoreB = parseInt(document.getElementById("scoreB").value);

  if(isNaN(scoreA) || isNaN(scoreB)){
    msg.textContent = "Inserisci il risultato";
    return;
  }

  const payload = {
    score_a: scoreA,
    score_b: scoreB,
    scorers: SCORERS.length ? SCORERS : null
  };

  const { error } = await client
    .from("matches")
    .update(payload)
    .eq("id", CURRENT_MATCH_ID);

  msg.textContent = error ? error.message : "‚úÖ Risultato salvato";
};

loadLastMatch();
</script>
</body>
</html>
