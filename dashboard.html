<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard â€¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08);
      --btn:#111; --btn2:#444; --danger:#b00020;
      --okBg:#dcfce7; --okText:#166534;
      --errBg:#ffe4e6; --errText:#9f1239;
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
      --border:#2a2f3a; --shadow:0 10px 28px rgba(0,0,0,.45);
      --btn:#0b0e14; --btn2:#2a3242; --danger:#ff4d4d;
      --okBg:rgba(34,197,94,.15); --okText:#86efac;
      --errBg:rgba(244,63,94,.16); --errText:#fda4af;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text)}
    .wrap{max-width:720px;margin:20px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    h1{margin:0;font-family:'Bebas Neue';letter-spacing:2px}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;margin-top:12px;font-size:12px;color:var(--muted)}
    input,select{
      width:100%;padding:12px;border-radius:12px;
      border:1px solid var(--border);background:transparent;color:var(--text)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      padding:12px 14px;border-radius:14px;border:0;
      background:var(--btn);color:#fff;font-weight:900;cursor:pointer
    }
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:var(--danger)}
    .btn.full{width:100%}
    .msg{
      margin-top:12px;padding:12px;border-radius:12px;
      font-size:13px;border:1px solid var(--border)
    }
    .msg.ok{background:var(--okBg);color:var(--okText)}
    .msg.err{background:var(--errBg);color:var(--errText);font-weight:800}
    .fab{
      position:fixed;right:16px;bottom:16px;
      width:54px;height:54px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);font-size:22px;cursor:pointer
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>Dashboard</h1>
    <div class="muted">Gestione partite</div>

    <div id="msg" class="msg">Caricamentoâ€¦</div>

    <label>Partita</label>
    <select id="matchSelect">
      <option value="">â€” Nuova partita â€”</option>
    </select>

    <div class="row">
      <button id="btnNew" class="btn secondary">âž• Nuova</button>
      <button id="btnRefresh" class="btn secondary">ðŸ”„ Aggiorna</button>
    </div>

    <label>Data</label>
    <input id="matchDate" type="date">

    <label>Ora</label>
    <input id="matchTime" type="time" value="21:00">

    <label>Campo</label>
    <input id="venue" type="text" value="Campo a 6 - Aradeo">

    <label>Portiere Squadra A</label>
    <input id="keeperA" type="text">

    <label>Portiere Squadra B</label>
    <input id="keeperB" type="text">

    <div class="row">
      <button id="btnSave" class="btn full">ðŸ’¾ Salva partita</button>
      <button id="btnDelete" class="btn danger full">ðŸ—‘ Elimina partita</button>
    </div>

    <div class="row">
      <button id="btnLogout" class="btn secondary full">ðŸšª Esci</button>
    </div>
  </div>

</div>

<button id="themeToggle" class="fab">ðŸŒ™</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* THEME */
function setTheme(m){
  document.body.classList.toggle("dark", m==="dark");
  document.getElementById("themeToggle").textContent = m==="dark"?"â˜€ï¸":"ðŸŒ™";
  localStorage.setItem("qdp_theme", m);
}
setTheme(localStorage.getItem("qdp_theme")==="dark"?"dark":"light");
document.getElementById("themeToggle").onclick=()=>{
  setTheme(document.body.classList.contains("dark")?"light":"dark");
};

/* SUPABASE */
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $ = id=>document.getElementById(id);
let MATCHES = [];
let CURRENT = null;

function setMsg(t,k=""){ $("msg").className="msg "+k; $("msg").textContent=t; }

async function requireSession(){
  const { data:{session} } = await client.auth.getSession();
  if(!session){ location.href="admin.html"; return false; }
  return true;
}

async function loadMatches(){
  const { data,error } = await client.from("matches")
    .select("id,match_date,match_time,venue,keeper_a,keeper_b")
    .order("match_date",{ascending:false})
    .order("match_time",{ascending:false});
  if(error) return setMsg(error.message,"err");
  MATCHES=data||[];
  const sel=$("matchSelect");
  sel.innerHTML=`<option value="">â€” Nuova partita â€”</option>`;
  MATCHES.forEach(m=>{
    const o=document.createElement("option");
    o.value=m.id;
    o.textContent=`${m.match_date} ${String(m.match_time||"").slice(0,5)} â€¢ ${m.venue}`;
    sel.appendChild(o);
  });
}

function clearForm(){
  CURRENT=null;
  $("matchSelect").value="";
  $("matchDate").value="";
  $("matchTime").value="21:00";
  $("venue").value="Campo a 6 - Aradeo";
  $("keeperA").value="";
  $("keeperB").value="";
}

async function save(){
  const payload={
    match_date:$("matchDate").value,
    match_time:$("matchTime").value+":00",
    venue:$("venue").value,
    keeper_a:$("keeperA").value.trim(),
    keeper_b:$("keeperB").value.trim()
  };
  if(!payload.match_date||!payload.keeper_a||!payload.keeper_b)
    return setMsg("Compila data e portieri","err");

  if(CURRENT){
    const { error } = await client.from("matches").update(payload).eq("id",CURRENT.id);
    if(error) return setMsg(error.message,"err");
    setMsg("Partita aggiornata","ok");
  }else{
    const { data,error } = await client.from("matches").insert([payload]).select().single();
    if(error) return setMsg(error.message,"err");
    CURRENT=data;
    setMsg("Partita creata","ok");
  }
  await loadMatches();
}

async function del(){
  if(!CURRENT) return setMsg("Seleziona una partita","err");
  if(!confirm("Eliminare la partita?")) return;
  const { error } = await client.from("matches").delete().eq("id",CURRENT.id);
  if(error) return setMsg(error.message,"err");
  clearForm();
  await loadMatches();
  setMsg("Partita eliminata","ok");
}

$("btnSave").onclick=save;
$("btnDelete").onclick=del;
$("btnNew").onclick=()=>{ clearForm(); setMsg("Nuova partita","ok"); };
$("btnRefresh").onclick=loadMatches;
$("btnLogout").onclick=async()=>{ await client.auth.signOut(); location.href="admin.html"; };

$("matchSelect").onchange=()=>{
  const id=$("matchSelect").value;
  if(!id){ clearForm(); return; }
  CURRENT=MATCHES.find(m=>String(m.id)===String(id));
  if(!CURRENT) return;
  $("matchDate").value=CURRENT.match_date||"";
  $("matchTime").value=String(CURRENT.match_time||"21:00").slice(0,5);
  $("venue").value=CURRENT.venue||"";
  $("keeperA").value=CURRENT.keeper_a||"";
  $("keeperB").value=CURRENT.keeper_b||"";
};

(async()=>{
  if(!await requireSession()) return;
  await loadMatches();
  clearForm();
  setMsg("Pronto","ok");
})();
</script>
</body>
</html>
