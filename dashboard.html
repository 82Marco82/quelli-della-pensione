<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --shadow:0 6px 20px rgba(0,0,0,.08);
      --btn:#111; --btn2:#444; --danger:#b00020;
      --okBg:#dcfce7; --okText:#166534;
      --errBg:#ffe4e6; --errText:#9f1239;
      --pill:#eeeeee;
    }
    body.dark{
      --bg:#0f1115; --card:#171a21; --text:#e5e7eb; --muted:#a1a1aa;
      --border:#2a2f3a; --shadow:0 10px 28px rgba(0,0,0,.45);
      --btn:#0b0e14; --btn2:#2a3242; --danger:#ff4d4d;
      --okBg:rgba(34,197,94,.15); --okText:#86efac;
      --errBg:rgba(244,63,94,.16); --errText:#fda4af;
      --pill:#222631;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:20px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    h1{margin:0;font-family:'Bebas Neue';letter-spacing:2px}
    h2{margin:14px 0 8px;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;margin-top:10px;font-size:12px;color:var(--muted)}
    input{
      width:100%;padding:12px;border-radius:12px;
      border:1px solid var(--border);background:transparent;color:var(--text)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      padding:12px 14px;border-radius:14px;border:0;
      background:var(--btn);color:#fff;font-weight:900;cursor:pointer
    }
    .btn.secondary{background:var(--btn2)}
    .btn.danger{background:var(--danger)}
    .btn.full{width:100%}
    .msg{
      margin-top:12px;padding:12px;border-radius:12px;
      font-size:13px;border:1px solid var(--border)
    }
    .msg.ok{background:var(--okBg);color:var(--okText)}
    .msg.err{background:var(--errBg);color:var(--errText);font-weight:800}
    .playersBox{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      max-height:260px;
      overflow:auto;
    }
    .pRow{display:flex;gap:10px;align-items:center;padding:6px}
    .pill{
      display:inline-block;background:var(--pill);
      border-radius:999px;padding:6px 10px;
      font-weight:900;margin:6px 6px 0 0;
    }
    .twoCols{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.twoCols{grid-template-columns:1fr 1fr}}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>Dashboard</h1>
    <div class="muted">Gestione partite</div>

    <div id="msg" class="msg">Caricamento‚Ä¶</div>

    <label>Partita</label>
    <select id="matchSelect"></select>

    <div class="row" style="margin-top:10px">
      <button id="btnNew" class="btn secondary">‚ûï Nuova</button>
      <button id="btnRefresh" class="btn secondary">üîÑ Aggiorna</button>
    </div>

    <label>Data</label>
    <input id="matchDate" type="date">

    <label>Ora</label>
    <input id="matchTime" type="time" value="21:00">

    <label>Campo</label>
    <input id="venue" value="Campo a 6 - Aradeo">

    <label>Portiere Squadra A</label>
    <input id="keeperA">

    <label>Portiere Squadra B</label>
    <input id="keeperB">

    <h2>Convocati (max 12)</h2>
    <div id="playersBox" class="playersBox"></div>

    <div class="row" style="margin-top:10px">
      <button id="btnSave" class="btn full">üíæ Salva partita</button>
      <button id="btnDelete" class="btn danger full">üóë Elimina partita</button>
    </div>

    <h2>Fine partita</h2>

    <div class="row">
      <input id="scoreA" type="number" placeholder="Gol Squadra A">
      <input id="scoreB" type="number" placeholder="Gol Squadra B">
    </div>

    <h2>Formazioni (facoltative)</h2>

    <div class="twoCols">
      <div>
        <label>Squadra A</label>
        <div id="teamABox" class="playersBox"></div>
      </div>
      <div>
        <label>Squadra B</label>
        <div id="teamBBox" class="playersBox"></div>
      </div>
    </div>

    <button id="btnSaveResult" class="btn full" style="margin-top:12px">
      üèÅ Salva risultato e formazioni
    </button>

    <button id="btnLogout" class="btn secondary full" style="margin-top:10px">
      üö™ Esci
    </button>
  </div>

</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
const $ = id => document.getElementById(id);
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let PLAYERS=[], MATCHES=[], CURRENT=null;

function msg(t,k=""){ $("msg").className="msg "+k; $("msg").textContent=t; }

async function init(){
  const { data:{session} } = await client.auth.getSession();
  if(!session) return location.href="admin.html";
  await loadPlayers();
  await loadMatches();
  clearForm();
  msg("Pronto","ok");
}

async function loadPlayers(){
  const { data } = await client.from("players").select("id,name").order("name");
  PLAYERS=data||[];
}

async function loadMatches(){
  const { data } = await client.from("matches")
    .select("*")
    .order("match_date",{ascending:false});
  MATCHES=data||[];
  const sel=$("matchSelect");
  sel.innerHTML=`<option value="">‚Äî Nuova partita ‚Äî</option>`;
  MATCHES.forEach(m=>{
    const o=document.createElement("option");
    o.value=m.id;
    o.textContent=`${m.match_date} ${String(m.match_time||"").slice(0,5)}`;
    sel.appendChild(o);
  });
}

function renderPlayersBox(){
  $("playersBox").innerHTML="";
  PLAYERS.forEach(p=>{
    const l=document.createElement("label");
    l.className="pRow";
    const c=document.createElement("input");
    c.type="checkbox"; c.value=p.id;
    c.checked=CURRENT?.called_up?.includes(p.id);
    l.append(c,document.createTextNode(p.name));
    $("playersBox").appendChild(l);
  });
}

function renderTeams(){
  const ids = getCalled();
  $("teamABox").innerHTML="";
  $("teamBBox").innerHTML="";
  PLAYERS.filter(p=>ids.includes(p.id)).forEach(p=>{
    ["A","B"].forEach(t=>{
      const box = t==="A"?$("teamABox"):$("teamBBox");
      const l=document.createElement("label");
      l.className="pRow";
      const c=document.createElement("input");
      c.type="checkbox"; c.value=p.id;
      c.checked = t==="A"
        ? CURRENT?.team_a?.includes(p.id)
        : CURRENT?.team_b?.includes(p.id);
      l.append(c,document.createTextNode(p.name));
      box.appendChild(l);
    });
  });
}

function getCalled(){
  return [...$("playersBox").querySelectorAll("input:checked")].map(x=>Number(x.value));
}
function getTeam(id){
  return [...$(id).querySelectorAll("input:checked")].map(x=>Number(x.value));
}

function clearForm(){
  CURRENT=null;
  $("matchSelect").value="";
  $("matchDate").value="";
  $("matchTime").value="21:00";
  $("venue").value="Campo a 6 - Aradeo";
  $("keeperA").value="";
  $("keeperB").value="";
  $("scoreA").value="";
  $("scoreB").value="";
  renderPlayersBox();
  renderTeams();
}

async function save(){
  const payload={
    match_date:$("matchDate").value,
    match_time:$("matchTime").value+":00",
    venue:$("venue").value,
    keeper_a:$("keeperA").value,
    keeper_b:$("keeperB").value,
    called_up:getCalled()
  };
  if(!payload.match_date||!payload.keeper_a||!payload.keeper_b)
    return msg("Compila data e portieri","err");

  if(CURRENT){
    await client.from("matches").update(payload).eq("id",CURRENT.id);
    msg("Partita aggiornata","ok");
  }else{
    const { data } = await client.from("matches").insert([payload]).select().single();
    CURRENT=data;
    msg("Partita creata","ok");
  }
  await loadMatches();
}

async function saveResult(){
  if(!CURRENT) return msg("Seleziona partita","err");
  await client.from("matches").update({
    score_a:$("scoreA").value||null,
    score_b:$("scoreB").value||null,
    team_a:getTeam("teamABox"),
    team_b:getTeam("teamBBox")
  }).eq("id",CURRENT.id);
  msg("Risultato salvato","ok");
}

async function del(){
  if(!CURRENT) return;
  await client.from("matches").delete().eq("id",CURRENT.id);
  clearForm();
  await loadMatches();
  msg("Partita eliminata","ok");
}

$("matchSelect").onchange=()=>{
  const m=MATCHES.find(x=>x.id===$("matchSelect").value);
  if(!m) return clearForm();
  CURRENT=m;
  $("matchDate").value=m.match_date;
  $("matchTime").value=String(m.match_time||"").slice(0,5);
  $("venue").value=m.venue;
  $("keeperA").value=m.keeper_a;
  $("keeperB").value=m.keeper_b;
  $("scoreA").value=m.score_a??"";
  $("scoreB").value=m.score_b??"";
  renderPlayersBox();
  renderTeams();
};

$("btnSave").onclick=save;
$("btnSaveResult").onclick=saveResult;
$("btnDelete").onclick=del;
$("btnNew").onclick=clearForm;
$("btnRefresh").onclick=loadMatches;
$("btnLogout").onclick=async()=>{ await client.auth.signOut(); location.href="admin.html"; };

init();
</script>
</body>
</html>
