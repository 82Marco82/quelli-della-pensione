<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partecipanti ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --logo1:#111;
      --logo2:#333;
      --chipBg:rgba(0,0,0,.04);
      --btnBg:#111;
      --btnText:#fff;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --logo1:#0b0e14;
      --logo2:#2a3242;
      --chipBg:rgba(255,255,255,.04);
      --btnBg:#0b0e14;
      --btnText:#fff;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:.2s}
    .wrap{max-width:860px;margin:auto;padding:16px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
      overflow:hidden;
    }

    .header{text-align:center}
    .logo{
      width:74px;height:74px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      margin:auto;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:30px;
      letter-spacing:2px;
    }
    h1{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:10px 0 0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px}

    .muted{color:var(--muted)}
    .space{height:8px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background:var(--btnBg);
      color:var(--btnText);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{background:transparent;color:var(--text)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--pill);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-weight:900;
      white-space:nowrap;
    }

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      font-weight:900;font-size:12px;
      color:var(--text);
      white-space:nowrap;
    }

    input, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      outline:none;
      font-family:Inter;
    }

    .controls{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(min-width:720px){
      .controls{grid-template-columns:1.4fr .6fr auto}
      .controls .btn{height:46px}
    }

    .list{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }

    .pCard{
      border:1px solid var(--border);
      background:var(--chipBg);
      border-radius:16px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .pLeft{min-width:0}
    .pName{
      font-weight:900;
      font-size:16px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:52vw;
    }
    @media(min-width:720px){ .pName{max-width:520px} }

    .pMeta{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .nav{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:14px;
    }
    .nav a{color:var(--text);text-decoration:none;font-weight:800}
    .nav a:hover{text-decoration:underline}

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div class="logo">QDP</div>
    <h1>Partecipanti</h1>
    <div class="subtitle">Quelli della pensione</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div id="status" class="muted">Caricamento‚Ä¶</div>
      <div class="row">
        <button id="btnReload" class="btn ghost">üîÑ Aggiorna</button>
      </div>
    </div>

    <div class="controls">
      <input id="q" type="text" placeholder="Cerca giocatore‚Ä¶" />
      <select id="sort">
        <option value="name">Ordina: Nome</option>
        <option value="apps">Ordina: Presenze</option>
        <option value="goals">Ordina: Gol</option>
      </select>
      <button id="btnClear" class="btn ghost">‚úñ Pulisci</button>
    </div>

    <div class="space"></div>

    <div class="row">
      <span class="chip" id="chipCount">üë• 0 giocatori</span>
      <span class="chip" id="chipApps">üìå Presenze totali: ‚Äî</span>
      <span class="chip" id="chipGoals">‚öΩ Gol totali: ‚Äî</span>
    </div>
  </div>

  <div id="list" class="list"></div>

  <div class="card nav muted">
    <a href="index.html">üè† Home</a>
    <a href="storico.html">üìö Storico</a>
    <a href="marcatori.html">‚öΩ Marcatori</a>
    <a href="mvp.html">üèÜ MVP</a>
    <a href="admin.html">üîê Admin</a>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* THEME */
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  document.getElementById("themeToggle").textContent = mode === "dark" ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
document.getElementById("themeToggle").onclick = () => {
  setTheme(document.body.classList.contains("dark") ? "light" : "dark");
};

/* HELPERS */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
const $ = (id)=>document.getElementById(id);

/* SUPABASE */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  $("status").textContent = "Errore: config.js non caricato";
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* STATE */
let PLAYERS = []; // [{id,name}]
let STATS = new Map(); // id -> {apps,goals}
let VIEW = []; // merged rows

function mergeView(){
  VIEW = PLAYERS.map(p=>{
    const s = STATS.get(String(p.id)) || { apps:0, goals:0 };
    return { id:String(p.id), name:p.name, apps:s.apps, goals:s.goals };
  });
}

function applyFilters(){
  const q = ($("q").value || "").trim().toLowerCase();
  const sort = $("sort").value;

  let rows = VIEW.slice();

  if(q){
    rows = rows.filter(r => String(r.name||"").toLowerCase().includes(q));
  }

  if(sort === "apps"){
    rows.sort((a,b)=> (b.apps-a.apps) || (b.goals-a.goals) || String(a.name).localeCompare(String(b.name),"it"));
  }else if(sort === "goals"){
    rows.sort((a,b)=> (b.goals-a.goals) || (b.apps-a.apps) || String(a.name).localeCompare(String(b.name),"it"));
  }else{
    rows.sort((a,b)=> String(a.name).localeCompare(String(b.name),"it"));
  }

  render(rows);
}

function render(rows){
  $("chipCount").textContent = `üë• ${rows.length} giocatori`;

  const totalApps = VIEW.reduce((s,r)=>s+(r.apps||0),0);
  const totalGoals = VIEW.reduce((s,r)=>s+(r.goals||0),0);
  $("chipApps").textContent = `üìå Presenze totali: ${totalApps}`;
  $("chipGoals").textContent = `‚öΩ Gol totali: ${totalGoals}`;

  if(!rows.length){
    $("list").innerHTML = `<div class="card"><div class="muted">Nessun risultato.</div></div>`;
    return;
  }

  $("list").innerHTML = rows.map(r=>`
    <div class="pCard">
      <div class="pLeft">
        <div class="pName">${escapeHtml(r.name)}</div>
        <div class="muted" style="margin-top:6px;font-size:12px">ID: ${escapeHtml(String(r.id).slice(0,8))}‚Ä¶</div>
      </div>
      <div class="pMeta">
        <span class="pill">üìå ${r.apps} pres.</span>
        <span class="pill">‚öΩ ${r.goals} gol</span>
      </div>
    </div>
  `).join("");
}

/* LOAD */
async function loadAll(){
  $("status").textContent = "Caricamento‚Ä¶";
  $("btnReload").disabled = true;

  try{
    // players
    const { data: players, error: eP } = await client
      .from("players")
      .select("id,name")
      .order("name",{ascending:true});

    if(eP) throw eP;
    PLAYERS = players || [];

    // matches: solo campi necessari
    const { data: matches, error: eM } = await client
      .from("matches")
      .select("id,called_up,scorers")
      .order("match_date",{ascending:false})
      .limit(500);

    if(eM) throw eM;

    // stats init
    STATS = new Map();
    for(const p of PLAYERS){
      STATS.set(String(p.id), { apps:0, goals:0 });
    }

    // presenze
    (matches || []).forEach(m=>{
      const called = Array.isArray(m.called_up) ? m.called_up : [];
      called.forEach(pid=>{
        const k = String(pid);
        if(!STATS.has(k)) STATS.set(k,{apps:0,goals:0}); // nel dubbio
        STATS.get(k).apps += 1;
      });

      // gol
      const sc = m.scorers || {};
      const ta = Array.isArray(sc.team_a) ? sc.team_a : [];
      const tb = Array.isArray(sc.team_b) ? sc.team_b : [];
      [...ta, ...tb].forEach(x=>{
        const pid = String(x?.player_id || "");
        const g = Number(x?.goals || 0);
        if(!pid || !Number.isFinite(g) || g<=0) return;
        if(!STATS.has(pid)) STATS.set(pid,{apps:0,goals:0});
        STATS.get(pid).goals += g;
      });
    });

    mergeView();
    $("status").textContent = `‚úÖ Caricati: ${PLAYERS.length} giocatori`;
    applyFilters();

  }catch(err){
    console.error(err);
    $("status").textContent = "‚ùå Errore caricamento";
    $("list").innerHTML = `<div class="card"><div class="muted">${escapeHtml(err.message || String(err))}</div></div>`;
  }finally{
    $("btnReload").disabled = false;
  }
}

/* EVENTS */
$("btnReload").onclick = loadAll;
$("btnClear").onclick = ()=>{
  $("q").value = "";
  $("sort").value = "name";
  applyFilters();
};
$("q").addEventListener("input", applyFilters);
$("sort").addEventListener("change", applyFilters);

/* INIT */
loadAll();
</script>
</body>
</html>
