<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QDP ‚Ä¢ Foto</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --logo1:#111;
      --logo2:#333;
      --btn:#111;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --logo1:#0b0e14;
      --logo2:#2a3242;
      --btn:#0b0e14;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui;
      background:var(--bg);
      color:var(--text);
      transition:.2s;
    }
    .wrap{max-width:980px;margin:auto;padding:16px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:56px;height:56px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:26px;
      letter-spacing:2px;
      box-shadow:var(--shadow);
    }
    .titleWrap{line-height:1.1}
    .title{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px;margin-top:2px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--pill);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      border:1px solid var(--border);
      white-space:nowrap;
      max-width:100%;
    }

    /* ‚úÖ FIX: questa pill deve andare a capo e restare dentro il box */
    .adminHint{
      width:100%;
      white-space:normal !important;
      display:flex !important;
      line-height:1.25;
    }

    .btn{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn.small{padding:10px 12px; border-radius:12px; font-size:14px}
    .btn.danger{background:var(--bad)}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn); color:#111}

    .input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-family:inherit;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}

    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:repeat(2, 1fr)} }
    @media(max-width:620px){ .grid{grid-template-columns:1fr} }

    .photoCard{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
    }
    .imgWrap{
      position:relative;
      background:#000;
      aspect-ratio: 4/5;
      overflow:hidden;
    }
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .imgTopActions{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; justify-content:space-between; gap:10px;
      pointer-events:none;
    }
    .chip{
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(0,0,0,.55);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }
    .chipBtn{pointer-events:auto; border:0; cursor:pointer;}

    .pcBody{padding:12px}
    .pcMeta{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .cap{
      margin-top:8px;
      font-weight:800;
      line-height:1.25;
      word-break:break-word;
    }
    .cap.muted{font-weight:700}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .divider{height:1px;background:var(--border); margin:12px 0}

    .commentsTitle{
      font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .comment{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      margin-top:8px;
    }
    .commentHead{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:900;
      align-items:center;
    }
    .commentBody{margin-top:6px; color:var(--text); word-break:break-word}
    .mini{font-size:12px; color:var(--muted)}

    .toast{
      display:none;
      margin-top:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(22,163,74,.10);
      color:var(--text);
      font-weight:800;
    }
    .toast.show{display:block}
    .toast.bad{background:rgba(239,68,68,.10)}
    .toast.warn{background:rgba(245,158,11,.12)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo">QDP</div>
      <div class="titleWrap">
        <h1 class="title">FOTO</h1>
        <div class="subtitle">Carica una foto ‚Ä¢ aggiorna per vedere le nuove</div>
      </div>
    </div>

    <div class="row">
      <a class="btn ghost" href="index.html">‚¨ÖÔ∏è Home</a>
      <button id="adminBtn" class="btn small warn" type="button">üîê Admin: OFF</button>
      <button id="themeToggle" class="btn small ghost" type="button">üåô</button>
    </div>
  </div>

  <div class="card">
    <div class="muted" style="font-weight:800">Scegli una foto e premi ‚ÄúCarica‚Äù.</div>
    <div class="muted" style="margin-top:6px;font-weight:900">‚ö†Ô∏è Foto o commenti volgari o ingiuriosi verranno eliminati!!!</div>

    <div class="row" style="margin-top:10px">
      <input id="fileInput" class="input" type="file" accept="image/*">
    </div>

    <div class="row" style="margin-top:10px">
      <input id="captionInput" class="input" type="text" maxlength="90" placeholder="Didascalia (facoltativa, max 90 caratteri)">
    </div>

    <div class="row" style="margin-top:10px">
      <button id="uploadBtn" class="btn ok" type="button">‚¨ÜÔ∏è Carica</button>
      <button id="refreshBtn" class="btn ghost" type="button">üîÑ Aggiorna</button>
      <div class="spacer"></div>

      <label class="pill" style="gap:10px">
        üîΩ Ordina:
        <select id="sortSelect" style="width:auto; padding:8px 10px; border-radius:12px">
          <option value="new">Pi√π nuove</option>
          <option value="likes">Pi√π like</option>
        </select>
      </label>

      <div id="countPill" class="pill">üì∏ 0 foto totali</div>
    </div>

    <div id="adminHint" class="pill adminHint" style="display:none; margin-top:10px">
      ‚úÖ Admin attivo (puoi eliminare e modificare didascalie + commenti)
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <div class="card" id="topBox" style="display:none">
    <div class="row">
      <div style="font-weight:900">üèÜ Top foto pi√π piaciute (ultimi 30 giorni)</div>
      <div class="spacer"></div>
      <div class="mini" id="topMini"></div>
    </div>
    <div class="grid" id="topGrid" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:900">üñº Galleria</div>
      <div class="spacer"></div>
      <div class="mini">Suggerimento: fai ‚ÄúAggiorna‚Äù se qualcuno ha caricato ora.</div>
    </div>
    <div class="grid" id="grid" style="margin-top:12px"></div>
  </div>

</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* THEME */
const themeBtn = document.getElementById("themeToggle");
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

/* SUPABASE */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* DOM */
const adminBtn = document.getElementById("adminBtn");
const adminHint = document.getElementById("adminHint");
const toast = document.getElementById("toast");

const fileInput = document.getElementById("fileInput");
const captionInput = document.getElementById("captionInput");
const uploadBtn = document.getElementById("uploadBtn");
const refreshBtn = document.getElementById("refreshBtn");
const sortSelect = document.getElementById("sortSelect");
const grid = document.getElementById("grid");
const countPill = document.getElementById("countPill");

const topBox = document.getElementById("topBox");
const topGrid = document.getElementById("topGrid");
const topMini = document.getElementById("topMini");

/* HELPERS */
function showToast(msg, type="ok"){
  toast.classList.remove("show","bad","warn");
  if(type==="bad") toast.classList.add("bad");
  if(type==="warn") toast.classList.add("warn");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 2200);
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDate(iso){
  try{
    return new Date(iso).toLocaleString("it-IT", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
  }catch(e){ return String(iso||""); }
}

async function getSession(){
  const { data } = await client.auth.getSession();
  return data?.session || null;
}
function isAdminSession(session){ return !!(session && session.user); }

/* ADMIN UI */
let adminOn = false;
async function refreshAdminUI(){
  const session = await getSession();
  adminOn = isAdminSession(session);
  adminBtn.textContent = adminOn ? "üîê Admin: ON" : "üîê Admin: OFF";
  adminBtn.classList.toggle("warn", !adminOn);
  adminBtn.classList.toggle("ok", adminOn);
  adminHint.style.display = adminOn ? "inline-flex" : "none";
  return adminOn;
}

adminBtn.onclick = async () => {
  const session = await getSession();
  if(isAdminSession(session)){
    await client.auth.signOut();
    showToast("Admin disattivato.", "warn");
    await refreshAdminUI();
    await loadAll();
    return;
  }
  const email = prompt("Email admin:");
  if(!email) return;
  const password = prompt("Password admin:");
  if(!password) return;

  const { error } = await client.auth.signInWithPassword({ email, password });
  if(error){
    console.error(error);
    showToast("Login fallito.", "bad");
    return;
  }
  showToast("Admin attivo ‚úÖ");
  await refreshAdminUI();
  await loadAll();
};

/* CONFIG */
const BUCKET = "photos";
const TABLE_PHOTOS = "photos";
const TABLE_COMMENTS = "photo_comments";

function getLikedKey(photoId){ return `qdp_liked_${photoId}`; }
function hasLiked(photoId){ return localStorage.getItem(getLikedKey(photoId)) === "1"; }
function markLiked(photoId){ localStorage.setItem(getLikedKey(photoId), "1"); }

function antiSpamOk(){
  const key = "qdp_last_comment_at";
  const last = Number(localStorage.getItem(key) || "0");
  const now = Date.now();
  const waitMs = 20000;
  if(now - last < waitMs) return { ok:false, ms: waitMs - (now-last) };
  localStorage.setItem(key, String(now));
  return { ok:true, ms:0 };
}

/* ‚úÖ Anti doppio tap upload */
let uploading = false;

/* ‚úÖ Top IDs per non duplicare in galleria */
let topIds = new Set();

/* ‚úÖ CONTATORI (FIX) */
let cachedPhotos = [];
let totalPhotosCount = 0;
let topPhotosCount = 0;

/* ‚úÖ aggiorna pill contatore (1 sola funzione) */
function updateCountPill(){
  const galleryCount = cachedPhotos.length;
  const total = totalPhotosCount;
  const top = topPhotosCount;

  if(total === 0){
    countPill.textContent = `üì∏ 0 foto totali`;
    return;
  }
  countPill.textContent = `üì∏ ${total} foto totali (${galleryCount} in galleria, ${top} in top)`;
}

/* UPLOAD */
uploadBtn.onclick = async () => {
  if(uploading) return;

  try{
    const file = fileInput.files?.[0];
    if(!file){
      showToast("Scegli un file.", "warn");
      return;
    }

    uploading = true;
    uploadBtn.disabled = true;
    uploadBtn.textContent = "‚è≥ Caricamento‚Ä¶";

    const caption = (captionInput.value || "").trim().slice(0,90);

    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const safeExt = ext.replace(/[^a-z0-9]/g,"") || "jpg";
    const filePath = `uploads/${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;

    const { error: upErr } = await client
      .storage
      .from(BUCKET)
      .upload(filePath, file, { cacheControl:"3600", upsert:false, contentType:file.type || "image/jpeg" });
    if(upErr) throw upErr;

    const { data: pub } = client.storage.from(BUCKET).getPublicUrl(filePath);
    const publicUrl = pub?.publicUrl || "";

    const { error: insErr } = await client
      .from(TABLE_PHOTOS)
      .insert([{ file_path: filePath, path: publicUrl, caption, likes: 0 }]);
    if(insErr) throw insErr;

    fileInput.value = "";
    captionInput.value = "";
    showToast("Foto caricata ‚úÖ");
    await loadAll();

  }catch(e){
    console.error(e);
    showToast("Errore upload.", "bad");
  }finally{
    uploading = false;
    uploadBtn.disabled = false;
    uploadBtn.textContent = "‚¨ÜÔ∏è Carica";
  }
};

refreshBtn.onclick = async () => {
  showToast("Aggiorno‚Ä¶");
  await loadAll();
};
sortSelect.onchange = () => loadGallery();

/* LIKE */
async function likePhoto(photo){
  try{
    if(hasLiked(photo.id)){
      showToast("Like gi√† dato ‚úÖ", "warn");
      return;
    }
    const next = Number(photo.likes || 0) + 1;

    const { error } = await client
      .from(TABLE_PHOTOS)
      .update({ likes: next })
      .eq("id", photo.id);

    if(error) throw error;

    markLiked(photo.id);
    showToast("Like üëç");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore like.", "bad");
  }
}

/* DELETE PHOTO (ADMIN) */
async function deletePhoto(photo){
  try{
    const ok = confirm("Vuoi eliminare questa foto?");
    if(!ok) return;

    const { error: delErr } = await client
      .from(TABLE_PHOTOS)
      .delete()
      .eq("id", photo.id);
    if(delErr) throw delErr;

    if(photo.file_path){
      const { error: stErr } = await client.storage.from(BUCKET).remove([photo.file_path]);
      if(stErr) console.warn("Storage remove error:", stErr);
    }

    showToast("Foto eliminata üóëÔ∏è");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore eliminazione.", "bad");
  }
}

/* EDIT CAPTION (ADMIN) */
async function editCaption(photo){
  try{
    const next = prompt("Modifica didascalia (vuota = nessuna):", photo.caption || "");
    if(next === null) return;

    const clean = String(next || "").trim().slice(0,90);
    const { error } = await client
      .from(TABLE_PHOTOS)
      .update({ caption: clean })
      .eq("id", photo.id);
    if(error) throw error;

    showToast("Didascalia aggiornata ‚úÖ");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore didascalia.", "bad");
  }
}

/* SHARE */
async function sharePhoto(photo){
  try{
    const url = photo.path || "";
    if(!url) return showToast("Link non disponibile.", "bad");
    const text = "Guarda questa foto QDP üì∏";

    if(navigator.share){
      await navigator.share({ title:"QDP Foto", text, url });
      return;
    }
    window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, "_blank", "noopener");
  }catch(e){
    console.warn(e);
  }
}
async function copyLink(photo){
  try{
    const url = photo.path || "";
    if(!url) return showToast("Link non disponibile.", "bad");
    await navigator.clipboard.writeText(url);
    showToast("Link copiato ‚úÖ");
  }catch(e){
    console.warn(e);
    showToast("Non riesco a copiare.", "bad");
  }
}

/* COMMENTS */
async function loadComments(photoId){
  const { data, error } = await client
    .from(TABLE_COMMENTS)
    .select("id,photo_id,author,body,created_at")
    .eq("photo_id", photoId)
    .order("created_at", { ascending:true });

  if(error){
    console.warn("comments error", error);
    return [];
  }
  return data || [];
}

async function addComment(photoId, author, body){
  try{
    const a = (author || "").trim().slice(0,24) || "Anonimo";
    const b = (body || "").trim().slice(0,220);
    if(!b) return showToast("Scrivi un commento.", "warn");

    const spam = antiSpamOk();
    if(!spam.ok) return showToast(`Aspetta ${Math.ceil(spam.ms/1000)}s prima di commentare.`, "warn");

    const { error } = await client
      .from(TABLE_COMMENTS)
      .insert([{ photo_id: photoId, author: a, body: b }]);
    if(error) throw error;

    showToast("Commento inviato ‚úÖ");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore commento.", "bad");
  }
}

async function deleteComment(commentId){
  try{
    const ok = confirm("Vuoi eliminare questo commento?");
    if(!ok) return;

    const { error } = await client
      .from(TABLE_COMMENTS)
      .delete()
      .eq("id", commentId);
    if(error) throw error;

    showToast("Commento eliminato üóëÔ∏è");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore eliminazione commento.", "bad");
  }
}

/* LOAD PHOTOS */
async function loadTop30(){
  try{
    topIds = new Set();
    topPhotosCount = 0;

    const since = new Date(Date.now() - 30*24*3600*1000).toISOString();

    const { data, error } = await client
      .from(TABLE_PHOTOS)
      .select("id,created_at,path,file_path,caption,likes")
      .gte("created_at", since)
      .order("likes", { ascending:false })
      .order("created_at", { ascending:false })
      .limit(6);

    if(error) throw error;

    const rows = data || [];
    topPhotosCount = rows.length;
    rows.forEach(p => topIds.add(String(p.id)));

    if(rows.length === 0){
      topBox.style.display = "none";
      topMini.textContent = "";
      return;
    }
    topBox.style.display = "block";
    topMini.textContent = `Mostro ${rows.length} foto`;

    topGrid.innerHTML = rows.map(p => renderPhotoCard(p, true)).join("");
    await wireCardEvents(topGrid, rows);

  }catch(e){
    console.warn("top30 error", e);
    topIds = new Set();
    topPhotosCount = 0;
    topBox.style.display = "none";
    topMini.textContent = "";
  }
}

async function loadGallery(){
  const sort = sortSelect.value;
  const orderByLikes = (sort === "likes");

  const { data, error } = await client
    .from(TABLE_PHOTOS)
    .select("id,created_at,path,file_path,caption,likes")
    .order(orderByLikes ? "likes" : "created_at", { ascending:false })
    .order("created_at", { ascending:false })
    .limit(60);

  if(error){
    console.error(error);
    grid.innerHTML = `<div class="muted">Errore caricamento foto.</div>`;
    totalPhotosCount = 0;
    cachedPhotos = [];
    updateCountPill();
    return;
  }

  const all = data || [];
  totalPhotosCount = all.length;

  /* ‚úÖ non mostrare in Galleria quelle gi√† presenti nel Top */
  cachedPhotos = all.filter(p => !topIds.has(String(p.id)));

  updateCountPill();

  grid.innerHTML = cachedPhotos.map(p => renderPhotoCard(p, false)).join("");
  await wireCardEvents(grid, cachedPhotos);
}

function renderPhotoCard(photo, isTop){
  const id = escapeHtml(photo.id);
  const likes = Number(photo.likes || 0);
  const liked = hasLiked(photo.id);
  const cap = (photo.caption || "").trim();
  const url = photo.path || "";

  const capHtml = cap
    ? `<div class="cap">${escapeHtml(cap)}</div>`
    : `<div class="cap muted">Nessuna didascalia</div>`;

  const badge = isTop ? `üèÜ TOP` : `‚ù§Ô∏è ${likes}`;
  const likeLabel = liked ? "‚úÖ Like" : "üëç Like";
  const likeDisabled = liked ? "disabled" : "";

  return `
    <div class="photoCard" data-id="${id}">
      <div class="imgWrap">
        <img src="${escapeHtml(url)}" alt="foto">
        <div class="imgTopActions">
          <div class="chip">${badge}</div>
          ${adminOn ? `<button class="chip chipBtn js-del" type="button">üóëÔ∏è Elimina</button>` : ``}
        </div>
      </div>

      <div class="pcBody">
        <div class="pcMeta">
          <div class="mini">üïí ${escapeHtml(fmtDate(photo.created_at))}</div>
          <div class="mini">ID: ${id.slice(0,8)}‚Ä¶</div>
        </div>

        ${capHtml}

        <div class="actions">
          <button class="btn small ${liked ? "ghost" : "ok"} js-like" type="button" ${likeDisabled}>${likeLabel} ‚Ä¢ ${likes}</button>
          <button class="btn small ghost js-share" type="button">üì§ Condividi</button>
          <button class="btn small ghost js-copy" type="button">üîó Copia link</button>
          ${adminOn ? `<button class="btn small warn js-editcap" type="button">‚úèÔ∏è Modifica didascalia</button>` : ``}
        </div>

        <div class="divider"></div>

        <div class="commentsTitle">
          <div>üí¨ Commenti</div>
          <div class="mini">max 220 caratteri ‚Ä¢ anti-spam 20s</div>
        </div>

        <div class="row" style="margin-top:10px">
          <input class="input js-author" type="text" maxlength="24" placeholder="Nome (facoltativo)">
        </div>
        <div class="row" style="margin-top:10px">
          <textarea class="input js-body" maxlength="220" placeholder="Scrivi un commento..."></textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn small ghost js-send" type="button">üì® Invia</button>
        </div>

        <div class="js-comments"></div>
      </div>
    </div>
  `;
}

async function wireCardEvents(containerEl, photos){
  const cards = [...containerEl.querySelectorAll(".photoCard")];

  for(const card of cards){
    const id = card.getAttribute("data-id");
    const photo = photos.find(p => String(p.id) === String(id));
    if(!photo) continue;

    const likeBtn = card.querySelector(".js-like");
    if(likeBtn) likeBtn.onclick = () => likePhoto(photo);

    const shareBtn = card.querySelector(".js-share");
    if(shareBtn) shareBtn.onclick = () => sharePhoto(photo);

    const copyBtn = card.querySelector(".js-copy");
    if(copyBtn) copyBtn.onclick = () => copyLink(photo);

    const delBtn = card.querySelector(".js-del");
    if(delBtn) delBtn.onclick = () => deletePhoto(photo);

    const editCapBtn = card.querySelector(".js-editcap");
    if(editCapBtn) editCapBtn.onclick = () => editCaption(photo);

    const commentsBox = card.querySelector(".js-comments");
    if(commentsBox){
      commentsBox.innerHTML = `<div class="mini muted" style="margin-top:10px">Carico commenti‚Ä¶</div>`;
      const comments = await loadComments(photo.id);

      commentsBox.innerHTML = (comments.length === 0)
        ? `<div class="mini muted" style="margin-top:10px">Nessun commento.</div>`
        : comments.map(c => `
            <div class="comment">
              <div class="commentHead">
                <div>üë§ ${escapeHtml(c.author || "Anonimo")}</div>
                <div class="row" style="gap:8px">
                  <div class="mini">üïí ${escapeHtml(fmtDate(c.created_at))}</div>
                  ${adminOn ? `<button class="btn small danger js-delc" type="button" data-cid="${escapeHtml(c.id)}">üóë</button>` : ``}
                </div>
              </div>
              <div class="commentBody">${escapeHtml(c.body || "")}</div>
            </div>
          `).join("");

      if(adminOn){
        const delCs = [...commentsBox.querySelectorAll(".js-delc")];
        delCs.forEach(btn=>{
          btn.onclick = () => deleteComment(btn.getAttribute("data-cid"));
        });
      }
    }

    const sendBtn = card.querySelector(".js-send");
    const authorEl = card.querySelector(".js-author");
    const bodyEl = card.querySelector(".js-body");
    if(sendBtn && bodyEl){
      sendBtn.onclick = async () => {
        await addComment(photo.id, authorEl?.value || "", bodyEl.value || "");
      };
    }
  }
}

/* LOAD ALL */
async function loadAll(){
  await refreshAdminUI();

  // ordine importante:
  // 1) carico TOP -> set topIds + topPhotosCount
  // 2) carico galleria -> calcolo totalPhotosCount + cachedPhotos
  await loadTop30();
  await loadGallery();

  // sicurezza: se per qualche motivo top non carica, la pill si aggiorna comunque
  updateCountPill();
}

loadAll();
</script>
</body>
</html>
