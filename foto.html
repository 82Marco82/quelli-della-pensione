<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QDP ‚Ä¢ Foto</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --logo1:#111;
      --logo2:#333;
      --btn:#111;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --logo1:#0b0e14;
      --logo2:#2a3242;
      --btn:#0b0e14;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui;
      background:var(--bg);
      color:var(--text);
      transition:.2s;
    }
    .wrap{max-width:980px;margin:auto;padding:16px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:56px;height:56px;border-radius:999px;
      background:linear-gradient(135deg,var(--logo1),var(--logo2));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:26px;
      letter-spacing:2px;
      box-shadow:var(--shadow);
    }
    .titleWrap{line-height:1.1}
    .title{
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      margin:0;
      text-transform:uppercase;
    }
    .subtitle{color:var(--muted);font-size:14px;margin-top:2px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--pill);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      border:1px solid var(--border);
      white-space:nowrap;
      max-width:100%;
    }

    /* ‚úÖ FIX: niente display:flex !important (cos√¨ JS pu√≤ fare display:none) */
    .adminHint{
      width:100%;
      white-space:normal;
      line-height:1.25;
    }

    .btn{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn.small{padding:10px 12px; border-radius:12px; font-size:14px}
    .btn.danger{background:var(--bad)}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn); color:#111}

    .input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-family:inherit;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}

    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:repeat(2, 1fr)} }
    @media(max-width:620px){ .grid{grid-template-columns:1fr} }

    .photoCard{
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
    }
    .imgWrap{
      position:relative;
      background:#000;
      aspect-ratio: 4/5;
      overflow:hidden;
    }
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .imgTopActions{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; justify-content:space-between; gap:10px;
      pointer-events:none;
    }
    .chip{
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:8px;
      background:rgba(0,0,0,.55);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }
    .chipBtn{pointer-events:auto; border:0; cursor:pointer;}

    .pcBody{padding:12px}
    .pcMeta{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .cap{
      margin-top:8px;
      font-weight:800;
      line-height:1.25;
      word-break:break-word;
    }
    .cap.muted{font-weight:700}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .divider{height:1px;background:var(--border); margin:12px 0}

    .commentsTitle{
      font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .comment{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      margin-top:8px;
    }
    .commentHead{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:900;
      align-items:center;
    }
    .commentBody{margin-top:6px; color:var(--text); word-break:break-word}
    .mini{font-size:12px; color:var(--muted)}

    .toast{
      display:none;
      margin-top:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(22,163,74,.10);
      color:var(--text);
      font-weight:800;
    }
    .toast.show{display:block}
    .toast.bad{background:rgba(239,68,68,.10)}
    .toast.warn{background:rgba(245,158,11,.12)}

    /* ==========================================================
       ‚úÖ NAV MENU IN FONDO (come QDP)
       ========================================================== */
    .navCard{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:14px;
    }
    .navCard a{
      color:var(--text);
      text-decoration:none;
      font-weight:800;
    }

    /* ==========================================================
       ‚úÖ LIGHTBOX Instagram-like (zoom/pinch + indicator)
       ========================================================== */
    .lb{ position:fixed; inset:0; z-index:9999; display:none; }
    .lb.open{ display:block; }
    .lb__backdrop{
      position:absolute; inset:0;
      background:rgba(0,0,0,.80);
      backdrop-filter: blur(3px);
    }
    .lb__panel{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:14px;
    }
    .lb__topbar{
      position:absolute;
      top:12px; left:12px; right:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      z-index:2;
      pointer-events:none;
    }
    .lb__badge{
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-weight:900;
      backdrop-filter: blur(6px);
    }
    .lb__actions{
      pointer-events:auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .lb__close, .lb__dl{
      pointer-events:auto;
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:18px;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .lb__nav{
      position:absolute;
      top:50%; transform:translateY(-50%);
      width:46px; height:46px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.35);
      color:#fff;
      font-size:34px;
      line-height:0;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
      z-index:2;
    }
    .lb__prev{ left:12px; }
    .lb__next{ right:12px; }

    .lb__figure{
      margin:0;
      width:min(92vw, 980px);
      height:min(86vh, 760px);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      z-index:1;
    }

    /* area che gestisce pinch/drag */
    .lb__stage{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:#000;
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      touch-action:none;
      position:relative;
    }
    .lb__img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
      transform: translate3d(0,0,0) scale(1);
      transform-origin: 0 0;
      will-change: transform;
      pointer-events:none;
    }
    .lb__cap{
      color:rgba(255,255,255,.90);
      font-weight:800;
      text-align:center;
      max-width:100%;
      word-break:break-word;
      font-size:13px;
      letter-spacing:.2px;
      padding:0 8px;
    }

    @media(max-width:520px){
      .lb__nav{ display:none; }
      .lb__figure{ height:84vh; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <div class="logo">QDP</div>
      <div class="titleWrap">
        <h1 class="title">FOTO</h1>
        <div class="subtitle">Carica una foto ‚Ä¢ aggiorna per vedere le nuove</div>
      </div>
    </div>

    <div class="row">
      <a class="btn ghost" href="index.html">‚¨ÖÔ∏è Home</a>
      <button id="adminBtn" class="btn small warn" type="button">üîê Admin: OFF</button>
      <button id="themeToggle" class="btn small ghost" type="button">üåô</button>
    </div>
  </div>

  <div class="card">
    <div class="muted" style="font-weight:800">Scegli una foto e premi ‚ÄúCarica‚Äù.</div>
    <div class="muted" style="margin-top:6px;font-weight:900">‚ö†Ô∏è Foto o commenti volgari o ingiuriosi verranno eliminati!!!</div>

    <div class="row" style="margin-top:10px">
      <input id="fileInput" class="input" type="file" accept="image/*">
    </div>

    <div class="row" style="margin-top:10px">
      <input id="captionInput" class="input" type="text" maxlength="90" placeholder="Didascalia (facoltativa, max 90 caratteri)">
    </div>

    <div class="row" style="margin-top:10px">
      <button id="uploadBtn" class="btn ok" type="button">‚¨ÜÔ∏è Carica</button>
      <button id="refreshBtn" class="btn ghost" type="button">üîÑ Aggiorna</button>
      <div class="spacer"></div>

      <label class="pill" style="gap:10px">
        üîΩ Ordina:
        <select id="sortSelect" style="width:auto; padding:8px 10px; border-radius:12px">
          <option value="new">Pi√π nuove</option>
          <option value="likes">Pi√π like</option>
        </select>
      </label>

      <div id="countPill" class="pill">üì∏ 0 foto totali</div>
    </div>

    <div id="adminHint" class="pill adminHint" style="display:none; margin-top:10px">
      ‚úÖ Admin attivo (puoi eliminare e modificare didascalie + commenti)
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <div class="card" id="topBox" style="display:none">
    <div class="row">
      <div style="font-weight:900">üèÜ Top foto pi√π piaciute (ultimi 30 giorni)</div>
      <div class="spacer"></div>
      <div class="mini" id="topMini"></div>
    </div>
    <div class="grid" id="topGrid" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:900">üñº Galleria</div>
      <div class="spacer"></div>
      <div class="mini">Suggerimento: fai ‚ÄúAggiorna‚Äù se qualcuno ha caricato ora.</div>
    </div>
    <div class="grid" id="grid" style="margin-top:12px"></div>
  </div>

  <!-- ‚úÖ MENU IN FONDO -->
  <div class="card navCard muted">
    <a href="storico.html">üìö Storico</a>
    <a href="marcatori.html">‚öΩ Marcatori</a>
    <a href="mvp.html">üèÜ Vota MVP</a>
    <a href="foto.html">üì∏ Foto</a>
    <a href="componenti.html">üë• Componenti</a>
    <a href="admin.html">üîê Admin</a>
  </div>

</div>

<!-- ‚úÖ LIGHTBOX -->
<div id="lb" class="lb" aria-hidden="true">
  <div class="lb__backdrop" data-lb-close></div>

  <div class="lb__panel" role="dialog" aria-modal="true" aria-label="Foto">
    <div class="lb__topbar">
      <div id="lbCount" class="lb__badge">1/1</div>

      <!-- ‚úÖ AZIONI TOP (Scarica + Chiudi) -->
      <div class="lb__actions">
        <button id="lbDownload" class="lb__dl" type="button" aria-label="Scarica foto" title="Scarica">‚¨áÔ∏è</button>
        <button class="lb__close" type="button" aria-label="Chiudi" data-lb-close title="Chiudi">‚úï</button>
      </div>
    </div>

    <button class="lb__nav lb__prev" type="button" aria-label="Precedente">‚Äπ</button>

    <figure class="lb__figure">
      <div id="lbStage" class="lb__stage">
        <img id="lbImg" class="lb__img" alt="">
      </div>
      <figcaption id="lbCap" class="lb__cap"></figcaption>
    </figure>

    <button class="lb__nav lb__next" type="button" aria-label="Successiva">‚Ä∫</button>
  </div>
</div>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* THEME */
const themeBtn = document.getElementById("themeToggle");
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

/* SUPABASE */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* DOM */
const adminBtn = document.getElementById("adminBtn");
const adminHint = document.getElementById("adminHint");
const toast = document.getElementById("toast");

const fileInput = document.getElementById("fileInput");
const captionInput = document.getElementById("captionInput");
const uploadBtn = document.getElementById("uploadBtn");
const refreshBtn = document.getElementById("refreshBtn");
const sortSelect = document.getElementById("sortSelect");
const grid = document.getElementById("grid");
const countPill = document.getElementById("countPill");

const topBox = document.getElementById("topBox");
const topGrid = document.getElementById("topGrid");
const topMini = document.getElementById("topMini");

/* üîí FORZA ADMIN HINT NASCOSTO ALL'AVVIO */
adminHint.style.display = "none";

/* HELPERS */
function showToast(msg, type="ok"){
  toast.classList.remove("show","bad","warn");
  if(type==="bad") toast.classList.add("bad");
  if(type==="warn") toast.classList.add("warn");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 2200);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function fmtDate(iso){
  try{
    return new Date(iso).toLocaleString("it-IT", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
  }catch(e){ return String(iso||""); }
}
async function getSession(){
  const { data } = await client.auth.getSession();
  return data?.session || null;
}
function isAdminSession(session){ return !!(session && session.user); }

/* ADMIN UI */
let adminOn = false;
async function refreshAdminUI(){
  const session = await getSession();
  adminOn = (isAdminSession(session) === true);

  adminBtn.textContent = adminOn ? "üîê Admin: ON" : "üîê Admin: OFF";
  adminBtn.classList.toggle("warn", !adminOn);
  adminBtn.classList.toggle("ok", adminOn);

  adminHint.style.display = adminOn ? "inline-flex" : "none";
  return adminOn;
}

adminBtn.onclick = async () => {
  const session = await getSession();
  if(isAdminSession(session)){
    await client.auth.signOut();
    showToast("Admin disattivato.", "warn");
    await refreshAdminUI();
    await loadAll();
    return;
  }
  const email = prompt("Email admin:");
  if(!email) return;
  const password = prompt("Password admin:");
  if(!password) return;

  const { error } = await client.auth.signInWithPassword({ email, password });
  if(error){
    console.error(error);
    showToast("Login fallito.", "bad");
    await refreshAdminUI();
    return;
  }
  showToast("Admin attivo ‚úÖ");
  await refreshAdminUI();
  await loadAll();
};

/* CONFIG */
const BUCKET = "photos";
const TABLE_PHOTOS = "photos";
const TABLE_COMMENTS = "photo_comments";

function getLikedKey(photoId){ return `qdp_liked_${photoId}`; }
function hasLiked(photoId){ return localStorage.getItem(getLikedKey(photoId)) === "1"; }
function markLiked(photoId){ localStorage.setItem(getLikedKey(photoId), "1"); }

function antiSpamOk(){
  const key = "qdp_last_comment_at";
  const last = Number(localStorage.getItem(key) || "0");
  const now = Date.now();
  const waitMs = 20000;
  if(now - last < waitMs) return { ok:false, ms: waitMs - (now-last) };
  localStorage.setItem(key, String(now));
  return { ok:true, ms:0 };
}

/* ‚úÖ Anti doppio tap upload */
let uploading = false;

/* ‚úÖ Top IDs per non duplicare in galleria */
let topIds = new Set();

/* ‚úÖ CONTATORI */
let cachedPhotos = [];
let totalPhotosCount = 0;
let topPhotosCount = 0;

function updateCountPill(){
  const galleryCount = cachedPhotos.length;
  const total = totalPhotosCount;
  const top = topPhotosCount;

  if(total === 0){
    countPill.textContent = `üì∏ 0 foto totali`;
    return;
  }
  countPill.textContent = `üì∏ ${total} foto totali (${galleryCount} in galleria, ${top} in top)`;
}

/* ==========================================================
   ‚úÖ LIGHTBOX (instagram-like)
   - indicator 3/12
   - swipe
   - pinch zoom + doppio tap zoom
   - ‚úÖ scarica foto
   ========================================================== */
const lb = document.getElementById("lb");
const lbImg = document.getElementById("lbImg");
const lbCap = document.getElementById("lbCap");
const lbCount = document.getElementById("lbCount");
const lbStage = document.getElementById("lbStage");
const lbPrev = lb.querySelector(".lb__prev");
const lbNext = lb.querySelector(".lb__next");
const lbDownload = document.getElementById("lbDownload");

let lbList = [];     // [{src, cap}]
let lbIndex = 0;

// zoom state
let scale = 1;
let minScale = 1;
let maxScale = 4;
let tx = 0, ty = 0;

// pointer/pinch
let pointers = new Map();
let pinchStartDist = 0;
let pinchStartScale = 1;
let pinchStartTx = 0, pinchStartTy = 0;
let pinchCenter = {x:0,y:0};

// drag
let dragging = false;
let dragStart = {x:0,y:0, tx:0, ty:0};

// double tap
let lastTapAt = 0;
let lastTapPos = {x:0,y:0};

function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function resetTransform(){
  scale = 1; tx = 0; ty = 0;
  applyTransform();
}
function applyTransform(){
  lbImg.style.transform = `translate3d(${tx}px, ${ty}px, 0) scale(${scale})`;
}

function updateIndicator(){
  lbCount.textContent = `${lbIndex + 1}/${lbList.length}`;
}

function openLightbox(i){
  lbIndex = (i + lbList.length) % lbList.length;
  const item = lbList[lbIndex];

  lbImg.src = item.src;
  lbImg.alt = "foto";
  lbCap.textContent = item.cap || "";

  resetTransform();
  updateIndicator();

  lb.classList.add("open");
  lb.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}

function closeLightbox(){
  lb.classList.remove("open");
  lb.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";
  pointers.clear();
  dragging = false;
  setTimeout(()=> { lbImg.removeAttribute("src"); }, 120);
}

function nextLightbox(){ openLightbox(lbIndex + 1); }
function prevLightbox(){ openLightbox(lbIndex - 1); }

/* ‚úÖ Scarica foto (con fallback se CORS blocca) */
function guessExt(url){
  const clean = (url || "").split("?")[0].toLowerCase();
  if(clean.endsWith(".png")) return "png";
  if(clean.endsWith(".webp")) return "webp";
  if(clean.endsWith(".gif")) return "gif";
  return "jpg";
}
async function downloadCurrentPhoto(){
  try{
    const item = lbList[lbIndex];
    const url = item?.src || "";
    if(!url) return showToast("Link non disponibile.", "bad");

    lbDownload.disabled = true;
    lbDownload.textContent = "‚è≥";

    const ext = guessExt(url);
    const filename = `QDP_foto_${lbIndex+1}.${ext}`;

    // prova download via fetch->blob (pu√≤ fallire per CORS)
    const res = await fetch(url, { mode:"cors", cache:"no-store" });
    if(!res.ok) throw new Error("Fetch failed");
    const blob = await res.blob();

    const a = document.createElement("a");
    const objUrl = URL.createObjectURL(blob);
    a.href = objUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(objUrl);

    showToast("Download avviato ‚úÖ");
  }catch(e){
    console.warn("download fallback:", e);
    // fallback: apri immagine in nuova scheda
    const url = lbList?.[lbIndex]?.src || "";
    if(url) window.open(url, "_blank", "noopener");
    showToast("Apro la foto: salva da l√¨ ‚úÖ", "warn");
  }finally{
    lbDownload.disabled = false;
    lbDownload.textContent = "‚¨áÔ∏è";
  }
}
lbDownload.addEventListener("click", downloadCurrentPhoto);

/* backdrop close */
lb.addEventListener("click", (e)=>{
  if(e.target && e.target.hasAttribute("data-lb-close")) closeLightbox();
});

/* nav */
lbNext.addEventListener("click", nextLightbox);
lbPrev.addEventListener("click", prevLightbox);

/* keyboard */
window.addEventListener("keydown", (e)=>{
  if(!lb.classList.contains("open")) return;
  if(e.key === "Escape") closeLightbox();
  if(e.key === "ArrowRight") nextLightbox();
  if(e.key === "ArrowLeft") prevLightbox();
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s"){
    e.preventDefault();
    downloadCurrentPhoto();
  }
});

/* pointer helpers */
function getPoint(e){ return {x: e.clientX, y: e.clientY}; }
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function mid(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }

function stageRect(){
  return lbStage.getBoundingClientRect();
}
function toStageCoords(pt){
  const r = stageRect();
  return { x: pt.x - r.left, y: pt.y - r.top };
}

function zoomAt(stagePt, targetScale){
  const s = clamp(targetScale, minScale, maxScale);
  const newTx = stagePt.x - (stagePt.x - tx) * (s/scale);
  const newTy = stagePt.y - (stagePt.y - ty) * (s/scale);

  scale = s;
  tx = newTx;
  ty = newTy;

  applyTransform();
}

function onPointerDown(e){
  if(!lb.classList.contains("open")) return;

  lbStage.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId, getPoint(e));

  // doppio tap (solo touch/pen)
  const now = Date.now();
  if(e.pointerType !== "mouse"){
    const p = toStageCoords(getPoint(e));
    if(now - lastTapAt < 260){
      const target = (scale <= 1.05) ? 2.5 : 1;
      zoomAt(p, target);
    }
    lastTapAt = now;
    lastTapPos = p;
  }

  if(pointers.size === 1 && scale > 1){
    dragging = true;
    const p = getPoint(e);
    dragStart = {x:p.x, y:p.y, tx, ty};
  }

  if(pointers.size === 2){
    const pts = [...pointers.values()];
    pinchStartDist = dist(pts[0], pts[1]);
    pinchStartScale = scale;
    pinchStartTx = tx;
    pinchStartTy = ty;
    pinchCenter = toStageCoords(mid(pts[0], pts[1]));
    dragging = false;
  }
}

function onPointerMove(e){
  if(!lb.classList.contains("open")) return;
  if(!pointers.has(e.pointerId)) return;

  pointers.set(e.pointerId, getPoint(e));

  if(pointers.size === 2){
    const pts = [...pointers.values()];
    const d = dist(pts[0], pts[1]);
    if(pinchStartDist <= 0) return;

    const ratio = d / pinchStartDist;
    const targetScale = clamp(pinchStartScale * ratio, minScale, maxScale);

    scale = pinchStartScale;
    tx = pinchStartTx;
    ty = pinchStartTy;
    zoomAt(pinchCenter, targetScale);
    return;
  }

  if(pointers.size === 1 && dragging){
    const p = getPoint(e);
    tx = dragStart.tx + (p.x - dragStart.x);
    ty = dragStart.ty + (p.y - dragStart.y);
    applyTransform();
  }
}

function onPointerUp(e){
  if(!lb.classList.contains("open")) return;

  pointers.delete(e.pointerId);

  if(pointers.size < 2){
    pinchStartDist = 0;
  }
  if(pointers.size === 0){
    dragging = false;
    if(scale < 1.02){
      resetTransform();
    }
  }
}

/* swipe per cambiare foto quando NON zoomato */
let swipeStart = null;
function onSwipeStart(e){
  if(!lb.classList.contains("open")) return;
  if(scale > 1.05) return;
  if(e.pointerType === "mouse") return;
  swipeStart = getPoint(e);
}
function onSwipeEnd(e){
  if(!swipeStart) return;
  const end = getPoint(e);
  const dx = end.x - swipeStart.x;
  const dy = end.y - swipeStart.y;
  swipeStart = null;

  if(Math.abs(dx) > 70 && Math.abs(dx) > Math.abs(dy)){
    if(dx < 0) nextLightbox();
    else prevLightbox();
  }
}

lbStage.addEventListener("pointerdown", (e)=>{ onSwipeStart(e); onPointerDown(e); });
lbStage.addEventListener("pointermove", onPointerMove);
lbStage.addEventListener("pointerup", (e)=>{ onPointerUp(e); onSwipeEnd(e); });
lbStage.addEventListener("pointercancel", onPointerUp);

/* ==========================================================
   APP LOGIC
   ========================================================== */

/* UPLOAD */
uploadBtn.onclick = async () => {
  if(uploading) return;

  try{
    const file = fileInput.files?.[0];
    if(!file){
      showToast("Scegli un file.", "warn");
      return;
    }

    uploading = true;
    uploadBtn.disabled = true;
    uploadBtn.textContent = "‚è≥ Caricamento‚Ä¶";

    const caption = (captionInput.value || "").trim().slice(0,90);

    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const safeExt = ext.replace(/[^a-z0-9]/g,"") || "jpg";
    const filePath = `uploads/${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;

    const { error: upErr } = await client
      .storage
      .from(BUCKET)
      .upload(filePath, file, { cacheControl:"3600", upsert:false, contentType:file.type || "image/jpeg" });
    if(upErr) throw upErr;

    const { data: pub } = client.storage.from(BUCKET).getPublicUrl(filePath);
    const publicUrl = pub?.publicUrl || "";

    const { error: insErr } = await client
      .from(TABLE_PHOTOS)
      .insert([{ file_path: filePath, path: publicUrl, caption, likes: 0 }]);
    if(insErr) throw insErr;

    fileInput.value = "";
    captionInput.value = "";
    showToast("Foto caricata ‚úÖ");
    await loadAll();

  }catch(e){
    console.error(e);
    showToast("Errore upload.", "bad");
  }finally{
    uploading = false;
    uploadBtn.disabled = false;
    uploadBtn.textContent = "‚¨ÜÔ∏è Carica";
  }
};

refreshBtn.onclick = async () => {
  showToast("Aggiorno‚Ä¶");
  await loadAll();
};
sortSelect.onchange = () => loadGallery();

/* LIKE */
async function likePhoto(photo){
  try{
    if(hasLiked(photo.id)){
      showToast("Like gi√† dato ‚úÖ", "warn");
      return;
    }
    const next = Number(photo.likes || 0) + 1;

    const { error } = await client
      .from(TABLE_PHOTOS)
      .update({ likes: next })
      .eq("id", photo.id);

    if(error) throw error;

    markLiked(photo.id);
    showToast("Like üëç");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore like.", "bad");
  }
}

/* DELETE PHOTO (ADMIN) */
async function deletePhoto(photo){
  try{
    const ok = confirm("Vuoi eliminare questa foto?");
    if(!ok) return;

    const { error: delErr } = await client
      .from(TABLE_PHOTOS)
      .delete()
      .eq("id", photo.id);
    if(delErr) throw delErr;

    if(photo.file_path){
      const { error: stErr } = await client.storage.from(BUCKET).remove([photo.file_path]);
      if(stErr) console.warn("Storage remove error:", stErr);
    }

    showToast("Foto eliminata üóëÔ∏è");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore eliminazione.", "bad");
  }
}

/* EDIT CAPTION (ADMIN) */
async function editCaption(photo){
  try{
    const next = prompt("Modifica didascalia (vuota = nessuna):", photo.caption || "");
    if(next === null) return;

    const clean = String(next || "").trim().slice(0,90);
    const { error } = await client
      .from(TABLE_PHOTOS)
      .update({ caption: clean })
      .eq("id", photo.id);
    if(error) throw error;

    showToast("Didascalia aggiornata ‚úÖ");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore didascalia.", "bad");
  }
}

/* SHARE */
async function sharePhoto(photo){
  try{
    const url = photo.path || "";
    if(!url) return showToast("Link non disponibile.", "bad");
    const text = "Guarda questa foto QDP üì∏";

    if(navigator.share){
      await navigator.share({ title:"QDP Foto", text, url });
      return;
    }
    window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, "_blank", "noopener");
  }catch(e){
    console.warn(e);
  }
}
async function copyLink(photo){
  try{
    const url = photo.path || "";
    if(!url) return showToast("Link non disponibile.", "bad");
    await navigator.clipboard.writeText(url);
    showToast("Link copiato ‚úÖ");
  }catch(e){
    console.warn(e);
    showToast("Non riesco a copiare.", "bad");
  }
}

/* COMMENTS */
async function loadComments(photoId){
  const { data, error } = await client
    .from(TABLE_COMMENTS)
    .select("id,photo_id,author,body,created_at")
    .eq("photo_id", photoId)
    .order("created_at", { ascending:true });

  if(error){
    console.warn("comments error", error);
    return [];
  }
  return data || [];
}

async function addComment(photoId, author, body){
  try{
    const a = (author || "").trim().slice(0,24) || "Anonimo";
    const b = (body || "").trim().slice(0,220);
    if(!b) return showToast("Scrivi un commento.", "warn");

    const spam = antiSpamOk();
    if(!spam.ok) return showToast(`Aspetta ${Math.ceil(spam.ms/1000)}s prima di commentare.`, "warn");

    const { error } = await client
      .from(TABLE_COMMENTS)
      .insert([{ photo_id: photoId, author: a, body: b }]);
    if(error) throw error;

    showToast("Commento inviato ‚úÖ");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore commento.", "bad");
  }
}

async function deleteComment(commentId){
  try{
    const ok = confirm("Vuoi eliminare questo commento?");
    if(!ok) return;

    const { error } = await client
      .from(TABLE_COMMENTS)
      .delete()
      .eq("id", commentId);
    if(error) throw error;

    showToast("Commento eliminato üóëÔ∏è");
    await loadAll();
  }catch(e){
    console.error(e);
    showToast("Errore eliminazione commento.", "bad");
  }
}

/* LOAD PHOTOS */
async function loadTop30(){
  try{
    topIds = new Set();
    topPhotosCount = 0;

    const since = new Date(Date.now() - 30*24*3600*1000).toISOString();

    const { data, error } = await client
      .from(TABLE_PHOTOS)
      .select("id,created_at,path,file_path,caption,likes")
      .gte("created_at", since)
      .order("likes", { ascending:false })
      .order("created_at", { ascending:false })
      .limit(6);

    if(error) throw error;

    const rows = data || [];
    topPhotosCount = rows.length;
    rows.forEach(p => topIds.add(String(p.id)));

    if(rows.length === 0){
      topBox.style.display = "none";
      topMini.textContent = "";
      return;
    }
    topBox.style.display = "block";
    topMini.textContent = `Mostro ${rows.length} foto`;

    topGrid.innerHTML = rows.map(p => renderPhotoCard(p, true)).join("");
    await wireCardEvents(topGrid, rows);
  }catch(e){
    console.warn("top30 error", e);
    topIds = new Set();
    topPhotosCount = 0;
    topBox.style.display = "none";
    topMini.textContent = "";
  }
}

async function loadGallery(){
  const sort = sortSelect.value;
  const orderByLikes = (sort === "likes");

  const { data, error } = await client
    .from(TABLE_PHOTOS)
    .select("id,created_at,path,file_path,caption,likes")
    .order(orderByLikes ? "likes" : "created_at", { ascending:false })
    .order("created_at", { ascending:false })
    .limit(60);

  if(error){
    console.error(error);
    grid.innerHTML = `<div class="muted">Errore caricamento foto.</div>`;
    totalPhotosCount = 0;
    cachedPhotos = [];
    updateCountPill();
    return;
  }

  const all = data || [];
  totalPhotosCount = all.length;

  cachedPhotos = all.filter(p => !topIds.has(String(p.id)));

  updateCountPill();

  grid.innerHTML = cachedPhotos.map(p => renderPhotoCard(p, false)).join("");
  await wireCardEvents(grid, cachedPhotos);
}

/* ‚úÖ Costruisce lista lightbox (Top + Gallery) senza duplicati */
function rebuildLightboxList(topRows, galleryRows){
  const map = new Map();
  const push = (p)=>{
    const src = (p?.path || "").trim();
    if(!src) return;
    const id = String(p.id);
    if(map.has(id)) return;
    map.set(id, { src, cap: (p.caption || "").trim() });
  };
  (topRows || []).forEach(push);
  (galleryRows || []).forEach(push);
  lbList = [...map.values()];
}

/* Render */
function renderPhotoCard(photo, isTop){
  const id = escapeHtml(photo.id);
  const likes = Number(photo.likes || 0);
  const liked = hasLiked(photo.id);
  const cap = (photo.caption || "").trim();
  const url = photo.path || "";

  const capHtml = cap
    ? `<div class="cap">${escapeHtml(cap)}</div>`
    : `<div class="cap muted">Nessuna didascalia</div>`;

  const badge = isTop ? `üèÜ TOP` : `‚ù§Ô∏è ${likes}`;
  const likeLabel = liked ? "‚úÖ Like" : "üëç Like";
  const likeDisabled = liked ? "disabled" : "";

  return `
    <div class="photoCard" data-id="${id}" data-src="${escapeHtml(url)}" data-cap="${escapeHtml(cap)}">
      <div class="imgWrap">
        <img src="${escapeHtml(url)}" alt="foto" loading="lazy">
        <div class="imgTopActions">
          <div class="chip">${badge}</div>
          ${adminOn ? `<button class="chip chipBtn js-del" type="button">üóëÔ∏è Elimina</button>` : ``}
        </div>
      </div>

      <div class="pcBody">
        <div class="pcMeta">
          <div class="mini">üïí ${escapeHtml(fmtDate(photo.created_at))}</div>
          <div class="mini">ID: ${id.slice(0,8)}‚Ä¶</div>
        </div>

        ${capHtml}

        <div class="actions">
          <button class="btn small ${liked ? "ghost" : "ok"} js-like" type="button" ${likeDisabled}>${likeLabel} ‚Ä¢ ${likes}</button>
          <button class="btn small ghost js-share" type="button">üì§ Condividi</button>
          <button class="btn small ghost js-copy" type="button">üîó Copia link</button>
          ${adminOn ? `<button class="btn small warn js-editcap" type="button">‚úèÔ∏è Modifica didascalia</button>` : ``}
        </div>

        <div class="divider"></div>

        <div class="commentsTitle">
          <div>üí¨ Commenti</div>
          <div class="mini">max 220 caratteri ‚Ä¢ anti-spam 20s</div>
        </div>

        <div class="row" style="margin-top:10px">
          <input class="input js-author" type="text" maxlength="24" placeholder="Nome (facoltativo)">
        </div>
        <div class="row" style="margin-top:10px">
          <textarea class="input js-body" maxlength="220" placeholder="Scrivi un commento..."></textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn small ghost js-send" type="button">üì® Invia</button>
        </div>

        <div class="js-comments"></div>
      </div>
    </div>
  `;
}

async function wireCardEvents(containerEl, photos){
  const cards = [...containerEl.querySelectorAll(".photoCard")];

  for(const card of cards){
    const id = card.getAttribute("data-id");
    const photo = photos.find(p => String(p.id) === String(id));
    if(!photo) continue;

    // ‚úÖ click immagine -> lightbox
    const img = card.querySelector(".imgWrap img");
    if(img){
      img.style.cursor = "zoom-in";
      img.onclick = ()=>{
        const src = (photo.path || "").trim();
        const i = lbList.findIndex(x => x.src === src);
        if(i >= 0) openLightbox(i);
        else openLightbox(0);
      };
    }

    const likeBtn = card.querySelector(".js-like");
    if(likeBtn) likeBtn.onclick = () => likePhoto(photo);

    const shareBtn = card.querySelector(".js-share");
    if(shareBtn) shareBtn.onclick = () => sharePhoto(photo);

    const copyBtn = card.querySelector(".js-copy");
    if(copyBtn) copyBtn.onclick = () => copyLink(photo);

    const delBtn = card.querySelector(".js-del");
    if(delBtn) delBtn.onclick = () => deletePhoto(photo);

    const editCapBtn = card.querySelector(".js-editcap");
    if(editCapBtn) editCapBtn.onclick = () => editCaption(photo);

    const commentsBox = card.querySelector(".js-comments");
    if(commentsBox){
      commentsBox.innerHTML = `<div class="mini muted" style="margin-top:10px">Carico commenti‚Ä¶</div>`;
      const comments = await loadComments(photo.id);

      commentsBox.innerHTML = (comments.length === 0)
        ? `<div class="mini muted" style="margin-top:10px">Nessun commento.</div>`
        : comments.map(c => `
            <div class="comment">
              <div class="commentHead">
                <div>üë§ ${escapeHtml(c.author || "Anonimo")}</div>
                <div class="row" style="gap:8px">
                  <div class="mini">üïí ${escapeHtml(fmtDate(c.created_at))}</div>
                  ${adminOn ? `<button class="btn small danger js-delc" type="button" data-cid="${escapeHtml(c.id)}">üóë</button>` : ``}
                </div>
              </div>
              <div class="commentBody">${escapeHtml(c.body || "")}</div>
            </div>
          `).join("");

      if(adminOn){
        const delCs = [...commentsBox.querySelectorAll(".js-delc")];
        delCs.forEach(btn=>{
          btn.onclick = () => deleteComment(btn.getAttribute("data-cid"));
        });
      }
    }

    const sendBtn = card.querySelector(".js-send");
    const authorEl = card.querySelector(".js-author");
    const bodyEl = card.querySelector(".js-body");
    if(sendBtn && bodyEl){
      sendBtn.onclick = async () => {
        await addComment(photo.id, authorEl?.value || "", bodyEl.value || "");
      };
    }
  }
}

/* LOAD ALL */
async function loadAll(){
  await refreshAdminUI();

  // carico top
  let topRows = [];
  try{
    topIds = new Set();
    topPhotosCount = 0;

    const since = new Date(Date.now() - 30*24*3600*1000).toISOString();

    const { data, error } = await client
      .from(TABLE_PHOTOS)
      .select("id,created_at,path,file_path,caption,likes")
      .gte("created_at", since)
      .order("likes", { ascending:false })
      .order("created_at", { ascending:false })
      .limit(6);

    if(error) throw error;

    topRows = data || [];
    topPhotosCount = topRows.length;
    topRows.forEach(p => topIds.add(String(p.id)));

    if(topRows.length === 0){
      topBox.style.display = "none";
      topMini.textContent = "";
    }else{
      topBox.style.display = "block";
      topMini.textContent = `Mostro ${topRows.length} foto`;
      topGrid.innerHTML = topRows.map(p => renderPhotoCard(p, true)).join("");
      await wireCardEvents(topGrid, topRows);
    }
  }catch(e){
    console.warn("top30 error", e);
    topRows = [];
    topIds = new Set();
    topPhotosCount = 0;
    topBox.style.display = "none";
    topMini.textContent = "";
  }

  // carico gallery
  const sort = sortSelect.value;
  const orderByLikes = (sort === "likes");
  let galleryRows = [];

  try{
    const { data, error } = await client
      .from(TABLE_PHOTOS)
      .select("id,created_at,path,file_path,caption,likes")
      .order(orderByLikes ? "likes" : "created_at", { ascending:false })
      .order("created_at", { ascending:false })
      .limit(60);

    if(error) throw error;

    const all = data || [];
    totalPhotosCount = all.length;
    galleryRows = all.filter(p => !topIds.has(String(p.id)));
    cachedPhotos = galleryRows;

    grid.innerHTML = cachedPhotos.map(p => renderPhotoCard(p, false)).join("");
    await wireCardEvents(grid, cachedPhotos);
  }catch(e){
    console.error(e);
    grid.innerHTML = `<div class="muted">Errore caricamento foto.</div>`;
    totalPhotosCount = 0;
    cachedPhotos = [];
  }

  // ‚úÖ rebuild lightbox list (top + gallery)
  rebuildLightboxList(topRows, galleryRows);

  updateCountPill();
}

loadAll();
</script>
</body>
</html>
