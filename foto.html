<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Foto ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --btn:#111;
      --ok:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --btn:#0b0e14;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui;
      background:var(--bg);
      color:var(--text);
      transition:.2s;
    }
    .wrap{max-width:980px;margin:auto;padding:16px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:64px;height:64px;border-radius:999px;
      background:linear-gradient(135deg,#111,#333);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:28px;letter-spacing:2px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
      user-select:none;
    }
    .title h1{
      font-family:'Bebas Neue';
      letter-spacing:3px;
      margin:0;
      font-size:54px;
      line-height:1;
    }
    .subtitle{color:var(--muted);font-size:14px;margin-top:4px}

    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn.ok{background:var(--ok)}
    .btn.admin{
      background:rgba(0,0,0,.75);
      color:#fff;
    }
    body.dark .btn.admin{background:#0b0e14}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--pill);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      border:1px solid var(--border);
      color:var(--text);
    }
    .muted{color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .grow{flex:1}

    .formBox{
      padding:14px;
      border:1px solid var(--border);
      border-radius:16px;
      background:rgba(0,0,0,.02);
    }
    body.dark .formBox{background:rgba(255,255,255,.03)}
    .formBox h3{margin:0 0 10px}
    .warnText{
      margin:8px 0 0;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
    }
    .warnText b{color:var(--text)}
    input[type="file"]{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:transparent;
      color:var(--text);
    }
    input[type="text"], textarea, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:transparent;
      color:var(--text);
      font-family:inherit;
      outline:none;
    }
    textarea{min-height:80px;resize:vertical}

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
    }
    @media (min-width:860px){
      .grid{grid-template-columns:repeat(3, minmax(0,1fr))}
    }

    .photoCard{
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
      position:relative;
    }
    .imgWrap{
      width:100%;
      aspect-ratio: 4 / 5;
      background:#0b0e14;
      overflow:hidden;
      cursor:zoom-in;
    }
    .imgWrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .pcBody{padding:12px}
    .pcTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      background:rgba(0,0,0,.06);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      color:var(--text);
    }
    body.dark .tag{background:rgba(255,255,255,.06)}
    .mini{font-size:12px; color:var(--muted); font-weight:800}
    .cap{
      margin-top:8px;
      font-weight:800;
      color:var(--text);
      word-break:break-word;
    }
    .cap.muted{color:var(--muted);font-weight:700}
    .pcBtns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    .likeBtn{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .likeBtn.on{
      border-color: rgba(22,163,74,.4);
      box-shadow:0 0 0 3px rgba(22,163,74,.12);
    }

    .danger{
      background:transparent;
      border:1px solid rgba(239,68,68,.45);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
    }

    .commentBox{
      margin-top:12px;
      border-top:1px solid var(--border);
      padding-top:12px;
    }
    .comment{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px;
      margin-top:8px;
      background:transparent;
    }
    .commentTop{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:900;
    }
    .commentBody{margin-top:6px; color:var(--text); font-weight:700; white-space:pre-wrap}
    .commentDel{
      border:1px solid rgba(239,68,68,.45);
      background:transparent;
      border-radius:12px;
      padding:6px 10px;
      font-weight:900;
      cursor:pointer;
      color:var(--text);
    }

    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .sectionTitle h3{margin:0}

    .toast{
      display:none;
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:rgba(22,163,74,.10);
      font-weight:900;
    }
    .toast.bad{background:rgba(239,68,68,.10)}
    .toast.warn{background:rgba(245,158,11,.10)}
    .toast.show{display:block}

    /* LIGHTBOX */
    .lightbox{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .lightbox.show{display:flex}
    .lbInner{
      width:min(980px, 100%);
      max-height:90vh;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .lbImg{
      background:#000;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    .lbImg img{
      width:100%;
      height:auto;
      max-height:82vh;
      object-fit:contain;
      display:block;
      background:#000;
    }
    .lbBar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:#fff;
      font-weight:900;
    }
    .lbClose{
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
    }

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
      display:flex;align-items:center;justify-content:center;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="logo" title="QDP">QDP</div>
        <div class="title">
          <h1>FOTO</h1>
          <div class="subtitle">Carica una foto ‚Ä¢ aggiorna per vedere le nuove</div>
        </div>
      </div>

      <div class="actions">
        <a class="btn ghost" href="index.html">‚¨ÖÔ∏è Home</a>
        <button id="adminBtn" class="btn admin" type="button">üîê Admin: OFF</button>
      </div>
    </div>

    <div class="card">
      <div class="formBox">
        <h3>Scegli una foto e premi ‚ÄúCarica‚Äù.</h3>
        <div class="warnText">‚ö†Ô∏è <b>Foto o commenti volgari o ingiuriosi verranno eliminati!!!</b></div>

        <div class="row" style="margin-top:12px">
          <div class="grow">
            <input id="fileInput" type="file" accept="image/*">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="grow">
            <input id="captionInput" type="text" maxlength="90" placeholder="Didascalia (facoltativa, max 90 caratteri)">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="uploadBtn" class="btn ok" type="button">‚¨ÜÔ∏è Carica</button>
          <button id="refreshBtn" class="btn ghost" type="button">üîÑ Aggiorna</button>

          <span id="orderPill" class="pill" style="margin-left:auto">
            üß≠ Ordina:
            <select id="orderSelect" style="width:auto; padding:8px 10px; border-radius:12px">
              <option value="new">Pi√π nuove</option>
              <option value="likes">Pi√π like</option>
            </select>
          </span>

          <span id="countPill" class="pill">üì∏ 0 foto</span>
        </div>

        <!-- ADMIN INFO (dentro al riquadro, non fuori) -->
        <div id="adminInfo" class="pill" style="margin-top:12px; display:none;">
          ‚úÖ Admin attivo (puoi eliminare e modificare didascalie + commenti)
        </div>

        <div id="toast" class="toast"></div>
      </div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h3>üèÜ Top foto pi√π piaciute (ultimi 30 giorni)</h3>
        <div class="mini" id="topInfo">Mostro 0 foto</div>
      </div>
      <div id="topGrid" class="grid" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h3>üñº Galleria</h3>
        <div class="mini" id="galInfo">‚Äî</div>
      </div>
      <div id="grid" class="grid" style="margin-top:12px"></div>
    </div>

  </div>

  <button id="themeToggle" class="fab" title="Tema">üåô</button>

  <!-- LIGHTBOX -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <div class="lbInner">
      <div class="lbBar">
        <div id="lbCaption">üì∑ Foto</div>
        <button id="lbClose" class="lbClose" type="button">‚úñ Chiudi</button>
      </div>
      <div class="lbImg">
        <img id="lbImg" src="" alt="Foto">
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
  /* =========================
     IMPOSTAZIONI
  ========================= */
  // Cambia questo PIN come vuoi
  const ADMIN_PIN = "1234";

  const BUCKET = "photos";
  const MAX_FILE_MB = 8;
  const MAX_COMMENTS_PER_10MIN = 5;

  /* =========================
     THEME
  ========================= */
  const themeBtn = document.getElementById("themeToggle");
  function setTheme(mode){
    document.body.classList.toggle("dark", mode === "dark");
    themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("qdp_theme", mode);
  }
  setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
  themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

  /* =========================
     SUPABASE
  ========================= */
  if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
    alert("config.js non caricato o non valido");
    throw new Error("Missing config");
  }
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* =========================
     DOM
  ========================= */
  const fileInput = document.getElementById("fileInput");
  const captionInput = document.getElementById("captionInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const refreshBtn = document.getElementById("refreshBtn");
  const orderSelect = document.getElementById("orderSelect");
  const grid = document.getElementById("grid");
  const topGrid = document.getElementById("topGrid");
  const toast = document.getElementById("toast");
  const countPill = document.getElementById("countPill");
  const topInfo = document.getElementById("topInfo");
  const galInfo = document.getElementById("galInfo");

  const adminBtn = document.getElementById("adminBtn");
  const adminInfo = document.getElementById("adminInfo");

  const lightbox = document.getElementById("lightbox");
  const lbImg = document.getElementById("lbImg");
  const lbClose = document.getElementById("lbClose");
  const lbCaption = document.getElementById("lbCaption");

  /* =========================
     STATO
  ========================= */
  let isAdmin = localStorage.getItem("qdp_admin") === "1";
  let cachedPhotos = [];
  let uploadInProgress = false;

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function showToast(msg, type="ok"){
    toast.className = "toast show" + (type==="bad" ? " bad" : type==="warn" ? " warn" : "");
    toast.textContent = msg;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.classList.remove("show"), 2600);
  }

  function setAdminUI(){
    adminBtn.textContent = isAdmin ? "üîì Admin: ON" : "üîê Admin: OFF";
    adminBtn.classList.toggle("ok", isAdmin);
    adminInfo.style.display = isAdmin ? "inline-flex" : "none";
  }
  setAdminUI();

  adminBtn.onclick = () => {
    if(isAdmin){
      if(confirm("Vuoi uscire da Admin?")){
        isAdmin = false;
        localStorage.setItem("qdp_admin","0");
        setAdminUI();
        renderAll();
      }
      return;
    }
    const pin = prompt("Inserisci PIN Admin:");
    if(pin === ADMIN_PIN){
      isAdmin = true;
      localStorage.setItem("qdp_admin","1");
      setAdminUI();
      renderAll();
      showToast("‚úÖ Admin attivo.", "ok");
    }else{
      showToast("‚ùå PIN errato.", "bad");
    }
  };

  /* =========================
     LIKE (anti doppio like)
  ========================= */
  function likedKey(photoId){ return `qdp_like_${photoId}`; }
  function hasLiked(photoId){ return localStorage.getItem(likedKey(photoId)) === "1"; }
  function setLiked(photoId, v){ localStorage.setItem(likedKey(photoId), v ? "1" : "0"); }

  /* =========================
     COMMENTI (mini anti-spam)
  ========================= */
  function canCommentNow(){
    const key="qdp_comment_log";
    const now=Date.now();
    let arr=[];
    try{ arr=JSON.parse(localStorage.getItem(key)||"[]"); }catch(e){ arr=[]; }
    arr = arr.filter(t => now - t < 10*60*1000);
    if(arr.length >= MAX_COMMENTS_PER_10MIN) return false;
    arr.push(now);
    localStorage.setItem(key, JSON.stringify(arr));
    return true;
  }

  /* =========================
     LIGHTBOX
  ========================= */
  function openLightbox(url, caption){
    lbImg.src = url;
    lbCaption.textContent = caption ? `üì∑ ${caption}` : "üì∑ Foto";
    lightbox.classList.add("show");
    lightbox.setAttribute("aria-hidden","false");
  }
  function closeLightbox(){
    lightbox.classList.remove("show");
    lightbox.setAttribute("aria-hidden","true");
    lbImg.src = "";
  }
  lbClose.onclick = closeLightbox;
  lightbox.addEventListener("click", (e)=>{
    if(e.target === lightbox) closeLightbox();
  });
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") closeLightbox();
  });

  /* =========================
     HELPERS SUPABASE
  ========================= */
  function publicUrl(path){
    return client.storage.from(BUCKET).getPublicUrl(path).data.publicUrl;
  }

  async function loadTopPhotos(all){
    const cutoff = new Date(Date.now() - 30*24*60*60*1000).toISOString();
    const top = (all||[])
      .filter(p => (p.created_at || "") >= cutoff)
      .slice()
      .sort((a,b)=> (b.likes||0)-(a.likes||0) || String(b.created_at||"").localeCompare(String(a.created_at||"")))
      .slice(0,6);

    topInfo.textContent = `Mostro ${top.length} foto`;
    topGrid.innerHTML = top.map(p => photoCardHtml(p, true)).join("");
    wirePhotoCards(topGrid);
    return top.map(p => String(p.id));
  }

  function formatIt(ts){
    try{
      return new Date(ts).toLocaleString("it-IT", {day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
    }catch(e){ return ""; }
  }

  function photoCardHtml(p, isTop=false){
    const url = publicUrl(p.path);
    const liked = hasLiked(p.id);
    const likes = p.likes || 0;
    const cap = (p.caption || "").trim();

    const badgeTop = isTop ? `<span class="tag">üèÜ TOP</span>` : ``;

    const adminBtns = isAdmin ? `
      <button class="danger" data-act="delPhoto" data-id="${escapeHtml(p.id)}" data-path="${escapeHtml(p.path)}">üóë Elimina</button>
      <button class="likeBtn" data-act="editCaption" data-id="${escapeHtml(p.id)}">‚úèÔ∏è Didascalia</button>
    ` : ``;

    return `
      <div class="photoCard" data-photo="${escapeHtml(p.id)}">
        <div class="imgWrap" data-act="open" data-url="${escapeHtml(url)}" data-cap="${escapeHtml(cap)}">
          <img src="${escapeHtml(url)}" alt="Foto">
        </div>
        <div class="pcBody">
          <div class="pcTop">
            ${badgeTop}
            <span class="tag">üïí ${escapeHtml(formatIt(p.created_at))}</span>
          </div>

          <div class="cap ${cap? "" : "muted"}">${cap ? escapeHtml(cap) : "‚Äî Nessuna didascalia ‚Äî"}</div>

          <div class="pcBtns">
            <button class="likeBtn ${liked ? "on":""}" data-act="like" data-id="${escapeHtml(p.id)}">
              üëç Like <span class="tag" style="padding:4px 8px">${likes}</span>
            </button>

            <button class="likeBtn" data-act="share" data-url="${escapeHtml(url)}" data-cap="${escapeHtml(cap)}">üì§ Condividi</button>

            ${adminBtns}
          </div>

          <div class="commentBox">
            <div class="mini" style="font-weight:900">üí¨ Commenti</div>

            <div class="row" style="margin-top:8px">
              <input class="cAuthor" type="text" maxlength="18" placeholder="Nome (facoltativo, max 18)">
              <button class="btn ghost cSend" type="button" data-act="addComment" data-id="${escapeHtml(p.id)}">Invia</button>
            </div>
            <textarea class="cBody" maxlength="160" placeholder="Scrivi un commento (max 160)"></textarea>

            <div class="commentsList" data-list="${escapeHtml(p.id)}" style="margin-top:10px">
              <div class="mini muted">Caricamento commenti‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function wirePhotoCards(container){
    container.querySelectorAll("[data-act]").forEach(el=>{
      el.addEventListener("click", async (e)=>{
        const act = el.dataset.act;

        if(act === "open"){
          openLightbox(el.dataset.url, el.dataset.cap || "");
          return;
        }

        if(act === "like"){
          const id = el.dataset.id;
          if(hasLiked(id)){
            showToast("Hai gi√† messo like ‚úÖ", "warn");
            return;
          }
          setLiked(id, true);

          const { data:row, error } = await client.from("photos").select("likes").eq("id", id).single();
          if(error){
            setLiked(id, false);
            showToast("‚ùå Errore like", "bad");
            return;
          }
          const newLikes = (row?.likes || 0) + 1;
          const { error:upErr } = await client.from("photos").update({ likes:newLikes }).eq("id", id);
          if(upErr){
            setLiked(id, false);
            showToast("‚ùå Errore like", "bad");
            return;
          }
          showToast("üëç Like aggiunto!", "ok");
          await refreshData();
          return;
        }

        if(act === "share"){
          const url = el.dataset.url;
          const cap = (el.dataset.cap || "").trim();
          const text = cap ? `QDP ‚Ä¢ ${cap}` : `QDP ‚Ä¢ Foto`;
          try{
            if(navigator.share){
              await navigator.share({ title:"QDP Foto", text, url });
            }else{
              const wa = `https://wa.me/?text=${encodeURIComponent(text + " " + url)}`;
              window.open(wa, "_blank");
            }
          }catch(err){
            // annullato dall'utente = ok
          }
          return;
        }

        if(act === "delPhoto"){
          if(!isAdmin) return;
          const id = el.dataset.id;
          const path = el.dataset.path;
          if(!confirm("Eliminare questa foto?")) return;

          // 1) cancella DB row
          const { error:delErr, data:delData } = await client.from("photos").delete().eq("id", id).select();
          if(delErr){
            showToast("‚ùå Errore elimina foto (DB)", "bad");
            return;
          }

          // 2) cancella storage file (se c'√®)
          const { error:storErr } = await client.storage.from(BUCKET).remove([path]);
          // se fallisce lo storage non blocchiamo, ma avvisiamo
          if(storErr){
            showToast("‚ö†Ô∏è Foto rimossa dal DB, ma non dallo storage.", "warn");
          }else{
            showToast("üóë Foto eliminata.", "ok");
          }

          // 3) cancella commenti collegati (best effort)
          await client.from("photo_comments").delete().eq("photo_id", id);

          await refreshData();
          return;
        }

        if(act === "editCaption"){
          if(!isAdmin) return;
          const id = el.dataset.id;
          const p = cachedPhotos.find(x => String(x.id) === String(id));
          const oldCap = (p?.caption || "");
          const newCap = prompt("Nuova didascalia (max 90):", oldCap);
          if(newCap === null) return;
          const cap = String(newCap).slice(0,90);
          const { error:upErr } = await client.from("photos").update({ caption:cap }).eq("id", id);
          if(upErr){
            showToast("‚ùå Errore salvataggio didascalia", "bad");
            return;
          }
          showToast("‚úÖ Didascalia aggiornata.", "ok");
          await refreshData();
          return;
        }

        if(act === "addComment"){
          const id = el.dataset.id;
          const card = el.closest(".photoCard");
          const author = (card.querySelector(".cAuthor")?.value || "").trim().slice(0,18);
          const body = (card.querySelector(".cBody")?.value || "").trim().slice(0,160);

          if(!body){
            showToast("Scrivi un commento üôÇ", "warn");
            return;
          }
          if(!canCommentNow()){
            showToast("Troppi commenti in poco tempo. Riprova tra 10 minuti.", "warn");
            return;
          }

          const payload = { photo_id:id, author: author || "Anonimo", body };
          const { error:insErr } = await client.from("photo_comments").insert(payload);
          if(insErr){
            showToast("‚ùå Errore inserimento commento", "bad");
            return;
          }

          card.querySelector(".cBody").value = "";
          showToast("üí¨ Commento aggiunto!", "ok");
          await loadCommentsFor(id, card.querySelector(`[data-list="${CSS.escape(id)}"]`));
          return;
        }

        if(act === "delComment"){
          if(!isAdmin) return;
          const cid = el.dataset.cid;
          if(!confirm("Eliminare questo commento?")) return;
          const { error:delErr } = await client.from("photo_comments").delete().eq("id", cid);
          if(delErr){
            showToast("‚ùå Errore elimina commento", "bad");
            return;
          }
          showToast("üóë Commento eliminato.", "ok");
          const pid = el.dataset.pid;
          const card = container.querySelector(`.photoCard[data-photo="${CSS.escape(pid)}"]`);
          if(card){
            await loadCommentsFor(pid, card.querySelector(`[data-list="${CSS.escape(pid)}"]`));
          }else{
            await refreshData();
          }
          return;
        }
      }, { passive:true });
    });
  }

  async function loadCommentsFor(photoId, listEl){
    if(!listEl) return;
    const { data, error } = await client
      .from("photo_comments")
      .select("id,photo_id,author,body,created_at")
      .eq("photo_id", photoId)
      .order("created_at", { ascending:true });

    if(error){
      listEl.innerHTML = `<div class="mini muted">Errore commenti</div>`;
      return;
    }

    if(!data || data.length === 0){
      listEl.innerHTML = `<div class="mini muted">Nessun commento.</div>`;
      return;
    }

    listEl.innerHTML = data.map(c => `
      <div class="comment">
        <div class="commentTop">
          <div>${escapeHtml(c.author || "Anonimo")} <span class="mini">‚Ä¢ ${escapeHtml(formatIt(c.created_at))}</span></div>
          ${isAdmin ? `<button class="commentDel" type="button" data-act="delComment" data-cid="${escapeHtml(c.id)}" data-pid="${escapeHtml(photoId)}">üóë</button>` : ``}
        </div>
        <div class="commentBody">${escapeHtml(c.body)}</div>
      </div>
    `).join("");

    wirePhotoCards(listEl); // per i pulsanti delete comment
  }

  function renderAll(){
    // render top + gallery gi√† in cachedPhotos
    // topPhotosIds = ids mostrati in top, cos√¨ possiamo toglierli dalla galleria (come prima)
    // MA il contatore deve essere il TOTALE, quindi useremo cachedPhotos.length totale.
  }

  async function refreshData(){
    // 1) carica tutte le foto
    const { data:all, error } = await client
      .from("photos")
      .select("id,created_at,path,caption,file_path,likes")
      .order("created_at", { ascending:false });

    if(error){
      showToast("‚ùå Errore caricamento foto", "bad");
      return;
    }

    cachedPhotos = all || [];

    // ‚úÖ CONTATORE = TOTALE FOTO (come richiesto)
    countPill.textContent = `üì∏ ${cachedPhotos.length} foto`;

    // 2) TOP
    const topIds = await loadTopPhotos(cachedPhotos);

    // 3) GALLERIA: escludi quelle del TOP
    let gal = cachedPhotos.filter(p => !topIds.includes(String(p.id)));

    // Ordina
    if(orderSelect.value === "likes"){
      gal = gal.slice().sort((a,b)=> (b.likes||0)-(a.likes||0) || String(b.created_at||"").localeCompare(String(a.created_at||"")));
    }else{
      gal = gal.slice().sort((a,b)=> String(b.created_at||"").localeCompare(String(a.created_at||"")));
    }

    galInfo.textContent = gal.length ? `Mostro ${gal.length} foto in galleria (Top escluso)` : `Nessuna foto in galleria (tutte nel Top)`;

    grid.innerHTML = gal.map(p => photoCardHtml(p, false)).join("");
    wirePhotoCards(grid);

    // 4) carica commenti per ogni card (top + gallery)
    // TOP
    topGrid.querySelectorAll(".photoCard").forEach(card=>{
      const pid = card.dataset.photo;
      const listEl = card.querySelector(`[data-list="${CSS.escape(pid)}"]`);
      loadCommentsFor(pid, listEl);
    });
    // GALLERY
    grid.querySelectorAll(".photoCard").forEach(card=>{
      const pid = card.dataset.photo;
      const listEl = card.querySelector(`[data-list="${CSS.escape(pid)}"]`);
      loadCommentsFor(pid, listEl);
    });
  }

  /* =========================
     UPLOAD (evita doppio caricamento)
  ========================= */
  uploadBtn.onclick = async () => {
    if(uploadInProgress) return; // blocca doppio click
    const file = fileInput.files?.[0];
    if(!file){
      showToast("Scegli un file prima di caricare.", "warn");
      return;
    }

    const sizeMb = file.size / (1024*1024);
    if(sizeMb > MAX_FILE_MB){
      showToast(`File troppo grande (max ${MAX_FILE_MB}MB).`, "warn");
      return;
    }

    uploadInProgress = true;
    uploadBtn.disabled = true;
    refreshBtn.disabled = true;

    try{
      // nome unico
      const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
      const safeExt = ext.replace(/[^a-z0-9]/g,"").slice(0,6) || "jpg";
      const name = `qdp_${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;
      const path = `uploads/${name}`;

      // upload storage
      const { error:upErr } = await client.storage.from(BUCKET).upload(path, file, {
        cacheControl: "3600",
        upsert: false,
        contentType: file.type || "image/jpeg"
      });
      if(upErr){
        showToast("‚ùå Errore upload storage", "bad");
        return;
      }

      // inserisci riga in DB
      const cap = String(captionInput.value || "").trim().slice(0,90);
      const payload = { path, file_path: path, caption: cap || null, likes: 0 };

      const { error:insErr } = await client.from("photos").insert(payload);
      if(insErr){
        // rollback file nello storage
        await client.storage.from(BUCKET).remove([path]);
        showToast("‚ùå Errore salvataggio DB", "bad");
        return;
      }

      // reset campi
      fileInput.value = "";
      captionInput.value = "";

      showToast("‚úÖ Foto caricata!", "ok");
      await refreshData();

    }finally{
      uploadInProgress = false;
      uploadBtn.disabled = false;
      refreshBtn.disabled = false;
    }
  };

  refreshBtn.onclick = () => refreshData();
  orderSelect.onchange = () => refreshData();

  // avvio
  refreshData();
  </script>
</body>
</html>
