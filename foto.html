<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Foto ‚Ä¢ Quelli della pensione</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --pill:#eeeeee;
      --btn:#111;
      --danger:#ef4444;
      --ok:#22c55e;
    }
    body.dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e5e7eb;
      --muted:#a1a1aa;
      --border:#2a2f3a;
      --shadow:0 10px 28px rgba(0,0,0,.45);
      --pill:#222631;
      --btn:#0b0e14;
      --danger:#f87171;
      --ok:#4ade80;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui;
      background:var(--bg);
      color:var(--text);
      transition:.2s;
    }
    .wrap{max-width:980px;margin:auto;padding:16px}

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:56px;height:56px;border-radius:999px;
      background:linear-gradient(135deg,#0b0e14,#2a3242);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-family:'Bebas Neue';font-size:26px;
      letter-spacing:2px;
      box-shadow:var(--shadow);
    }
    h1{
      margin:0;
      font-family:'Bebas Neue';
      letter-spacing:2px;
      font-size:44px;
      line-height:1;
    }
    .subtitle{color:var(--muted);font-weight:700}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin:12px 0;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .btn{
      border:0;
      background:var(--btn);
      color:#fff;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn.danger{
      background:var(--danger);
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:var(--pill);
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
    }
    .pill.ok{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); }
    .pill.warn{ background:rgba(245,158,11,.14); border-color:rgba(245,158,11,.35); }
    .muted{color:var(--muted)}

    .form{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    .input, .file{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      background:transparent;
      color:var(--text);
      font-weight:800;
    }
    .hint{
      color:var(--muted);
      font-weight:700;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media(max-width:760px){
      .grid{ grid-template-columns: 1fr; }
    }

    .photoCard{
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      background:var(--card);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .photoCard img{
      width:100%;
      display:block;
      aspect-ratio: 4 / 5;
      object-fit:cover;
      background:#00000010;
    }
    .photoBody{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-weight:900;
    }
    .caption{
      font-weight:800;
      color:var(--text);
      line-height:1.25;
    }
    .caption.empty{
      color:var(--muted);
      font-weight:700;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .likeBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .likeBtn.liked{
      background:rgba(236,72,153,.12);
      border-color:rgba(236,72,153,.35);
    }

    .fab{
      position:fixed;
      right:16px;bottom:16px;
      width:54px;height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
    }

    .banner{
      margin-top:10px;
      border-radius:16px;
      padding:12px 14px;
      border:1px solid var(--border);
      background:rgba(34,197,94,.10);
      font-weight:900;
      display:none;
    }
    .banner.show{display:block}
    .banner.err{
      background:rgba(239,68,68,.10);
      border-color:rgba(239,68,68,.25);
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brand">
      <div class="logo">QDP</div>
      <div>
        <h1>FOTO</h1>
        <div class="subtitle">Carica una foto ‚Ä¢ aggiorna per vedere le nuove</div>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end; gap:10px;">
      <a class="btn ghost" href="index.html">‚¨Ö Home</a>
      <button id="adminBtn" class="btn ghost" type="button">üîê Admin: OFF</button>
    </div>
  </div>

  <div class="card">
    <div class="hint">Scegli una foto, aggiungi una didascalia (facoltativa) e premi ‚ÄúCarica‚Äù.</div>

    <div class="form">
      <input id="fileInput" class="file" type="file" accept="image/*" />
      <input id="captionInput" class="input" type="text" maxlength="140" placeholder="Didascalia (es. 'Gioved√¨ sera üî•')">
      <div class="row" style="justify-content:flex-start; gap:10px;">
        <button id="uploadBtn" class="btn" type="button">‚¨Ü Carica</button>
        <button id="refreshBtn" class="btn ghost" type="button">üîÑ Aggiorna</button>
        <span id="adminPill" class="pill warn" style="display:none;">‚úÖ Admin attivo (puoi eliminare)</span>
        <span id="countPill" class="pill" style="margin-left:auto;">üì∑ 0 foto</span>
      </div>
    </div>

    <div id="banner" class="banner"></div>
  </div>

  <div class="card">
    <div id="grid" class="grid"></div>
  </div>

</div>

<button id="themeToggle" class="fab">üåô</button>

<script src="config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* THEME */
const themeBtn = document.getElementById("themeToggle");
function setTheme(mode){
  document.body.classList.toggle("dark", mode === "dark");
  themeBtn.textContent = (mode === "dark") ? "‚òÄÔ∏è" : "üåô";
  localStorage.setItem("qdp_theme", mode);
}
setTheme(localStorage.getItem("qdp_theme") === "dark" ? "dark" : "light");
themeBtn.onclick = () => setTheme(document.body.classList.contains("dark") ? "light" : "dark");

/* SUPABASE */
if(!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){
  alert("config.js non caricato o non valido");
  throw new Error("Missing config");
}
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* DOM */
const fileInput = document.getElementById("fileInput");
const captionInput = document.getElementById("captionInput");
const uploadBtn = document.getElementById("uploadBtn");
const refreshBtn = document.getElementById("refreshBtn");
const grid = document.getElementById("grid");
const banner = document.getElementById("banner");
const adminBtn = document.getElementById("adminBtn");
const adminPill = document.getElementById("adminPill");
const countPill = document.getElementById("countPill");

/* CONFIG */
const BUCKET = "photos";
const TABLE = "photos";

/* Admin (login supabase) */
let isAdmin = false;
function setAdminUI(){
  adminBtn.textContent = isAdmin ? "üîê Admin: ON" : "üîê Admin: OFF";
  adminBtn.classList.toggle("btn", isAdmin);
  adminBtn.classList.toggle("ghost", !isAdmin);
  adminPill.style.display = isAdmin ? "inline-flex" : "none";
}
setAdminUI();

/* Banner */
function showBanner(msg, isError=false){
  banner.textContent = msg;
  banner.classList.toggle("err", !!isError);
  banner.classList.add("show");
  clearTimeout(showBanner._t);
  showBanner._t = setTimeout(()=> banner.classList.remove("show"), 2600);
}

/* Utils */
function formatDT(iso){
  try{
    return new Date(iso).toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
  }catch(e){
    return String(iso||"");
  }
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* Local likes (anti-spam sullo stesso telefono) */
const LIKES_KEY = "qdp_liked_photos";
function getLikedSet(){
  try{
    const arr = JSON.parse(localStorage.getItem(LIKES_KEY) || "[]");
    return new Set(arr.map(String));
  }catch(e){
    return new Set();
  }
}
function addLiked(id){
  const set = getLikedSet();
  set.add(String(id));
  localStorage.setItem(LIKES_KEY, JSON.stringify([...set]));
}

/* Get public url */
function publicUrlFor(path){
  const { data } = client.storage.from(BUCKET).getPublicUrl(path);
  return data?.publicUrl || "";
}

/* Load photos (ORDINATE: pi√π nuove prima) */
async function loadPhotos(){
  grid.innerHTML = `<div class="muted">Caricamento‚Ä¶</div>`;

  const { data, error } = await client
    .from(TABLE)
    .select("id, created_at, path, caption, likes")
    .order("created_at", { ascending:false });

  if(error){
    grid.innerHTML = `<div class="muted">‚ùå Errore: ${escapeHtml(error.message)}</div>`;
    return;
  }

  const photos = data || [];
  countPill.textContent = `üì∑ ${photos.length} foto`;

  if(photos.length === 0){
    grid.innerHTML = `<div class="muted">Nessuna foto caricata.</div>`;
    return;
  }

  const liked = getLikedSet();

  grid.innerHTML = photos.map(p=>{
    const url = publicUrlFor(p.path);
    const cap = (p.caption || "").trim();
    const likes = Number(p.likes ?? 0);
    const isLiked = liked.has(String(p.id));
    return `
      <div class="photoCard" data-id="${escapeHtml(p.id)}" data-path="${escapeHtml(p.path)}" data-likes="${likes}">
        <img src="${escapeHtml(url)}" alt="Foto">
        <div class="photoBody">
          <div class="meta">
            <div class="muted">üïí ${escapeHtml(formatDT(p.created_at))}</div>
            <div class="pill">‚ù§Ô∏è <span class="likeCount">${likes}</span></div>
          </div>

          <div class="caption ${cap ? "" : "empty"}">
            ${cap ? escapeHtml(cap) : "Nessuna didascalia."}
          </div>

          <div class="actions">
            <button class="likeBtn ${isLiked ? "liked" : ""}" type="button" data-action="like">
              ${isLiked ? "‚ù§Ô∏è Ti piace" : "ü§ç Metti like"}
            </button>

            ${isAdmin ? `
              <button class="btn danger" type="button" data-action="delete">üóë Elimina</button>
            ` : `
              <span class="muted" style="font-weight:800">ID: ${escapeHtml(p.id)}</span>
            `}
          </div>
        </div>
      </div>
    `;
  }).join("");
}

/* Upload */
async function uploadPhoto(){
  const file = fileInput.files?.[0];
  if(!file){
    showBanner("‚ö†Ô∏è Seleziona una foto prima di caricare.", true);
    return;
  }

  uploadBtn.disabled = true;

  try{
    // nome file unico
    const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
    const safeExt = ext.replace(/[^a-z0-9]/g,"") || "jpg";
    const filename = `${Date.now()}_${Math.random().toString(16).slice(2)}.${safeExt}`;

    // upload su storage
    const { error: upErr } = await client.storage
      .from(BUCKET)
      .upload(filename, file, { upsert: false, contentType: file.type || "image/jpeg" });

    if(upErr) throw upErr;

    // insert riga tabella con caption + likes
    const caption = (captionInput.value || "").trim();
    const { error: insErr } = await client
      .from(TABLE)
      .insert([{ path: filename, caption, likes: 0 }]);

    if(insErr) throw insErr;

    // reset
    fileInput.value = "";
    captionInput.value = "";
    showBanner("‚úÖ Foto caricata!");
    await loadPhotos();

  }catch(e){
    console.error(e);
    showBanner(`‚ùå Errore caricamento: ${e?.message || e}`, true);
  }finally{
    uploadBtn.disabled = false;
  }
}

/* Like (con blocco su stesso telefono) */
async function likePhoto(card){
  const id = card.getAttribute("data-id");
  if(!id) return;

  const liked = getLikedSet();
  if(liked.has(String(id))){
    showBanner("‚úÖ Like gi√† messo da questo telefono.");
    return;
  }

  // valore attuale dalla UI
  const currentLikes = Number(card.getAttribute("data-likes") || 0);
  const nextLikes = currentLikes + 1;

  // disabilita bottone durante update
  const btn = card.querySelector('[data-action="like"]');
  if(btn) btn.disabled = true;

  try{
    const { error } = await client
      .from(TABLE)
      .update({ likes: nextLikes })
      .eq("id", id);

    if(error) throw error;

    // aggiorna UI
    card.setAttribute("data-likes", String(nextLikes));
    const likeCount = card.querySelector(".likeCount");
    if(likeCount) likeCount.textContent = String(nextLikes);

    if(btn){
      btn.classList.add("liked");
      btn.textContent = "‚ù§Ô∏è Ti piace";
      btn.disabled = false;
    }

    addLiked(id);
    showBanner("‚ù§Ô∏è Like aggiunto!");

  }catch(e){
    console.error(e);
    showBanner(`‚ùå Errore like: ${e?.message || e}`, true);
    if(btn) btn.disabled = false;
  }
}

/* Delete (admin) */
async function deletePhoto(card){
  if(!isAdmin){
    showBanner("‚ö†Ô∏è Solo admin pu√≤ eliminare.", true);
    return;
  }

  const id = card.getAttribute("data-id");
  const path = card.getAttribute("data-path");
  if(!id || !path) return;

  const ok = confirm("Vuoi eliminare questa foto?");
  if(!ok) return;

  const delBtn = card.querySelector('[data-action="delete"]');
  if(delBtn) delBtn.disabled = true;

  try{
    // 1) elimina riga tabella
    const { error: dbErr } = await client.from(TABLE).delete().eq("id", id);
    if(dbErr) throw dbErr;

    // 2) elimina file su storage (se policy ok)
    const { error: stErr } = await client.storage.from(BUCKET).remove([path]);
    if(stErr) throw stErr;

    showBanner("üóë Foto eliminata!");
    await loadPhotos();

  }catch(e){
    console.error(e);
    showBanner(`‚ùå Errore elimina: ${e?.message || e}`, true);
    if(delBtn) delBtn.disabled = false;
  }
}

/* Click handler su grid */
grid.addEventListener("click", async (ev)=>{
  const btn = ev.target.closest("button");
  if(!btn) return;

  const card = ev.target.closest(".photoCard");
  if(!card) return;

  const action = btn.getAttribute("data-action");
  if(action === "like") await likePhoto(card);
  if(action === "delete") await deletePhoto(card);
});

/* Admin login/logout */
adminBtn.addEventListener("click", async ()=>{
  if(isAdmin){
    // logout
    await client.auth.signOut();
    isAdmin = false;
    setAdminUI();
    showBanner("üîì Admin disattivato.");
    await loadPhotos();
    return;
  }

  // login semplice via prompt (email+password)
  const email = prompt("Email admin Supabase:");
  if(!email) return;
  const password = prompt("Password admin:");
  if(!password) return;

  const { data, error } = await client.auth.signInWithPassword({ email, password });
  if(error){
    showBanner("‚ùå Login fallito.", true);
    return;
  }

  isAdmin = !!data?.session;
  setAdminUI();
  showBanner("‚úÖ Admin attivo!");
  await loadPhotos();
});

/* Buttons */
uploadBtn.addEventListener("click", uploadPhoto);
refreshBtn.addEventListener("click", loadPhotos);

/* Init: se gi√† loggato */
(async function init(){
  const { data } = await client.auth.getSession();
  isAdmin = !!data?.session;
  setAdminUI();
  await loadPhotos();
})();
</script>
</body>
</html>
